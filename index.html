<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Retirement Withdrawal Simulator</title>
    <meta name="description" content="Monte Carlo retirement withdrawal simulator comparing different withdrawal strategies">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ApexCharts - Interactive animated charts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.44.0/dist/apexcharts.min.js"></script>

    <!-- CountUp.js - Animated number counting -->
    <script src="https://cdn.jsdelivr.net/npm/countup.js@2.8.0/dist/countUp.umd.min.js"></script>

    <!-- Tippy.js - Accessible animated tooltips -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/shift-away.css"/>

    <!-- noUiSlider - Beautiful range sliders -->
    <link href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>

    <!-- Tailwind Custom Configuration - Apple Design System -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // Apple Dark Mode Color Palette
                        apple: {
                            bg: '#000000',
                            surface: '#1c1c1e',
                            elevated: '#2c2c2e',
                            tertiary: '#3a3a3c',
                            separator: '#38383a',
                            blue: '#0a84ff',
                            green: '#30d158',
                            red: '#ff453a',
                            orange: '#ff9f0a',
                            yellow: '#ffd60a',
                            purple: '#bf5af2',
                            pink: '#ff375f',
                            teal: '#64d2ff',
                            text: '#ffffff',
                            textSecondary: '#98989d',
                            textTertiary: '#636366',
                        }
                    },
                    fontFamily: {
                        'system': ['-apple-system', 'BlinkMacSystemFont', 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', 'Helvetica', 'Arial', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1)',
                        'fade-in-up': 'fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1)',
                        'fade-in-down': 'fadeInDown 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
                        'scale-in': 'scaleIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
                        'slide-down': 'slideDown 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
                        'spring': 'spring 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)',
                        'pulse-soft': 'pulseSoft 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'shimmer': 'shimmer 2s linear infinite',
                        'bounce-subtle': 'bounceSubtle 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        fadeInDown: {
                            '0%': { opacity: '0', transform: 'translateY(-10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        scaleIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        slideDown: {
                            '0%': { transform: 'translateY(-100%)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        spring: {
                            '0%': { transform: 'scale(0.9)', opacity: '0' },
                            '50%': { transform: 'scale(1.02)' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        pulseSoft: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.7' },
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-200% 0' },
                            '100%': { backgroundPosition: '200% 0' },
                        },
                        bounceSubtle: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-4px)' },
                        },
                        glow: {
                            '0%': { boxShadow: '0 0 5px rgba(10, 132, 255, 0.3)' },
                            '100%': { boxShadow: '0 0 20px rgba(10, 132, 255, 0.6)' },
                        },
                    },
                    boxShadow: {
                        'apple': '0 0 0 0.5px rgba(0,0,0,0.2), 0 2px 8px rgba(0,0,0,0.15)',
                        'apple-lg': '0 0 0 0.5px rgba(0,0,0,0.2), 0 8px 32px rgba(0,0,0,0.25)',
                        'apple-glow': '0 0 30px rgba(10, 132, 255, 0.4)',
                        'inner-glow': 'inset 0 1px 0 0 rgba(255,255,255,0.05)',
                    },
                    backdropBlur: {
                        'apple': '20px',
                    },
                    borderRadius: {
                        'apple': '12px',
                        'apple-lg': '16px',
                        'apple-xl': '22px',
                    },
                }
            }
        }
    </script>

    <style>
        /* ============================================
           APPLE DESIGN SYSTEM - NATIVE DARK THEME
           Premium iOS-inspired interface with smooth
           animations and glassmorphism effects
           ============================================ */

        /* CSS Custom Properties */
        :root {
            --apple-bg: #000000;
            --apple-surface: #1c1c1e;
            --apple-elevated: #2c2c2e;
            --apple-tertiary: #3a3a3c;
            --apple-separator: #38383a;
            --apple-blue: #0a84ff;
            --apple-green: #30d158;
            --apple-red: #ff453a;
            --apple-orange: #ff9f0a;
            --apple-yellow: #ffd60a;
            --apple-purple: #bf5af2;
            --apple-pink: #ff375f;
            --apple-teal: #64d2ff;
            --apple-text: #ffffff;
            --apple-text-secondary: #98989d;
            --apple-text-tertiary: #636366;
            --spring-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
            --spring-smooth: cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Base Typography */
        html {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        body {
            background: var(--apple-bg);
            color: var(--apple-text);
            min-height: 100vh;
            min-height: 100dvh;
        }

        /* WCAG 2.2 - Skip Navigation */
        .skip-link {
            position: absolute;
            top: -50px;
            left: 16px;
            background: var(--apple-blue);
            color: white;
            padding: 12px 20px;
            z-index: 10000;
            transition: top 0.3s var(--spring-smooth);
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
        }

        .skip-link:focus {
            top: 16px;
        }

        /* ============================================
           APPLE SPRING ANIMATIONS
           ============================================ */
        @keyframes appleSlideUp {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(0.97);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes appleFadeIn {
            0% { opacity: 0; transform: scale(0.98); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes appleSpring {
            0% { transform: scale(0.9); opacity: 0; }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes applePulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(0.98); }
        }

        @keyframes appleGlow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(10, 132, 255, 0.3),
                            inset 0 1px 0 rgba(255,255,255,0.1);
            }
            50% {
                box-shadow: 0 0 40px rgba(10, 132, 255, 0.5),
                            inset 0 1px 0 rgba(255,255,255,0.15);
            }
        }

        @keyframes shimmerWave {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes ringPulse {
            0%, 100% { filter: drop-shadow(0 0 4px currentColor); }
            50% { filter: drop-shadow(0 0 12px currentColor); }
        }

        @keyframes successCelebrate {
            0% { transform: scale(1); }
            25% { transform: scale(1.05) rotate(-2deg); }
            50% { transform: scale(1.1) rotate(2deg); }
            75% { transform: scale(1.05) rotate(-1deg); }
            100% { transform: scale(1) rotate(0); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }

        @keyframes progressFill {
            from { width: 0; transform: scaleX(0); transform-origin: left; }
            to { transform: scaleX(1); }
        }

        /* Staggered entrance animations */
        .stagger-item {
            opacity: 0;
            animation: appleSlideUp 0.6s var(--spring-smooth) forwards;
        }
        .stagger-item:nth-child(1) { animation-delay: 0.05s; }
        .stagger-item:nth-child(2) { animation-delay: 0.1s; }
        .stagger-item:nth-child(3) { animation-delay: 0.15s; }
        .stagger-item:nth-child(4) { animation-delay: 0.2s; }
        .stagger-item:nth-child(5) { animation-delay: 0.25s; }
        .stagger-item:nth-child(6) { animation-delay: 0.3s; }
        .stagger-item:nth-child(7) { animation-delay: 0.35s; }
        .stagger-item:nth-child(8) { animation-delay: 0.4s; }

        .animate-fade-in { animation: appleFadeIn 0.5s var(--spring-smooth); }
        .animate-spring { animation: appleSpring 0.6s var(--spring-bounce); }
        .animate-pulse-soft { animation: applePulse 2s ease-in-out infinite; }
        .animate-glow { animation: appleGlow 2s ease-in-out infinite; }
        .ring-pulse { animation: ringPulse 2s ease-in-out infinite; }
        .celebrate { animation: successCelebrate 0.6s var(--spring-bounce); }
        .float-animation { animation: float 3s ease-in-out infinite; }

        /* ============================================
           APPLE GLASSMORPHISM CARDS
           ============================================ */
        .glass-card {
            background: rgba(28, 28, 30, 0.8);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .glass-card-elevated {
            background: rgba(44, 44, 46, 0.9);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.08);
        }

        /* Hover effects */
        .hover-lift {
            transition: transform 0.4s var(--spring-bounce),
                        box-shadow 0.4s ease,
                        border-color 0.3s ease;
        }

        .hover-lift:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .hover-lift:active {
            transform: translateY(-2px) scale(0.99);
        }

        /* ============================================
           APPLE-STYLE FORM INPUTS
           ============================================ */
        input[type="text"],
        input[type="number"],
        select {
            background: var(--apple-elevated) !important;
            border: 1px solid var(--apple-tertiary) !important;
            border-radius: 10px !important;
            color: var(--apple-text) !important;
            font-size: 16px;
            padding: 12px 16px !important;
            transition: all 0.3s var(--spring-smooth);
            -webkit-appearance: none;
            appearance: none;
            min-height: 44px; /* iOS touch target */
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: var(--apple-blue) !important;
            box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.3),
                        inset 0 1px 0 rgba(255,255,255,0.05) !important;
            outline: none !important;
        }

        input::placeholder {
            color: var(--apple-text-tertiary);
        }

        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2398989d' d='M6 8L1 3h10z'/%3E%3C/svg%3E") !important;
            background-repeat: no-repeat !important;
            background-position: right 12px center !important;
            padding-right: 36px !important;
        }

        /* Hide number spinners */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] { -moz-appearance: textfield; }

        /* Labels */
        label {
            color: var(--apple-text) !important;
            font-weight: 500;
            font-size: 14px;
        }

        /* ============================================
           APPLE-STYLE BUTTONS
           ============================================ */
        .btn-apple {
            background: var(--apple-blue);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 28px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s var(--spring-bounce);
            min-height: 50px;
            position: relative;
            overflow: hidden;
        }

        .btn-apple::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0.15) 0%, transparent 50%);
            border-radius: 12px;
        }

        .btn-apple:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 30px rgba(10, 132, 255, 0.4);
        }

        .btn-apple:active {
            transform: scale(0.98);
        }

        .btn-apple-secondary {
            background: var(--apple-elevated);
            color: var(--apple-blue);
            border: 1px solid var(--apple-tertiary);
        }

        .btn-apple-secondary:hover {
            background: var(--apple-tertiary);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        /* ============================================
           iOS-STYLE TAB BAR
           ============================================ */
        .tab-button {
            background: transparent;
            color: var(--apple-text-secondary);
            border: none;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s var(--spring-smooth);
            position: relative;
            border-radius: 10px;
            min-height: 44px;
        }

        .tab-button::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background: var(--apple-blue);
            border-radius: 3px;
            transform: translateX(-50%);
            transition: width 0.3s var(--spring-bounce);
        }

        .tab-button:hover {
            color: var(--apple-text);
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-button[aria-selected="true"],
        .tab-button.active {
            color: var(--apple-blue);
            background: rgba(10, 132, 255, 0.1);
        }

        .tab-button[aria-selected="true"]::after,
        .tab-button.active::after {
            width: 24px;
        }

        .tab-content {
            transition: opacity 0.4s ease, transform 0.4s var(--spring-smooth);
        }

        .tab-content.hidden {
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
        }

        /* ============================================
           APPLE-STYLE CHECKBOXES
           ============================================ */
        input[type="checkbox"] {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border: 2px solid var(--apple-tertiary);
            border-radius: 6px;
            background: var(--apple-elevated);
            cursor: pointer;
            transition: all 0.2s var(--spring-bounce);
            position: relative;
        }

        input[type="checkbox"]:checked {
            background: var(--apple-blue);
            border-color: var(--apple-blue);
        }

        input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            left: 6px;
            top: 2px;
            width: 6px;
            height: 12px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        input[type="checkbox"]:focus {
            box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.3);
        }

        /* ============================================
           STATUS COLORS & GLOW EFFECTS
           ============================================ */
        .status-success {
            color: var(--apple-green);
        }

        .status-warning {
            color: var(--apple-orange);
        }

        .status-danger {
            color: var(--apple-red);
        }

        .glow-success {
            box-shadow: 0 0 30px rgba(48, 209, 88, 0.4),
                        inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .glow-warning {
            box-shadow: 0 0 30px rgba(255, 159, 10, 0.4),
                        inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .glow-danger {
            box-shadow: 0 0 30px rgba(255, 69, 58, 0.4),
                        inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .glow-primary {
            box-shadow: 0 0 30px rgba(10, 132, 255, 0.4),
                        inset 0 1px 0 rgba(255,255,255,0.1);
        }

        /* ============================================
           TOOLTIPS - APPLE STYLE
           ============================================ */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 260px;
            background: var(--apple-elevated);
            color: var(--apple-text);
            text-align: left;
            border-radius: 12px;
            padding: 14px 16px;
            position: absolute;
            z-index: 1000;
            bottom: 130%;
            left: 50%;
            margin-left: -130px;
            opacity: 0;
            transform: translateY(10px) scale(0.95);
            transition: all 0.3s var(--spring-bounce);
            font-size: 13px;
            line-height: 1.5;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--apple-separator);
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -8px;
            border-width: 8px;
            border-style: solid;
            border-color: var(--apple-elevated) transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext,
        .tooltip:focus-within .tooltiptext {
            visibility: visible;
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--apple-blue);
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: help;
            margin-left: 6px;
            flex-shrink: 0;
            transition: transform 0.3s var(--spring-bounce), box-shadow 0.3s ease;
        }

        .info-icon:hover {
            transform: scale(1.15);
            box-shadow: 0 0 15px rgba(10, 132, 255, 0.5);
        }

        /* ============================================
           noUiSlider - APPLE STYLE
           ============================================ */
        .noUi-target {
            background: var(--apple-tertiary);
            border: none;
            border-radius: 6px;
            height: 6px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .noUi-connect {
            background: var(--apple-blue);
            border-radius: 6px;
        }

        .noUi-handle {
            width: 28px !important;
            height: 28px !important;
            right: -14px !important;
            top: -12px !important;
            background: linear-gradient(180deg, #ffffff 0%, #e8e8e8 100%);
            border: none;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3),
                        inset 0 1px 0 rgba(255,255,255,0.8);
            cursor: grab;
            transition: transform 0.2s var(--spring-bounce), box-shadow 0.2s ease;
        }

        .noUi-handle:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(10, 132, 255, 0.4);
        }

        .noUi-handle:active {
            cursor: grabbing;
            transform: scale(1.15);
        }

        .noUi-handle::before,
        .noUi-handle::after {
            display: none;
        }

        .noUi-tooltip {
            background: var(--apple-elevated);
            color: var(--apple-text);
            border: 1px solid var(--apple-separator);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        /* ============================================
           GAUGE & CHARTS
           ============================================ */
        .gauge-container {
            position: relative;
            width: 200px;
            height: 120px;
            margin: 0 auto;
        }

        .gauge-fill {
            fill: none;
            stroke-width: 10;
            stroke-linecap: round;
            transition: stroke-dashoffset 1.5s var(--spring-smooth),
                        stroke 0.4s ease;
        }

        canvas {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
        }

        /* ============================================
           LOADING & SHIMMER EFFECTS
           ============================================ */
        .shimmer {
            background: linear-gradient(90deg,
                var(--apple-surface) 25%,
                var(--apple-elevated) 50%,
                var(--apple-surface) 75%);
            background-size: 200% 100%;
            animation: shimmerWave 1.5s infinite;
            border-radius: 8px;
        }

        .progress-bar-animated {
            animation: progressFill 1.5s var(--spring-smooth) forwards;
        }

        /* ============================================
           WCAG FOCUS STATES
           ============================================ */
        :focus-visible {
            outline: 3px solid var(--apple-blue);
            outline-offset: 3px;
            border-radius: 8px;
        }

        :focus:not(:focus-visible) {
            outline: none;
        }

        /* ============================================
           MOBILE RESPONSIVENESS
           ============================================ */
        @media (max-width: 768px) {
            .glass-card {
                border-radius: 12px;
                margin: 0 -4px;
            }

            input[type="text"],
            input[type="number"],
            select,
            .btn-apple {
                font-size: 16px; /* Prevent zoom on iOS */
                min-height: 48px;
            }

            .tab-button {
                padding: 14px 16px;
                font-size: 13px;
            }

            .tooltip .tooltiptext {
                width: 220px;
                margin-left: -110px;
                font-size: 12px;
            }
        }

        /* Safe area insets for notched devices */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
                padding-bottom: max(16px, env(safe-area-inset-bottom));
            }
        }

        /* Reduce motion for accessibility */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ============================================
           PRINT STYLES
           ============================================ */
        @media print {
            body { background: white !important; color: black !important; }
            header, .no-print, .skip-link { display: none !important; }
            .glass-card { background: white !important; border: 1px solid #ddd !important; }
            * { animation: none !important; transition: none !important; }
        }

        /* ============================================
           APEXCHARTS DARK THEME
           ============================================ */
        .apexcharts-tooltip {
            background: var(--apple-elevated) !important;
            border: 1px solid var(--apple-separator) !important;
            border-radius: 12px !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5) !important;
        }

        .apexcharts-tooltip-title {
            background: var(--apple-tertiary) !important;
            border-bottom: 1px solid var(--apple-separator) !important;
            color: var(--apple-text) !important;
        }

        .apexcharts-tooltip-text {
            color: var(--apple-text) !important;
        }

        .apexcharts-xaxis-label,
        .apexcharts-yaxis-label {
            fill: var(--apple-text-secondary) !important;
        }

        .apexcharts-gridline {
            stroke: var(--apple-separator) !important;
        }

        .apexcharts-legend-text {
            color: var(--apple-text) !important;
        }

        /* Chart tooltip (canvas-based charts) */
        #chart-tooltip {
            position: fixed;
            z-index: 1000;
            background: var(--apple-elevated);
            border: 1px solid var(--apple-separator);
            border-radius: 12px;
            padding: 12px 14px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            color: var(--apple-text);
            font-size: 13px;
            pointer-events: none;
            backdrop-filter: blur(20px);
            animation: tooltip-fade-in 0.15s var(--spring-smooth);
        }

        #chart-tooltip.hidden {
            display: none;
        }

        @keyframes tooltip-fade-in {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(4px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Tippy.js theme */
        .tippy-box[data-theme~='custom'] {
            background: var(--apple-elevated);
            color: var(--apple-text);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--apple-separator);
        }

        .tippy-box[data-theme~='custom'] .tippy-arrow {
            color: var(--apple-elevated);
        }

        /* ============================================
           HISTOGRAM BARS
           ============================================ */
        .histogram-bar {
            transition: all 0.2s var(--spring-bounce);
            border-radius: 4px 4px 0 0;
        }

        .histogram-bar:hover {
            filter: brightness(1.2);
            transform: scaleY(1.02);
            transform-origin: bottom;
        }

        /* ============================================
           CONFETTI CELEBRATION
           ============================================ */
        @keyframes confetti {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .confetti-piece {
            position: fixed;
            width: 10px;
            height: 10px;
            top: 0;
            animation: confetti 3s var(--spring-smooth) forwards;
            z-index: 9999;
            pointer-events: none;
            border-radius: 2px;
        }

        /* ============================================
           GRADIENT TEXT ANIMATION
           ============================================ */
        .text-gradient-animated {
            background: linear-gradient(90deg,
                var(--apple-blue),
                var(--apple-purple),
                var(--apple-pink),
                var(--apple-blue));
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmerWave 3s linear infinite;
        }

        /* Breathing animation for active elements */
        .animate-breathe {
            animation: applePulse 3s ease-in-out infinite;
        }

        /* Insight pulse for warnings */
        .insight-warning {
            animation: applePulse 2s ease-in-out infinite;
        }

        /* Chart fade-in */
        canvas.chart-animated {
            animation: appleFadeIn 0.6s var(--spring-smooth);
        }

        /* ============================================
           SCROLLBAR STYLING
           ============================================ */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--apple-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--apple-tertiary);
            border-radius: 5px;
            border: 2px solid var(--apple-bg);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--apple-text-tertiary);
        }

        /* Sparkle effect */
        .sparkle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--apple-yellow);
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            animation: applePulse 1.5s ease-in-out infinite;
        }

        /* ============================================
           SCENARIO CARDS - ENHANCED
           ============================================ */
        .scenario-card {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
        }

        .scenario-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
        }

        .dark .scenario-card:hover {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        .scenario-card.active {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        /* ============================================
           HISTOGRAM BARS
           ============================================ */
        .histogram-bar {
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .histogram-bar:hover {
            opacity: 0.8;
            transform: scaleY(1.02);
            transform-origin: bottom;
        }

        /* ============================================
           PRINT STYLES FOR PDF EXPORT
           ============================================ */
        @media print {
            body {
                background: white !important;
            }

            header, .no-print, .skip-link {
                display: none !important;
            }

            .tab-content {
                display: block !important;
            }

            canvas {
                max-width: 100%;
                page-break-inside: avoid;
            }

            .page-break {
                page-break-after: always;
            }

            * {
                animation: none !important;
                transition: none !important;
            }
        }

        /* ============================================
           INSIGHTS PANEL ANIMATIONS
           ============================================ */
        @keyframes insightPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.9; transform: scale(1.005); }
        }

        .insight-warning {
            animation: insightPulse 2s ease-in-out infinite;
        }

        /* ============================================
           CHART FADE-IN ANIMATION
           ============================================ */
        @keyframes chartFadeIn {
            from {
                opacity: 0;
                transform: scale(0.96) translateY(10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        canvas.chart-animated {
            animation: chartFadeIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* ============================================
           SMOOTH TAB TRANSITIONS
           ============================================ */
        .tab-content {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        .tab-content.hidden {
            opacity: 0;
            transform: translateY(5px);
        }

        .tab-button {
            position: relative;
            transition: all 0.3s ease;
        }

        .tab-button::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border-radius: 3px;
            transition: width 0.3s ease, left 0.3s ease;
        }

        .tab-button[aria-selected="true"]::after,
        .tab-button.active::after {
            width: 100%;
            left: 0;
        }

        /* ============================================
           FLOATING ACTION ANIMATION
           ============================================ */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }

        .float-animation {
            animation: float 3s ease-in-out infinite;
        }

        /* ============================================
           CONFETTI CELEBRATION (for high success rates)
           ============================================ */
        @keyframes confetti {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .confetti-piece {
            position: fixed;
            width: 10px;
            height: 10px;
            top: 0;
            animation: confetti 3s ease-in-out forwards;
            z-index: 9999;
            pointer-events: none;
        }

        /* ============================================
           APEXCHARTS CUSTOM STYLING
           ============================================ */
        .apexcharts-tooltip {
            background: rgba(30, 41, 59, 0.95) !important;
            border: none !important;
            border-radius: 8px !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3) !important;
        }

        .apexcharts-tooltip-title {
            background: rgba(51, 65, 85, 0.8) !important;
            border-bottom: none !important;
            color: #f1f5f9 !important;
        }

        .apexcharts-tooltip-text {
            color: #f1f5f9 !important;
        }

        .dark .apexcharts-xaxis-label,
        .dark .apexcharts-yaxis-label {
            fill: #94a3b8 !important;
        }

        .apexcharts-bar-area:hover {
            filter: brightness(1.1);
        }
    </style>
</head>
<body class="bg-black text-white font-system antialiased">
    <!-- WCAG 2.2: Skip Navigation Link -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- ARIA Live Region for Dynamic Updates -->
    <div id="aria-live" class="sr-only" aria-live="polite" aria-atomic="true"></div>

    <!-- ============================================
         MAIN APP CONTAINER
         ============================================ -->
    <div class="min-h-screen flex flex-col">

        <!-- ============================================
             HEADER - STICKY TOP BAR
             ============================================ -->
        <header class="glass-card sticky top-0 z-50 border-b border-white/5" style="background: rgba(0,0,0,0.8); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%);">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <h1 class="text-xl sm:text-2xl font-bold text-gradient-animated tracking-tight">
                            Retirement Simulator
                        </h1>
                        <span class="text-xs text-[#636366] font-mono">v2025.12.29</span>
                        <!-- Back to Assumptions button (hidden initially) -->
                        <button id="back-to-assumptions" class="hidden text-sm font-medium text-[#0a84ff] hover:text-[#409cff] transition-colors">
                            ‚Üê Edit Assumptions
                        </button>
                    </div>

                </div>
            </div>
        </header>

        <!-- ============================================
             MAIN CONTENT AREA
             ============================================ -->
        <main id="main-content" class="flex-1 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-12 w-full" role="main">

            <!-- ============================================
                 ASSUMPTIONS PANEL - SHOWN INITIALLY
                 ============================================
                 Takes full screen before simulation runs -->
            <div id="assumptions-panel" class="animate-fade-in">
                <div class="max-w-4xl mx-auto">
                    <div class="text-center mb-10">
                        <h2 class="text-3xl sm:text-4xl font-bold text-white mb-3 tracking-tight">Configure Your Retirement Plan</h2>
                        <p class="text-[#98989d] text-lg">Enter your assumptions below and select withdrawal strategies to compare</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                        <!-- Plan Setup Card -->
                        <div class="glass-card p-6 hover-lift stagger-item" style="animation-delay: 0.05s">
                            <h3 class="text-lg font-semibold text-white mb-5 flex items-center">
                                <span class="w-8 h-8 rounded-lg bg-[#0a84ff]/20 flex items-center justify-center mr-3">
                                    <svg class="w-4 h-4 text-[#0a84ff]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                                </span>
                                Plan Setup
                                <span class="tooltip ml-2">
                                    <span class="info-icon">i</span>
                                    <span class="tooltiptext">Configure your basic retirement timeline and starting portfolio value.</span>
                                </span>
                            </h3>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-[#98989d] mb-2">
                                        Retirement Age
                                        <span class="tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltiptext">Age when you plan to retire and start withdrawing from your portfolio.</span>
                                        </span>
                                    </label>
                                    <input type="number" id="retirement-age" value="65" min="18" max="100"
                                        class="w-full px-3 py-2 bg-[#2c2c2e] border border-[#3a3a3c] rounded-lg text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-[#98989d] mb-2">
                                        Planning Horizon (Age)
                                        <span class="tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltiptext">The age you want to plan for. Common values are 90-100 to account for longevity risk.</span>
                                        </span>
                                    </label>
                                    <input type="number" id="planning-age" value="90" min="18" max="120"
                                        class="w-full px-3 py-2 bg-[#2c2c2e] border border-[#3a3a3c] rounded-lg text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-[#98989d] mb-2">
                                        Starting Portfolio at Retirement
                                        <span class="tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltiptext">Total portfolio value when you retire. This is your starting nest egg for withdrawals.</span>
                                        </span>
                                    </label>
                                    <div class="relative">
                                        <span class="absolute inset-y-0 left-1.5 flex items-center text-white font-medium pointer-events-none select-none">$</span>
                                        <input type="text" id="starting-portfolio" value="3,000,000"
                                            class="w-full pl-11 pr-3 py-2.5 bg-[#2c2c2e] border border-[#3a3a3c] rounded-lg text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-[#98989d] mb-2">
                                        Starting Annual Withdrawal ($/year)
                                        <span class="tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltiptext">Your desired annual withdrawal amount in year one of retirement. This overrides the default percentage-based calculations (e.g., 4% rule). Set to $0 to use each strategy's default calculation.</span>
                                        </span>
                                    </label>
                                    <div class="relative">
                                        <span class="absolute inset-y-0 left-1.5 flex items-center text-white font-medium pointer-events-none select-none">$</span>
                                        <input type="text" id="starting-withdrawal" value="50,000"
                                            class="w-full pl-11 pr-3 py-2.5 bg-[#2c2c2e] border border-[#3a3a3c] rounded-lg text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                    </div>
                                    <p class="text-xs text-[#636366] mt-1">Set to $0 to use default strategy calculations</p>
                                </div>
                            </div>
                        </div>

                        <!-- Market Assumptions Card -->
                        <div class="glass-card p-6 hover-lift stagger-item" style="animation-delay: 0.1s">
                            <h3 class="text-lg font-semibold text-white mb-5 flex items-center">
                                <span class="w-8 h-8 rounded-lg bg-[#30d158]/20 flex items-center justify-center mr-3">
                                    <svg class="w-4 h-4 text-[#30d158]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                                </span>
                                Market Assumptions
                                <span class="tooltip ml-2">
                                    <span class="info-icon">i</span>
                                    <span class="tooltiptext">Expected returns and volatility drive the simulation. Conservative: 5%/12%, Moderate: 6%/15%, Aggressive: 7%/18%.</span>
                                </span>
                            </h3>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-[#98989d] mb-2">
                                        Expected Real Return (% per year)
                                        <span class="tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltiptext">Average annual return after inflation. Historical US stocks: ~7%, 60/40 portfolio: ~5%.</span>
                                        </span>
                                    </label>
                                    <div class="relative">
                                        <input type="text" id="expected-return" value="5.0"
                                            class="w-full pr-8 pl-3 py-2 bg-[#2c2c2e] border border-[#3a3a3c] rounded-lg text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-[#636366] font-medium">%</span>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-[#98989d] mb-2">
                                        Annual Volatility (Standard Deviation %)
                                        <span class="tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltiptext">How much returns vary year-to-year. Higher volatility = more uncertainty. US stocks: ~15-18%, bonds: ~5-7%.</span>
                                        </span>
                                    </label>
                                    <div class="relative">
                                        <input type="text" id="volatility" value="15.0"
                                            class="w-full pr-8 pl-3 py-2 bg-[#2c2c2e] border border-[#3a3a3c] rounded-lg text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-[#636366] font-medium">%</span>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-[#98989d] mb-2">
                                        Inflation Rate (% per year)
                                        <span class="tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltiptext">Expected long-term inflation. Historical US average: ~2-3%. This affects purchasing power over time.</span>
                                        </span>
                                    </label>
                                    <div class="relative">
                                        <input type="text" id="inflation-rate" value="2.5"
                                            class="w-full pr-8 pl-3 py-2 bg-[#2c2c2e] border border-[#3a3a3c] rounded-lg text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-[#636366] font-medium">%</span>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-[#98989d] mb-2">
                                        Monte Carlo Simulations
                                        <span class="tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltiptext">Number of random market scenarios to test. More = better accuracy but slower. 1000+ recommended.</span>
                                        </span>
                                    </label>
                                    <input type="text" id="monte-carlo-runs" value="10,000"
                                        class="w-full px-3 py-2 bg-[#2c2c2e] border border-[#3a3a3c] rounded-lg text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                </div>
                            </div>
                        </div>

                        <!-- Income & Constraints Card -->
                        <div class="glass-card p-6 hover-lift stagger-item" style="animation-delay: 0.15s">
                            <h3 class="text-lg font-semibold text-white mb-5 flex items-center">
                                <span class="w-8 h-8 rounded-lg bg-[#ff9f0a]/20 flex items-center justify-center mr-3">
                                    <svg class="w-4 h-4 text-[#ff9f0a]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                </span>
                                Income & Constraints
                            </h3>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-[#98989d] mb-2">
                                        Minimum Annual Withdrawal ($/year, today's dollars)
                                        <span class="tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltiptext">Your minimum required withdrawal in today's purchasing power. The calculator adjusts this for inflation each year.</span>
                                        </span>
                                    </label>
                                    <div class="relative">
                                        <span class="absolute inset-y-0 left-1.5 flex items-center text-white font-medium pointer-events-none select-none">$</span>
                                        <input type="text" id="min-spending" value="100,000"
                                            class="w-full pl-11 pr-3 py-2.5 bg-[#2c2c2e] border border-[#3a3a3c] rounded-lg text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                    </div>
                                    <p class="text-xs text-[#636366] mt-1">Floor: withdrawals won't go below this amount</p>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-[#98989d] mb-2">
                                        Maximum Annual Withdrawal ($/year, today's dollars)
                                        <span class="tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltiptext">Your maximum withdrawal cap in today's purchasing power. Even if the strategy calculates a higher withdrawal, it will be capped at this amount. Set to $0 for no cap.</span>
                                        </span>
                                    </label>
                                    <div class="relative">
                                        <span class="absolute inset-y-0 left-1.5 flex items-center text-white font-medium pointer-events-none select-none">$</span>
                                        <input type="text" id="max-spending" value="150,000"
                                            class="w-full pl-11 pr-3 py-2.5 bg-[#2c2c2e] border border-[#3a3a3c] rounded-lg text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                    </div>
                                    <p class="text-xs text-[#636366] mt-1">Cap: withdrawals won't exceed this. Set to $0 for no cap.</p>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-[#98989d] mb-2">
                                        One-Time Expense Every 5 Years (today's dollars)
                                        <span class="tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltiptext">Large one-time expense occurring every 5 years (e.g., car replacement, home renovation). Deducted in addition to annual spending. Adjusted for inflation.</span>
                                        </span>
                                    </label>
                                    <div class="relative">
                                        <span class="absolute inset-y-0 left-1.5 flex items-center text-white font-medium pointer-events-none select-none">$</span>
                                        <input type="text" id="one-time-expense" value="0"
                                            class="w-full pl-11 pr-3 py-2.5 bg-[#2c2c2e] border border-[#3a3a3c] rounded-lg text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                    </div>
                                    <p class="text-xs text-[#636366] mt-1">Occurs in years 5, 10, 15, 20, etc. Set to $0 to disable.</p>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-[#98989d] mb-2">
                                        Social Security / Pension ($/year)
                                        <span class="tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltiptext">Annual income from Social Security, pensions, or other guaranteed sources. Reduces portfolio withdrawal needs.</span>
                                        </span>
                                    </label>
                                    <div class="relative">
                                        <span class="absolute inset-y-0 left-1.5 flex items-center text-white font-medium pointer-events-none select-none">$</span>
                                        <input type="text" id="social-security" value="30,000"
                                            class="w-full pl-11 pr-3 py-2.5 bg-[#2c2c2e] border border-[#3a3a3c] rounded-lg text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-[#98989d] mb-2">
                                        Social Security Start Age
                                        <span class="tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltiptext">Age when Social Security benefits begin. Common ages: 62 (reduced), 67 (full), 70 (maximum).</span>
                                        </span>
                                    </label>
                                    <input type="number" id="ss-start-age" value="67" min="62" max="70"
                                        class="w-full px-3 py-2 bg-[#2c2c2e] border border-[#3a3a3c] rounded-lg text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-[#98989d] mb-2">
                                        Target Success Rate
                                        <span class="tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltiptext">Desired probability of not running out of money. Higher = more conservative. 90-95% is common for retirement planning.</span>
                                        </span>
                                    </label>
                                    <select id="risk-tolerance"
                                        class="w-full px-3 py-2 bg-[#2c2c2e] border border-[#3a3a3c] rounded-lg text-white focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                        <option value="25">25% - Very Aggressive</option>
                                        <option value="50">50% - Aggressive</option>
                                        <option value="75" selected>75% - Moderate</option>
                                        <option value="95">95% - Conservative</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Withdrawal Strategies Card -->
                        <div class="glass-card p-6 hover-lift stagger-item" style="animation-delay: 0.2s">
                            <h3 class="text-lg font-semibold text-white mb-5 flex items-center">
                                <span class="w-8 h-8 rounded-lg bg-[#bf5af2]/20 flex items-center justify-center mr-3">
                                    <svg class="w-4 h-4 text-[#bf5af2]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                                </span>
                                Withdrawal Strategies
                            </h3>

                            <div class="space-y-3">
                                <label class="flex items-start cursor-pointer group">
                                    <input type="checkbox" id="strategy-constant-real" checked
                                        class="mt-1 w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500 dark:focus:ring-primary-600 dark:ring-offset-slate-900 focus:ring-2 dark:bg-slate-800 dark:border-slate-700">
                                    <span class="ml-3 text-sm text-[#e5e5e7] group-hover:text-gray-900 dark:group-hover:text-gray-100 flex items-start">
                                        Constant Real Withdrawal (4% Rule)
                                        <span class="tooltip ml-1">
                                            <span class="info-icon">i</span>
                                            <span class="tooltiptext"><strong>Classic 4% Rule:</strong> Withdraw a fixed percentage (typically 4-4.5%) of your starting portfolio in year one, then adjust that dollar amount for inflation each year. Provides predictable income but doesn't adapt to market performance.</span>
                                        </span>
                                    </span>
                                </label>

                                <label class="flex items-start cursor-pointer group">
                                    <input type="checkbox" id="strategy-constant-pct" checked
                                        class="mt-1 w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500 dark:focus:ring-primary-600 dark:ring-offset-slate-900 focus:ring-2 dark:bg-slate-800 dark:border-slate-700">
                                    <span class="ml-3 text-sm text-[#e5e5e7] group-hover:text-gray-900 dark:group-hover:text-gray-100 flex items-start">
                                        Constant % of Portfolio
                                        <span class="tooltip ml-1">
                                            <span class="info-icon">i</span>
                                            <span class="tooltiptext"><strong>Dynamic Percentage:</strong> Withdraw a fixed percentage (e.g., 4%) of your current portfolio value each year. Your income varies with market performance, but theoretically you never run out. Good years = more spending, bad years = belt tightening.</span>
                                        </span>
                                    </span>
                                </label>

                                <label class="flex items-start cursor-pointer group">
                                    <input type="checkbox" id="strategy-vpw"
                                        class="mt-1 w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500 dark:focus:ring-primary-600 dark:ring-offset-slate-900 focus:ring-2 dark:bg-slate-800 dark:border-slate-700">
                                    <span class="ml-3 text-sm text-[#e5e5e7] group-hover:text-gray-900 dark:group-hover:text-gray-100 flex items-start">
                                        Variable Percentage (VPW)
                                        <span class="tooltip ml-1">
                                            <span class="info-icon">i</span>
                                            <span class="tooltiptext"><strong>VPW Method:</strong> Withdrawal percentage increases as you age based on remaining life expectancy and asset allocation. Starts conservatively then allows higher spending in later years. Balances longevity protection with lifestyle.</span>
                                        </span>
                                    </span>
                                </label>

                                <label class="flex items-start cursor-pointer group">
                                    <input type="checkbox" id="strategy-guardrails" checked
                                        class="mt-1 w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500 dark:focus:ring-primary-600 dark:ring-offset-slate-900 focus:ring-2 dark:bg-slate-800 dark:border-slate-700">
                                    <span class="ml-3 text-sm text-[#e5e5e7] group-hover:text-gray-900 dark:group-hover:text-gray-100 flex items-start">
                                        Guardrails (Dynamic)
                                        <span class="tooltip ml-1">
                                            <span class="info-icon">i</span>
                                            <span class="tooltiptext"><strong>Guyton-Klinger Guardrails:</strong> Start with an initial withdrawal rate, but adjust spending up or down (typically 10%) when your withdrawal rate crosses preset guardrails (¬±20% of initial). Provides stability with some market responsiveness.</span>
                                        </span>
                                    </span>
                                </label>

                                <label class="flex items-start cursor-pointer group">
                                    <input type="checkbox" id="strategy-rmd"
                                        class="mt-1 w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500 dark:focus:ring-primary-600 dark:ring-offset-slate-900 focus:ring-2 dark:bg-slate-800 dark:border-slate-700">
                                    <span class="ml-3 text-sm text-[#e5e5e7] group-hover:text-gray-900 dark:group-hover:text-gray-100 flex items-start">
                                        RMD / Life Expectancy
                                        <span class="tooltip ml-1">
                                            <span class="info-icon">i</span>
                                            <span class="tooltiptext"><strong>RMD-Style:</strong> Each year, divide your portfolio by remaining life expectancy to determine withdrawal. Similar to IRS Required Minimum Distributions. Guarantees portfolio lasts lifetime but creates volatile income that starts low and increases with age.</span>
                                        </span>
                                    </span>
                                </label>
                            </div>
                        </div>

                    </div>

                    <!-- Run Button -->
                    <div class="mt-10 text-center">
                        <button id="run-simulation"
                            class="btn-apple bg-[#0a84ff] text-white font-semibold py-4 px-16 rounded-2xl text-lg shadow-[0_0_30px_rgba(10,132,255,0.4)] hover:shadow-[0_0_50px_rgba(10,132,255,0.6)] transform hover:scale-[1.02] active:scale-[0.98] transition-all duration-300"
                            aria-describedby="simulation-description">
                            <span class="flex items-center gap-3 justify-center">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                                Run Simulation
                            </span>
                        </button>
                        <p id="simulation-description" class="sr-only">Runs Monte Carlo simulation with your configured assumptions</p>
                    </div>

                    <!-- Status Message -->
                    <div id="status-message" class="hidden mt-6"></div>
                </div>
            </div>

            <!-- ============================================
                 RESULTS PANEL - SHOWN AFTER SIMULATION
                 ============================================ -->
            <div id="results-panel" class="hidden animate-fade-in">
                <div class="bg-[#1c1c1e] rounded-xl shadow-lg border border-[#38383a]">

                    <!-- Tabs -->
                    <nav class="border-b border-[#38383a]">
                        <ul class="flex flex-wrap -mb-px overflow-x-auto">
                            <li>
                                <button class="tab-button active inline-block px-4 sm:px-6 py-4 text-sm font-medium border-b-2 border-primary-500 text-primary-600 dark:text-primary-400 hover:text-primary-600 dark:hover:text-primary-400"
                                    data-tab="summary">
                                    Summary
                                </button>
                            </li>
                            <li>
                                <button class="tab-button inline-block px-4 sm:px-6 py-4 text-sm font-medium border-b-2 border-transparent text-[#636366] hover:text-primary-600 dark:hover:text-primary-400"
                                    data-tab="report">
                                    Report
                                </button>
                            </li>
                            <li>
                                <button class="tab-button inline-block px-4 sm:px-6 py-4 text-sm font-medium border-b-2 border-transparent text-[#636366] hover:text-primary-600 dark:hover:text-primary-400"
                                    data-tab="charts">
                                    Charts
                                </button>
                            </li>
                            <li>
                                <button class="tab-button inline-block px-4 sm:px-6 py-4 text-sm font-medium border-b-2 border-transparent text-[#636366] hover:text-primary-600 dark:hover:text-primary-400"
                                    data-tab="tables">
                                    Detailed Tables
                                </button>
                            </li>
                            <li>
                                <button class="tab-button inline-block px-4 sm:px-6 py-4 text-sm font-medium border-b-2 border-transparent text-[#636366] hover:text-primary-600 dark:hover:text-primary-400"
                                    data-tab="assumptions">
                                    Assumptions
                                </button>
                            </li>
                        </ul>
                    </nav>

                    <!-- Tab Content -->
                    <div class="p-4 sm:p-6 lg:p-8 max-h-[calc(100vh-250px)] overflow-y-auto">

                        <!-- Tab: Summary -->
                        <div class="tab-content active" id="tab-summary">
                            <!-- Populated by JavaScript -->
                        </div>

                        <!-- Tab: Charts -->
                        <div class="tab-content hidden" id="tab-charts">
                            <!-- Populated by JavaScript -->
                        </div>

                        <!-- Tab: Tables -->
                        <div class="tab-content hidden" id="tab-tables">
                            <!-- Populated by JavaScript -->
                        </div>

                        <!-- Tab: Report -->
                        <div class="tab-content hidden" id="tab-report">
                            <!-- Populated by JavaScript -->
                        </div>

                        <!-- Tab: Assumptions -->
                        <div class="tab-content hidden" id="tab-assumptions">
                            <!-- Populated by JavaScript -->
                        </div>

                    </div>
                </div>
            </div>

        </main>

    </div>

    <!-- Chart tooltip (hidden by default, shown on hover) -->
    <div id="chart-tooltip" class="hidden"></div>

    <!-- ============================================
         JAVASCRIPT APPLICATION CODE
         ============================================

         ARCHITECTURE OVERVIEW:
         ----------------------
         1. INPUT FORMATTING: Handles number/currency formatting
         2. SIMULATION ENGINE: Monte Carlo simulations for all strategies
         3. CHARTS MODULE: Canvas-based interactive charts with tooltips
         4. REPORT MODULE: Generates narrative recommendations
         5. UI MODULE: Manages application state and user interactions

         DATA FLOW:
         ----------
         User Inputs ‚Üí Validation ‚Üí Simulation Engine ‚Üí Aggregation ‚Üí [Charts, Tables, Report]

         ============================================ -->
    <script type="module">
        'use strict';

        // ============================================
        // GLOBAL STATE MANAGEMENT
        // ============================================
        // Stores simulation results for use across modules
        let globalResults = null;
        let globalInputs = null;

        // ============================================
        // INPUT FORMATTING UTILITIES
        // ============================================
        // Formats numbers with commas for readability
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // Parses formatted numbers back to raw values
        function parseFormattedNumber(str) {
            return parseFloat(str.replace(/,/g, ''));
        }

        /**
         * Sets up automatic number formatting for input fields
         * On focus: shows raw number for editing
         * On blur: formats with commas/symbols
         */
        function setupNumberInput(id, formatter, parser) {
            const input = document.getElementById(id);

            input.addEventListener('focus', function() {
                const val = parser(this.value);
                if (!isNaN(val)) {
                    this.value = val.toString();
                }
            });

            input.addEventListener('blur', function() {
                const val = parser(this.value);
                if (!isNaN(val)) {
                    this.value = formatter(val);
                }
            });
        }

        // Initialize formatters on page load
        document.addEventListener('DOMContentLoaded', () => {
            setupNumberInput('starting-portfolio', formatNumber, parseFormattedNumber);
            setupNumberInput('min-spending', formatNumber, parseFormattedNumber);
            setupNumberInput('one-time-expense', formatNumber, parseFormattedNumber);
            setupNumberInput('social-security', formatNumber, parseFormattedNumber);
            setupNumberInput('monte-carlo-runs', formatNumber, parseFormattedNumber);
        });

        // ============================================
        // TYPE DEFINITIONS (JSDoc for type safety)
        // ============================================

        /**
         * @typedef {Object} Inputs
         * @property {number} retirementAge
         * @property {number} planningAge
         * @property {number} startingPortfolio
         * @property {number} expectedReturn - Real return % per year
         * @property {number} volatility - Standard deviation %
         * @property {number} inflationRate - % per year
         * @property {number} monteCarloRuns
         * @property {number} minSpending
         * @property {number} socialSecurity
         * @property {number} ssStartAge
         * @property {number} targetSuccessRate
         * @property {string[]} strategies
         */

        /**
         * @typedef {Object} YearResult
         * @property {number} year - Year index (0-based)
         * @property {number} age - Retiree's age
         * @property {number} portfolioStart - Portfolio value at start of year
         * @property {number} returnPct - Annual return percentage
         * @property {number} withdrawal - Annual withdrawal amount
         * @property {number} portfolioEnd - Portfolio value at end of year
         * @property {boolean} ruined - Whether portfolio hit zero
         */

        /**
         * @typedef {Object} PathResult
         * @property {YearResult[]} years
         * @property {number} finalBalance
         * @property {number} totalWithdrawals
         * @property {boolean} ruined
         * @property {number} ruinAge
         */

        /**
         * @typedef {Object} StrategyResult
         * @property {string} name
         * @property {PathResult[]} paths
         * @property {number} successRate
         * @property {number} medianFinal
         * @property {number} p10Final
         * @property {number} p90Final
         * @property {number} medianWithdrawals
         * @property {YearResult[]} medianPath
         */

        // ============================================
        // SIMULATION ENGINE
        // Core Monte Carlo simulation that runs thousands of retirement scenarios.
        // Each scenario uses random market returns drawn from a normal distribution
        // to test if your portfolio survives the full retirement period.
        // All dollar values are computed in "real" (inflation-adjusted) terms.
        // ============================================
        const Simulation = {
            /**
             * Box-Muller transform: converts uniform random numbers to normal distribution.
             * This gives us realistic market return variation (most years near average,
             * occasional extreme years). Essential for accurate Monte Carlo simulation.
             */
            randomNormal() {
                let u = 0, v = 0;
                while (u === 0) u = Math.random(); // Avoid log(0)
                while (v === 0) v = Math.random();
                return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            },

            /**
             * Generates annual return based on mean and volatility
             * @param {number} mean - Expected return %
             * @param {number} volatility - Standard deviation %
             * @param {boolean} deterministic - If true, return mean (for median path)
             * @returns {number} Annual return as decimal
             */
            generateReturn(mean, volatility, deterministic = false) {
                if (deterministic) return mean / 100;
                const z = this.randomNormal();
                return (mean + z * volatility) / 100;
            },

            /**
             * Simplified actuarial life expectancy table
             * Returns expected years remaining at given age
             */
            lifeExpectancy(age) {
                if (age < 60) return 95 - age;
                if (age < 70) return 90 - age;
                if (age < 80) return 87 - age;
                if (age < 90) return 94 - age;
                return Math.max(2, 100 - age);
            },

            /**
             * VPW (Variable Percentage Withdrawal) lookup table
             * Withdrawal % increases with age and stock allocation
             */
            vpwPercentage(yearsRemaining, stockAllocation = 60) {
                if (yearsRemaining >= 30) return 3.0 + stockAllocation * 0.02;
                if (yearsRemaining >= 25) return 3.5 + stockAllocation * 0.02;
                if (yearsRemaining >= 20) return 4.0 + stockAllocation * 0.025;
                if (yearsRemaining >= 15) return 5.0 + stockAllocation * 0.03;
                if (yearsRemaining >= 10) return 6.5 + stockAllocation * 0.035;
                if (yearsRemaining >= 5) return 9.0 + stockAllocation * 0.04;
                return Math.min(100, 20.0 + yearsRemaining * 2);
            },

            /**
             * STRATEGY 1: Constant Real Withdrawal (4% Rule)
             * Withdraws the GREATER of: 4.5% of initial portfolio OR minSpending.
             * Amount is then inflation-adjusted each year to maintain purchasing power.
             */
            strategyConstantReal(inputs, deterministic = false) {
                const years = inputs.planningAge - inputs.retirementAge;
                const initialRate = 4.5; // 4.5% initial withdrawal rate
                const inflationMultiplier = 1 + inputs.inflationRate / 100;

                // Use startingWithdrawal if specified, otherwise use 4.5% rule
                let baseWithdrawal;
                if (inputs.startingWithdrawal && inputs.startingWithdrawal > 0) {
                    baseWithdrawal = inputs.startingWithdrawal;
                } else {
                    baseWithdrawal = inputs.startingPortfolio * (initialRate / 100);
                }

                // Apply min/max spending constraints
                let initialWithdrawal = Math.max(baseWithdrawal, inputs.minSpending || 0);
                if (inputs.maxSpending && inputs.maxSpending > 0) {
                    initialWithdrawal = Math.min(initialWithdrawal, inputs.maxSpending);
                }

                let portfolio = inputs.startingPortfolio;
                let withdrawal = initialWithdrawal;
                const yearResults = [];
                let ruined = false;
                let ruinAge = null;

                const baseMaxSpending = inputs.maxSpending || 0;

                for (let i = 0; i < years; i++) {
                    const age = inputs.retirementAge + i;
                    const portfolioStart = portfolio;

                    // Apply max spending cap (inflation-adjusted) if specified
                    if (baseMaxSpending > 0) {
                        const inflationAdjustedMaxSpending = baseMaxSpending * Math.pow(inflationMultiplier, i);
                        withdrawal = Math.min(withdrawal, inflationAdjustedMaxSpending);
                    }

                    // One-time expense every 5 years (inflation-adjusted)
                    const isExpenseYear = ((i + 1) % 5 === 0);
                    const oneTimeExpenseThisYear = isExpenseYear ? inputs.oneTimeExpense * Math.pow(inflationMultiplier, i) : 0;

                    // Social Security reduces portfolio withdrawal needs (with COLA adjustment)
                    const ssYearsReceiving = Math.max(0, age - inputs.ssStartAge);
                    const ss = (age >= inputs.ssStartAge) ? inputs.socialSecurity * Math.pow(inflationMultiplier, ssYearsReceiving) : 0;
                    const netWithdrawal = Math.max(0, withdrawal - ss) + oneTimeExpenseThisYear;

                    // Apply withdrawal
                    portfolio -= netWithdrawal;

                    if (portfolio < 0) {
                        portfolio = 0;
                        if (!ruined) {
                            ruined = true;
                            ruinAge = age;
                        }
                    }

                    // Apply investment return
                    const returnPct = this.generateReturn(inputs.expectedReturn, inputs.volatility, deterministic);
                    portfolio *= (1 + returnPct);

                    yearResults.push({
                        year: i,
                        age,
                        portfolioStart,
                        returnPct: returnPct * 100,
                        withdrawal: netWithdrawal,
                        portfolioEnd: portfolio,
                        ruined: portfolio <= 0
                    });

                    if (portfolio <= 0 && !ruined) {
                        ruined = true;
                        ruinAge = age;
                    }

                    // Inflate withdrawal for next year to maintain purchasing power
                    withdrawal *= inflationMultiplier;
                }

                return {
                    years: yearResults,
                    finalBalance: portfolio,
                    totalWithdrawals: yearResults.reduce((sum, y) => sum + y.withdrawal, 0),
                    ruined,
                    ruinAge
                };
            },

            /**
             * STRATEGY 2: Constant Percentage of Portfolio
             * Withdraws 4% of current portfolio each year, but never less than minSpending.
             * Self-adjusting to market conditions while maintaining minimum lifestyle.
             */
            strategyConstantPercent(inputs, deterministic = false) {
                const years = inputs.planningAge - inputs.retirementAge;
                const withdrawalRate = 4.0; // 4% each year
                const inflationMultiplier = 1 + inputs.inflationRate / 100;
                const baseMinSpending = inputs.minSpending || 0;
                const baseMaxSpending = inputs.maxSpending || 0;
                const baseStartingWithdrawal = inputs.startingWithdrawal || 0;

                let portfolio = inputs.startingPortfolio;
                const yearResults = [];
                let ruined = false;
                let ruinAge = null;

                for (let i = 0; i < years; i++) {
                    const age = inputs.retirementAge + i;
                    const portfolioStart = portfolio;

                    // Min/max spending grows with inflation to maintain purchasing power
                    const inflationAdjustedMinSpending = baseMinSpending * Math.pow(inflationMultiplier, i);
                    const inflationAdjustedMaxSpending = baseMaxSpending > 0 ? baseMaxSpending * Math.pow(inflationMultiplier, i) : Infinity;
                    const inflationAdjustedStartingWithdrawal = baseStartingWithdrawal > 0 ? baseStartingWithdrawal * Math.pow(inflationMultiplier, i) : 0;

                    // One-time expense every 5 years (inflation-adjusted)
                    const isExpenseYear = ((i + 1) % 5 === 0);
                    const oneTimeExpenseThisYear = isExpenseYear ? inputs.oneTimeExpense * Math.pow(inflationMultiplier, i) : 0;

                    // Social Security with COLA adjustment
                    const ssYearsReceiving = Math.max(0, age - inputs.ssStartAge);
                    const ss = (age >= inputs.ssStartAge) ? inputs.socialSecurity * Math.pow(inflationMultiplier, ssYearsReceiving) : 0;

                    // Withdrawal is the greater of: 4% of portfolio, minSpending, or startingWithdrawal
                    const percentWithdrawal = portfolio * (withdrawalRate / 100);
                    let targetWithdrawal = Math.max(percentWithdrawal, inflationAdjustedMinSpending);
                    if (inflationAdjustedStartingWithdrawal > 0) {
                        targetWithdrawal = Math.max(targetWithdrawal, inflationAdjustedStartingWithdrawal);
                    }
                    // Apply max spending cap
                    targetWithdrawal = Math.min(targetWithdrawal, inflationAdjustedMaxSpending);
                    const netWithdrawal = Math.max(0, targetWithdrawal - ss) + oneTimeExpenseThisYear;

                    portfolio -= netWithdrawal;

                    if (portfolio < 0) {
                        portfolio = 0;
                        if (!ruined) {
                            ruined = true;
                            ruinAge = age;
                        }
                    }

                    const returnPct = this.generateReturn(inputs.expectedReturn, inputs.volatility, deterministic);
                    portfolio *= (1 + returnPct);

                    yearResults.push({
                        year: i,
                        age,
                        portfolioStart,
                        returnPct: returnPct * 100,
                        withdrawal: netWithdrawal,
                        portfolioEnd: portfolio,
                        ruined: portfolio <= 0
                    });

                    if (portfolio <= 0 && !ruined) {
                        ruined = true;
                        ruinAge = age;
                    }
                }

                return {
                    years: yearResults,
                    finalBalance: portfolio,
                    totalWithdrawals: yearResults.reduce((sum, y) => sum + y.withdrawal, 0),
                    ruined,
                    ruinAge
                };
            },

            /**
             * STRATEGY 3: Variable Percentage Withdrawal (VPW)
             * Withdrawal % increases with age based on life expectancy.
             * Never withdraws less than minSpending (inflation-adjusted).
             */
            strategyVPW(inputs, deterministic = false) {
                const years = inputs.planningAge - inputs.retirementAge;
                const inflationMultiplier = 1 + inputs.inflationRate / 100;
                const baseMinSpending = inputs.minSpending || 0;
                const baseMaxSpending = inputs.maxSpending || 0;
                const baseStartingWithdrawal = inputs.startingWithdrawal || 0;

                let portfolio = inputs.startingPortfolio;
                const yearResults = [];
                let ruined = false;
                let ruinAge = null;

                for (let i = 0; i < years; i++) {
                    const age = inputs.retirementAge + i;
                    const portfolioStart = portfolio;
                    const inflationAdjustedMinSpending = baseMinSpending * Math.pow(inflationMultiplier, i);
                    const inflationAdjustedMaxSpending = baseMaxSpending > 0 ? baseMaxSpending * Math.pow(inflationMultiplier, i) : Infinity;
                    const inflationAdjustedStartingWithdrawal = baseStartingWithdrawal > 0 ? baseStartingWithdrawal * Math.pow(inflationMultiplier, i) : 0;

                    // One-time expense every 5 years (inflation-adjusted)
                    const isExpenseYear = ((i + 1) % 5 === 0);
                    const oneTimeExpenseThisYear = isExpenseYear ? inputs.oneTimeExpense * Math.pow(inflationMultiplier, i) : 0;

                    // Social Security with COLA adjustment
                    const ssYearsReceiving = Math.max(0, age - inputs.ssStartAge);
                    const ss = (age >= inputs.ssStartAge) ? inputs.socialSecurity * Math.pow(inflationMultiplier, ssYearsReceiving) : 0;

                    const yearsRemaining = inputs.planningAge - age;
                    const vpwPct = this.vpwPercentage(yearsRemaining, 60);
                    const vpwWithdrawal = portfolio * (vpwPct / 100);
                    let targetWithdrawal = Math.max(vpwWithdrawal, inflationAdjustedMinSpending);
                    if (inflationAdjustedStartingWithdrawal > 0) {
                        targetWithdrawal = Math.max(targetWithdrawal, inflationAdjustedStartingWithdrawal);
                    }
                    // Apply max spending cap
                    targetWithdrawal = Math.min(targetWithdrawal, inflationAdjustedMaxSpending);
                    const netWithdrawal = Math.max(0, targetWithdrawal - ss) + oneTimeExpenseThisYear;

                    portfolio -= netWithdrawal;

                    if (portfolio < 0) {
                        portfolio = 0;
                        if (!ruined) {
                            ruined = true;
                            ruinAge = age;
                        }
                    }

                    const returnPct = this.generateReturn(inputs.expectedReturn, inputs.volatility, deterministic);
                    portfolio *= (1 + returnPct);

                    yearResults.push({
                        year: i,
                        age,
                        portfolioStart,
                        returnPct: returnPct * 100,
                        withdrawal: netWithdrawal,
                        portfolioEnd: portfolio,
                        ruined: portfolio <= 0
                    });

                    if (portfolio <= 0 && !ruined) {
                        ruined = true;
                        ruinAge = age;
                    }
                }

                return {
                    years: yearResults,
                    finalBalance: portfolio,
                    totalWithdrawals: yearResults.reduce((sum, y) => sum + y.withdrawal, 0),
                    ruined,
                    ruinAge
                };
            },

            /**
             * STRATEGY 4: Guardrails (Guyton-Klinger)
             * Adjusts spending when withdrawal rate crosses thresholds.
             * Initial withdrawal is the greater of 5% of portfolio or minSpending.
             * Guardrails can adjust spending but never below minSpending floor.
             */
            strategyGuardrails(inputs, deterministic = false) {
                const years = inputs.planningAge - inputs.retirementAge;
                const initialRate = 5.0;
                const upperGuardrail = initialRate * 1.20; // +20%
                const lowerGuardrail = initialRate * 0.80; // -20%
                const adjustmentFactor = 0.10; // 10% spending adjustment
                const inflationMultiplier = 1 + inputs.inflationRate / 100;
                const baseMinSpending = inputs.minSpending || 0;
                const baseMaxSpending = inputs.maxSpending || 0;

                let portfolio = inputs.startingPortfolio;

                // Use startingWithdrawal if specified, otherwise use 5% rule
                let baseWithdrawal;
                if (inputs.startingWithdrawal && inputs.startingWithdrawal > 0) {
                    baseWithdrawal = inputs.startingWithdrawal;
                } else {
                    baseWithdrawal = inputs.startingPortfolio * (initialRate / 100);
                }

                // Apply min/max spending constraints to initial withdrawal
                let withdrawal = Math.max(baseWithdrawal, baseMinSpending);
                if (baseMaxSpending > 0) {
                    withdrawal = Math.min(withdrawal, baseMaxSpending);
                }

                const yearResults = [];
                let ruined = false;
                let ruinAge = null;

                for (let i = 0; i < years; i++) {
                    const age = inputs.retirementAge + i;
                    const portfolioStart = portfolio;
                    const inflationAdjustedMinSpending = baseMinSpending * Math.pow(inflationMultiplier, i);
                    const inflationAdjustedMaxSpending = baseMaxSpending > 0 ? baseMaxSpending * Math.pow(inflationMultiplier, i) : Infinity;

                    // One-time expense every 5 years (inflation-adjusted)
                    const isExpenseYear = ((i + 1) % 5 === 0);
                    const oneTimeExpenseThisYear = isExpenseYear ? inputs.oneTimeExpense * Math.pow(inflationMultiplier, i) : 0;

                    // Social Security with COLA adjustment
                    const ssYearsReceiving = Math.max(0, age - inputs.ssStartAge);
                    const ss = (age >= inputs.ssStartAge) ? inputs.socialSecurity * Math.pow(inflationMultiplier, ssYearsReceiving) : 0;

                    // Check if withdrawal rate is outside guardrails
                    const currentRate = (withdrawal / portfolioStart) * 100;

                    if (currentRate > upperGuardrail) {
                        withdrawal *= (1 - adjustmentFactor); // Reduce spending
                    } else if (currentRate < lowerGuardrail && portfolio > 0) {
                        withdrawal *= (1 + adjustmentFactor); // Increase spending
                    }

                    // Apply min/max spending constraints
                    withdrawal = Math.max(withdrawal, inflationAdjustedMinSpending);
                    withdrawal = Math.min(withdrawal, inflationAdjustedMaxSpending);

                    const netWithdrawal = Math.max(0, withdrawal - ss) + oneTimeExpenseThisYear;

                    portfolio -= netWithdrawal;

                    if (portfolio < 0) {
                        portfolio = 0;
                        if (!ruined) {
                            ruined = true;
                            ruinAge = age;
                        }
                    }

                    const returnPct = this.generateReturn(inputs.expectedReturn, inputs.volatility, deterministic);
                    portfolio *= (1 + returnPct);

                    yearResults.push({
                        year: i,
                        age,
                        portfolioStart,
                        returnPct: returnPct * 100,
                        withdrawal: netWithdrawal,
                        portfolioEnd: portfolio,
                        ruined: portfolio <= 0
                    });

                    if (portfolio <= 0 && !ruined) {
                        ruined = true;
                        ruinAge = age;
                    }

                    // Inflate base withdrawal for next year
                    withdrawal *= inflationMultiplier;
                }

                return {
                    years: yearResults,
                    finalBalance: portfolio,
                    totalWithdrawals: yearResults.reduce((sum, y) => sum + y.withdrawal, 0),
                    ruined,
                    ruinAge
                };
            },

            /**
             * STRATEGY 5: RMD / Life Expectancy
             * Divides portfolio by remaining life expectancy each year.
             * Never withdraws less than minSpending (inflation-adjusted).
             */
            strategyRMD(inputs, deterministic = false) {
                const years = inputs.planningAge - inputs.retirementAge;
                const inflationMultiplier = 1 + inputs.inflationRate / 100;
                const baseMinSpending = inputs.minSpending || 0;
                const baseMaxSpending = inputs.maxSpending || 0;
                const baseStartingWithdrawal = inputs.startingWithdrawal || 0;

                let portfolio = inputs.startingPortfolio;
                const yearResults = [];
                let ruined = false;
                let ruinAge = null;

                for (let i = 0; i < years; i++) {
                    const age = inputs.retirementAge + i;
                    const portfolioStart = portfolio;
                    const inflationAdjustedMinSpending = baseMinSpending * Math.pow(inflationMultiplier, i);
                    const inflationAdjustedMaxSpending = baseMaxSpending > 0 ? baseMaxSpending * Math.pow(inflationMultiplier, i) : Infinity;
                    const inflationAdjustedStartingWithdrawal = baseStartingWithdrawal > 0 ? baseStartingWithdrawal * Math.pow(inflationMultiplier, i) : 0;

                    // One-time expense every 5 years (inflation-adjusted)
                    const isExpenseYear = ((i + 1) % 5 === 0);
                    const oneTimeExpenseThisYear = isExpenseYear ? inputs.oneTimeExpense * Math.pow(inflationMultiplier, i) : 0;

                    // Social Security with COLA adjustment
                    const ssYearsReceiving = Math.max(0, age - inputs.ssStartAge);
                    const ss = (age >= inputs.ssStartAge) ? inputs.socialSecurity * Math.pow(inflationMultiplier, ssYearsReceiving) : 0;

                    const lifeExp = this.lifeExpectancy(age);
                    const rmdWithdrawal = portfolio / lifeExp;
                    let targetWithdrawal = Math.max(rmdWithdrawal, inflationAdjustedMinSpending);
                    if (inflationAdjustedStartingWithdrawal > 0) {
                        targetWithdrawal = Math.max(targetWithdrawal, inflationAdjustedStartingWithdrawal);
                    }
                    // Apply max spending cap
                    targetWithdrawal = Math.min(targetWithdrawal, inflationAdjustedMaxSpending);
                    const netWithdrawal = Math.max(0, targetWithdrawal - ss) + oneTimeExpenseThisYear;

                    portfolio -= netWithdrawal;

                    if (portfolio < 0) {
                        portfolio = 0;
                        if (!ruined) {
                            ruined = true;
                            ruinAge = age;
                        }
                    }

                    const returnPct = this.generateReturn(inputs.expectedReturn, inputs.volatility, deterministic);
                    portfolio *= (1 + returnPct);

                    yearResults.push({
                        year: i,
                        age,
                        portfolioStart,
                        returnPct: returnPct * 100,
                        withdrawal: netWithdrawal,
                        portfolioEnd: portfolio,
                        ruined: portfolio <= 0
                    });

                    if (portfolio <= 0 && !ruined) {
                        ruined = true;
                        ruinAge = age;
                    }
                }

                return {
                    years: yearResults,
                    finalBalance: portfolio,
                    totalWithdrawals: yearResults.reduce((sum, y) => sum + y.withdrawal, 0),
                    ruined,
                    ruinAge
                };
            },

            /**
             * Runs Monte Carlo simulation for a given strategy
             * Executes thousands of scenarios with random returns
             */
            runStrategy(strategyName, inputs) {
                const strategyMap = {
                    'constant-real': this.strategyConstantReal,
                    'constant-pct': this.strategyConstantPercent,
                    'vpw': this.strategyVPW,
                    'guardrails': this.strategyGuardrails,
                    'rmd': this.strategyRMD
                };

                const strategy = strategyMap[strategyName];
                if (!strategy) throw new Error(`Unknown strategy: ${strategyName}`);

                const paths = [];

                // Run Monte Carlo simulations
                for (let i = 0; i < inputs.monteCarloRuns; i++) {
                    paths.push(strategy.call(this, inputs, false));
                }

                // Calculate aggregate statistics
                const successRate = (paths.filter(p => !p.ruined).length / paths.length) * 100;

                const finalBalances = paths.map(p => p.finalBalance).sort((a, b) => a - b);
                const totalWithdrawals = paths.map(p => p.totalWithdrawals).sort((a, b) => a - b);

                const medianFinal = this.percentile(finalBalances, 50);
                const p10Final = this.percentile(finalBalances, 10);
                const p75Final = this.percentile(finalBalances, 75);
                const p90Final = this.percentile(finalBalances, 90);
                const p95Final = this.percentile(finalBalances, 95);
                const medianWithdrawals = this.percentile(totalWithdrawals, 50);
                const p75Withdrawals = this.percentile(totalWithdrawals, 75);
                const p90Withdrawals = this.percentile(totalWithdrawals, 90);
                const p95Withdrawals = this.percentile(totalWithdrawals, 95);

                // Find the actual median path from Monte Carlo simulations
                // Sort paths by final balance and pick the one at the median position
                const sortedByFinal = [...paths].sort((a, b) => a.finalBalance - b.finalBalance);
                const medianIndex = Math.floor(sortedByFinal.length / 2);
                const medianPath = sortedByFinal[medianIndex].years;

                // Calculate percentile paths for probability cone
                const numYears = medianPath.length;
                const percentilePaths = {
                    p5: [],
                    p10: [],
                    p25: [],
                    p50: [],
                    p75: [],
                    p90: [],
                    p95: []
                };

                for (let yearIdx = 0; yearIdx < numYears; yearIdx++) {
                    const portfolioValues = paths.map(p => p.years[yearIdx]?.portfolioEnd || 0).sort((a, b) => a - b);
                    percentilePaths.p5.push(this.percentile(portfolioValues, 5));
                    percentilePaths.p10.push(this.percentile(portfolioValues, 10));
                    percentilePaths.p25.push(this.percentile(portfolioValues, 25));
                    percentilePaths.p50.push(this.percentile(portfolioValues, 50));
                    percentilePaths.p75.push(this.percentile(portfolioValues, 75));
                    percentilePaths.p90.push(this.percentile(portfolioValues, 90));
                    percentilePaths.p95.push(this.percentile(portfolioValues, 95));
                }

                return {
                    name: strategyName,
                    paths,
                    successRate,
                    medianFinal,
                    p10Final,
                    p75Final,
                    p90Final,
                    p95Final,
                    medianWithdrawals,
                    p75Withdrawals,
                    p90Withdrawals,
                    p95Withdrawals,
                    medianPath,
                    allFinalValues: finalBalances,  // Store all final values for histogram
                    percentilePaths  // Store percentile paths for probability cone
                };
            },

            /**
             * Calculates percentile from sorted array
             * Uses linear interpolation for precise values
             */
            percentile(sorted, p) {
                if (sorted.length === 0) return 0;
                const index = (p / 100) * (sorted.length - 1);
                const lower = Math.floor(index);
                const upper = Math.ceil(index);
                const weight = index - lower;
                return sorted[lower] * (1 - weight) + sorted[upper] * weight;
            }
        };

        // ============================================
        // CHARTS MODULE
        // Renders interactive canvas-based line charts showing portfolio and
        // withdrawal trajectories over time. Features:
        // - Hover tooltips showing exact values at each age
        // - Shaded probability cones (10th-90th percentile ranges)
        // - Theme-aware colors (adapts to light/dark mode)
        // - Currency formatting for dollar values
        // ============================================
        const Charts = {
            /**
             * Draws an interactive line chart with hover tooltips.
             * Supports multiple series (one per strategy) with shaded percentile bands.
             */
            drawLineChart(canvas, data, title) {
                const ctx = canvas.getContext('2d');
                const width = canvas.width;
                const height = canvas.height;

                const isDark = document.documentElement.classList.contains('dark');

                // Theme-aware colors
                const bgColor = isDark ? '#020617' : '#ffffff';
                const textColor = isDark ? '#e2e8f0' : '#1f2937';
                const gridColor = isDark ? '#1e293b' : '#e5e7eb';
                const lineColors = [
                    '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'
                ];

                ctx.fillStyle = bgColor;
                ctx.fillRect(0, 0, width, height);

                const margin = { top: 40, right: 150, bottom: 50, left: 80 };
                const chartWidth = width - margin.left - margin.right;
                const chartHeight = height - margin.top - margin.bottom;

                // Calculate data ranges
                const allYears = data.series[0].values.map((_, i) => i);
                const allValues = data.series.flatMap(s => s.values);
                const minValue = Math.min(0, ...allValues);
                const maxValue = Math.max(...allValues);
                const valueRange = maxValue - minValue;

                // Scaling functions
                const xScale = (year) => margin.left + (year / (allYears.length - 1)) * chartWidth;
                const yScale = (value) => margin.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;

                // Draw grid lines
                ctx.strokeStyle = gridColor;
                ctx.lineWidth = 1;
                const numGridLines = 5;
                for (let i = 0; i <= numGridLines; i++) {
                    const y = margin.top + (i / numGridLines) * chartHeight;
                    ctx.beginPath();
                    ctx.moveTo(margin.left, y);
                    ctx.lineTo(margin.left + chartWidth, y);
                    ctx.stroke();
                }

                // Draw axes
                ctx.strokeStyle = textColor;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(margin.left, margin.top);
                ctx.lineTo(margin.left, margin.top + chartHeight);
                ctx.lineTo(margin.left + chartWidth, margin.top + chartHeight);
                ctx.stroke();

                // Y-axis labels
                ctx.fillStyle = textColor;
                ctx.font = '12px system-ui';
                ctx.textAlign = 'right';
                for (let i = 0; i <= numGridLines; i++) {
                    const value = minValue + (i / numGridLines) * valueRange;
                    const y = margin.top + chartHeight - (i / numGridLines) * chartHeight;
                    ctx.fillText(this.formatCurrency(value, true), margin.left - 10, y + 4);
                }

                // X-axis labels
                ctx.textAlign = 'center';
                const numXLabels = 5;
                for (let i = 0; i <= numXLabels; i++) {
                    const yearIndex = Math.floor((i / numXLabels) * (allYears.length - 1));
                    const x = xScale(yearIndex);
                    const age = data.startAge + yearIndex;
                    ctx.fillText(age.toString(), x, margin.top + chartHeight + 25);
                }

                ctx.fillText('Age', margin.left + chartWidth / 2, height - 10);

                // Draw probability cone (percentile bands) if available
                data.series.forEach((series, idx) => {
                    if (series.percentilePaths) {
                        const color = lineColors[idx % lineColors.length];
                        const rgb = this.hexToRgb(color);

                        // Draw 10-90 percentile band (wider, lighter)
                        ctx.fillStyle = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.1)`;
                        ctx.beginPath();
                        // Draw top edge (p90)
                        series.percentilePaths.p90.forEach((value, i) => {
                            const x = xScale(i);
                            const y = yScale(value);
                            if (i === 0) ctx.moveTo(x, y);
                            else ctx.lineTo(x, y);
                        });
                        // Draw bottom edge backwards (p10)
                        for (let i = series.percentilePaths.p10.length - 1; i >= 0; i--) {
                            const x = xScale(i);
                            const y = yScale(series.percentilePaths.p10[i]);
                            ctx.lineTo(x, y);
                        }
                        ctx.closePath();
                        ctx.fill();

                        // Draw 25-75 percentile band (narrower, darker)
                        ctx.fillStyle = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.2)`;
                        ctx.beginPath();
                        // Draw top edge (p75)
                        series.percentilePaths.p75.forEach((value, i) => {
                            const x = xScale(i);
                            const y = yScale(value);
                            if (i === 0) ctx.moveTo(x, y);
                            else ctx.lineTo(x, y);
                        });
                        // Draw bottom edge backwards (p25)
                        for (let i = series.percentilePaths.p25.length - 1; i >= 0; i--) {
                            const x = xScale(i);
                            const y = yScale(series.percentilePaths.p25[i]);
                            ctx.lineTo(x, y);
                        }
                        ctx.closePath();
                        ctx.fill();
                    }
                });

                // Draw data lines
                data.series.forEach((series, idx) => {
                    ctx.strokeStyle = lineColors[idx % lineColors.length];
                    ctx.lineWidth = 3;
                    ctx.beginPath();

                    series.values.forEach((value, i) => {
                        const x = xScale(i);
                        const y = yScale(value);
                        if (i === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    });

                    ctx.stroke();
                });

                // Draw legend
                ctx.textAlign = 'left';
                data.series.forEach((series, idx) => {
                    const y = margin.top + 20 + idx * 20;
                    const x = margin.left + chartWidth + 10;

                    ctx.fillStyle = lineColors[idx % lineColors.length];
                    ctx.fillRect(x, y - 10, 15, 15);

                    ctx.fillStyle = textColor;
                    ctx.font = '11px system-ui';
                    ctx.fillText(series.label.substring(0, 25), x + 20, y + 2);
                });

                // Chart title
                ctx.font = 'bold 14px system-ui';
                ctx.textAlign = 'center';
                ctx.fillStyle = textColor;
                ctx.fillText(title, margin.left + chartWidth / 2, 20);

                // Store chart data for tooltip functionality
                canvas.chartData = {
                    data,
                    xScale,
                    yScale,
                    margin,
                    lineColors,
                    chartWidth,
                    chartHeight
                };

                // Add mousemove listener for interactive tooltips
                this.addChartTooltip(canvas);
            },

            /**
             * Adds interactive mouseover tooltip to chart
             * Shows year, age, and value on hover
             * Draws vertical line indicator at mouse position
             */
            addChartTooltip(canvas) {
                const tooltip = document.getElementById('chart-tooltip');

                // Store original chart as image data for redrawing
                if (!canvas.originalImageData) {
                    const ctx = canvas.getContext('2d');
                    canvas.originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                }

                canvas.addEventListener('mousemove', (e) => {
                    const rect = canvas.getBoundingClientRect();

                    // Scale mouse coordinates to match canvas internal resolution
                    const scaleX = canvas.width / rect.width;
                    const scaleY = canvas.height / rect.height;
                    const mouseX = (e.clientX - rect.left) * scaleX;
                    const mouseY = (e.clientY - rect.top) * scaleY;

                    const { data, xScale, yScale, margin, chartWidth, chartHeight, lineColors } = canvas.chartData;
                    const ctx = canvas.getContext('2d');

                    // Restore original chart (remove previous line)
                    ctx.putImageData(canvas.originalImageData, 0, 0);

                    // Check if mouse is within chart area
                    if (mouseX < margin.left || mouseX > margin.left + chartWidth ||
                        mouseY < margin.top || mouseY > margin.top + chartHeight) {
                        tooltip.classList.add('hidden');
                        return;
                    }

                    // Find nearest year index
                    const yearFraction = (mouseX - margin.left) / chartWidth;
                    const yearIndex = Math.round(yearFraction * (data.series[0].values.length - 1));

                    if (yearIndex < 0 || yearIndex >= data.series[0].values.length) {
                        tooltip.classList.add('hidden');
                        return;
                    }

                    // Calculate exact x position for the vertical line
                    const lineX = margin.left + yearIndex * (chartWidth / (data.series[0].values.length - 1));

                    // Draw vertical line indicator
                    const isDark = document.documentElement.classList.contains('dark');
                    ctx.strokeStyle = isDark ? 'rgba(226, 232, 240, 0.4)' : 'rgba(31, 41, 55, 0.4)';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(lineX, margin.top);
                    ctx.lineTo(lineX, margin.top + chartHeight);
                    ctx.stroke();
                    ctx.setLineDash([]); // Reset dash pattern

                    // Draw dots at intersection points
                    data.series.forEach((series, idx) => {
                        const value = series.values[yearIndex];
                        const yPos = yScale(value);
                        const color = lineColors[idx % lineColors.length];

                        ctx.fillStyle = color;
                        ctx.beginPath();
                        ctx.arc(lineX, yPos, 5, 0, 2 * Math.PI);
                        ctx.fill();
                        ctx.strokeStyle = isDark ? '#020617' : '#ffffff';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    });

                    // Build tooltip content
                    const age = data.startAge + yearIndex;
                    let tooltipHTML = `<div style="font-weight: bold; margin-bottom: 4px;">Age ${age}</div>`;

                    data.series.forEach((series, idx) => {
                        const value = series.values[yearIndex];
                        const color = lineColors[idx % lineColors.length];
                        tooltipHTML += `<div style="display: flex; align-items: center; gap: 6px; margin-bottom: 2px;">
                            <div style="width: 12px; height: 12px; background: ${color}; border-radius: 2px;"></div>
                            <span style="font-size: 11px;">${series.label.substring(0, 20)}: ${this.formatCurrency(value)}</span>
                        </div>`;
                    });

                    tooltip.innerHTML = tooltipHTML;
                    tooltip.classList.remove('hidden');
                    tooltip.style.left = (e.clientX + 15) + 'px';
                    tooltip.style.top = (e.clientY - 10) + 'px';
                });

                canvas.addEventListener('mouseleave', () => {
                    tooltip.classList.add('hidden');
                    // Restore original chart when mouse leaves
                    const ctx = canvas.getContext('2d');
                    ctx.putImageData(canvas.originalImageData, 0, 0);
                });
            },

            /**
             * Formats currency values for display
             * Uses compact notation (M/K) for large numbers
             */
            formatCurrency(value, compact = false) {
                if (compact && Math.abs(value) >= 1000) {
                    if (Math.abs(value) >= 1000000) {
                        return '$' + (value / 1000000).toFixed(1) + 'M';
                    }
                    return '$' + (value / 1000).toFixed(0) + 'K';
                }
                return '$' + value.toLocaleString('en-US', { maximumFractionDigits: 0 });
            },

            /**
             * Converts hex color to RGB object
             */
            hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : { r: 0, g: 0, b: 0 };
            }
        };

        // ============================================
        // REPORT GENERATION MODULE
        // Creates the narrative "Report" tab with:
        // - US retirement benchmarks for context
        // - Strategy-specific analysis and recommendations
        // - Risk assessment and personalized suggestions
        // - Historical backtesting context
        // ============================================
        const Report = {
            /**
             * Generates the full HTML report with analysis, benchmarks, and recommendations.
             * Called when displaying the Report tab after simulation completes.
             */
            generateReport(results, inputs) {
                const strategies = Object.values(results);

                // Calculate deflator for final values (end of retirement period)
                const years = inputs.planningAge - inputs.retirementAge;
                const inflationMultiplier = 1 + inputs.inflationRate / 100;
                const finalDeflator = Math.pow(inflationMultiplier, years - 1);

                let html = '<div class="space-y-8 animate-fade-in">';

                // US Retirement Portfolio Benchmarks
                html += '<div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-300 dark:border-blue-800 rounded-lg p-6">';
                html += '<h3 class="text-xl font-semibold text-white mb-4 flex items-center">';
                html += '<svg class="w-6 h-6 mr-2 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>';
                html += 'Your Portfolio vs. US Benchmarks';
                html += '</h3>';

                // US benchmark data (based on Vanguard 2023 "How America Saves" report and Federal Reserve SCF data)
                const usBenchmarks = {
                    median: 200000,      // Median retirement savings for Americans age 65+
                    percentile95: 1800000 // 95th percentile retirement savings
                };

                const userPortfolio = inputs.startingPortfolio;
                const medianMultiple = (userPortfolio / usBenchmarks.median).toFixed(1);
                const p95Multiple = (userPortfolio / usBenchmarks.percentile95).toFixed(2);

                html += '<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">';

                // Your Portfolio
                html += '<div class="bg-[#1c1c1e] rounded-lg p-4 border-2 border-primary-500">';
                html += '<div class="text-xs font-medium text-[#636366] uppercase mb-1">Your Starting Portfolio</div>';
                html += `<div class="text-2xl font-bold text-white">${Charts.formatCurrency(userPortfolio)}</div>`;
                html += '</div>';

                // US Median
                html += '<div class="bg-[#1c1c1e] rounded-lg p-4 border border-[#3a3a3c]">';
                html += '<div class="text-xs font-medium text-[#636366] uppercase mb-1">US Median (Age 65+)</div>';
                html += `<div class="text-2xl font-bold text-white">${Charts.formatCurrency(usBenchmarks.median)}</div>`;
                html += `<div class="text-xs text-[#636366] mt-1">You: <strong>${medianMultiple}x</strong> median</div>`;
                html += '</div>';

                // US 95th Percentile
                html += '<div class="bg-[#1c1c1e] rounded-lg p-4 border border-[#3a3a3c]">';
                html += '<div class="text-xs font-medium text-[#636366] uppercase mb-1">US 95th Percentile</div>';
                html += `<div class="text-2xl font-bold text-white">${Charts.formatCurrency(usBenchmarks.percentile95)}</div>`;
                html += `<div class="text-xs text-[#636366] mt-1">You: <strong>${p95Multiple}x</strong> top 5%</div>`;
                html += '</div>';

                html += '</div>';

                // Percentile estimate
                let percentileMessage = '';
                if (userPortfolio >= usBenchmarks.percentile95) {
                    percentileMessage = `Your starting portfolio of ${Charts.formatCurrency(userPortfolio)} places you in the <strong>top 5% of American retirees</strong>. This provides exceptional flexibility in retirement planning.`;
                } else if (userPortfolio >= usBenchmarks.median) {
                    const percentile = Math.min(95, 50 + ((userPortfolio - usBenchmarks.median) / (usBenchmarks.percentile95 - usBenchmarks.median) * 45));
                    percentileMessage = `Your starting portfolio of ${Charts.formatCurrency(userPortfolio)} places you in approximately the <strong>top ${(100 - percentile).toFixed(0)}% of American retirees</strong>, well above the median.`;
                } else {
                    percentileMessage = `Your starting portfolio of ${Charts.formatCurrency(userPortfolio)} is below the median for Americans age 65+. Consider maximizing your savings and delaying retirement if possible.`;
                }

                html += `<p class="text-sm text-[#e5e5e7]">${percentileMessage}</p>`;
                html += '<p class="text-xs text-[#636366] mt-3"><em>Source: Federal Reserve Survey of Consumer Finances (2022) and Vanguard "How America Saves" (2023). Benchmarks represent total retirement account balances for households age 65+.</em></p>';
                html += '</div>';

                // Executive Summary
                html += '<div>';
                html += '<h3 class="text-xl font-semibold text-white mb-4">Executive Summary</h3>';
                html += '<ul class="space-y-2 text-[#e5e5e7]">';

                const bestSuccess = strategies.reduce((max, s) => s.successRate > max.successRate ? s : max);
                const bestWealth = strategies.reduce((max, s) => s.medianFinal > max.medianFinal ? s : max);
                const bestIncome = strategies.reduce((max, s) => s.medianWithdrawals > max.medianWithdrawals ? s : max);

                html += `<li>For <strong>highest success rate</strong> (${bestSuccess.successRate.toFixed(1)}%): <span class="inline-block px-3 py-1 bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300 rounded-lg font-semibold">${this.strategyDisplayName(bestSuccess.name)}</span></li>`;
                html += `<li>For <strong>maximum legacy wealth</strong> (median ${Charts.formatCurrency(bestWealth.medianFinal / finalDeflator)}): <span class="inline-block px-3 py-1 bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300 rounded-lg font-semibold">${this.strategyDisplayName(bestWealth.name)}</span></li>`;
                html += `<li>For <strong>maximum lifetime spending</strong> (${Charts.formatCurrency(bestIncome.medianWithdrawals)}): <span class="inline-block px-3 py-1 bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300 rounded-lg font-semibold">${this.strategyDisplayName(bestIncome.name)}</span></li>`;
                html += '</ul>';

                html += '<h4 class="text-lg font-semibold text-white mt-6 mb-3">Recommendation Based on Your Target Success Rate</h4>';
                html += this.getSuccessRateRecommendation(strategies, inputs.targetSuccessRate);

                html += '</div>';

                // Strategy Details
                html += '<div>';
                html += '<h3 class="text-xl font-semibold text-white mb-4">Strategy Analysis</h3>';
                html += '<div class="space-y-6">';

                strategies.forEach(strategy => {
                    html += this.strategyNarrative(strategy, inputs);
                });

                html += '</div></div>';

                // Risk & Sensitivity
                html += '<div>';
                html += '<h3 class="text-xl font-semibold text-white mb-4">Important Considerations</h3>';
                html += '<p class="text-[#e5e5e7] mb-3">These simulations are based on your assumptions about future market returns, volatility, and inflation. Actual results will vary based on:</p>';
                html += '<ul class="space-y-2 text-[#e5e5e7] list-disc list-inside">';
                html += '<li><strong>Sequence of returns risk:</strong> Poor returns early in retirement can significantly impact outcomes</li>';
                html += '<li><strong>Inflation variability:</strong> Higher-than-expected inflation reduces purchasing power</li>';
                html += '<li><strong>Longevity:</strong> Living longer than planned increases the risk of running out of money</li>';
                html += '<li><strong>Healthcare and unexpected expenses:</strong> Major costs can derail even well-planned strategies</li>';
                html += '</ul>';
                html += '<div class="mt-4 p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-300 dark:border-yellow-800 rounded-lg">';
                html += '<p class="text-sm text-yellow-900 dark:text-yellow-200"><strong>Disclaimer:</strong> This tool is for educational and informational purposes only. It does not constitute financial advice. Consult with a qualified financial advisor before making retirement decisions.</p>';
                html += '</div>';
                html += '</div>';

                html += '</div>';

                return html;
            },

            strategyDisplayName(name) {
                const map = {
                    'constant-real': 'Constant Real (4% Rule)',
                    'constant-pct': 'Constant % of Portfolio',
                    'vpw': 'Variable % (VPW)',
                    'guardrails': 'Guardrails',
                    'rmd': 'RMD / Life Expectancy'
                };
                return map[name] || name;
            },

            strategyNarrative(strategy, inputs) {
                // Calculate deflator for final values
                const years = inputs.planningAge - inputs.retirementAge;
                const inflationMultiplier = 1 + inputs.inflationRate / 100;
                const finalDeflator = Math.pow(inflationMultiplier, years - 1);

                let html = '<div class="border border-[#38383a] rounded-lg p-4 bg-black">';

                // Strategy name with info tooltip
                const tooltips = {
                    'constant-real': '<strong>Classic 4% Rule:</strong> Withdraw a fixed percentage (typically 4-4.5%) of your starting portfolio in year one, then adjust that dollar amount for inflation each year. <br><br><strong>Pros:</strong> Predictable, stable income. <br><strong>Cons:</strong> Doesn\'t adapt to market performance; can deplete portfolio in bad sequences.',
                    'constant-pct': '<strong>Dynamic Percentage:</strong> Withdraw a fixed percentage (e.g., 4%) of your current portfolio value each year. <br><br><strong>Pros:</strong> Theoretically never runs out; adapts to markets. <br><strong>Cons:</strong> Income varies significantly year-to-year; belt-tightening in bad years.',
                    'vpw': '<strong>VPW Method:</strong> Withdrawal percentage increases as you age based on remaining life expectancy and asset allocation. <br><br><strong>Pros:</strong> Balances longevity protection with lifestyle. <br><strong>Cons:</strong> More complex; requires periodic recalculation.',
                    'guardrails': '<strong>Guyton-Klinger Guardrails:</strong> Starts with initial withdrawal rate but adjusts spending when withdrawal rate crosses preset upper/lower thresholds. <br><br><strong>Pros:</strong> Balances stability with flexibility. <br><strong>Cons:</strong> May require lifestyle adjustments when guardrails are triggered.',
                    'rmd': '<strong>IRS RMD Table Method:</strong> Divides current portfolio by IRS life expectancy table. Same method used for Required Minimum Distributions. <br><br><strong>Pros:</strong> Guaranteed to last lifetime mathematically. <br><strong>Cons:</strong> Highly volatile income; can be very low in market downturns.'
                };

                html += `<h4 class="text-lg font-semibold text-white mb-2 flex items-center">
                    ${this.strategyDisplayName(strategy.name)}
                    <span class="tooltip ml-2">
                        <span class="info-icon">i</span>
                        <span class="tooltiptext">${tooltips[strategy.name]}</span>
                    </span>
                </h4>`;

                const descriptions = {
                    'constant-real': 'Withdraws a fixed percentage of your starting portfolio in year one, then adjusts for inflation annually. Predictable income but doesn\'t respond to market changes.',
                    'constant-pct': 'Withdraws a fixed percentage of current portfolio value each year. Self-adjusting but creates volatile income.',
                    'vpw': 'Adjusts withdrawal percentage based on remaining life expectancy. Withdrawals increase with age while protecting against longevity risk.',
                    'guardrails': 'Starts with initial rate but adjusts spending when withdrawal rate crosses preset thresholds. Balances stability with market responsiveness.',
                    'rmd': 'Divides portfolio by remaining life expectancy each year. Guarantees portfolio lasts lifetime but creates volatile income.'
                };
                html += `<p class="text-[#e5e5e7] mb-3 text-sm">${descriptions[strategy.name]}</p>`;

                html += '<div class="grid grid-cols-2 gap-2 text-xs text-[#e5e5e7] mb-2">';
                html += `<div>Success Rate: <strong>${strategy.successRate.toFixed(1)}%</strong> ${this.successBadge(strategy.successRate)}</div>`;
                html += `<div>Median Final: <strong>${Charts.formatCurrency(strategy.medianFinal / finalDeflator)}</strong></div>`;
                html += `<div>10th Percentile: <strong>${Charts.formatCurrency(strategy.p10Final / finalDeflator)}</strong></div>`;
                html += `<div>Total Withdrawals: <strong>${Charts.formatCurrency(strategy.medianWithdrawals)}</strong></div>`;
                html += '</div>';

                // Progress bar
                html += `<div class="w-full bg-gray-200 dark:bg-slate-800 rounded-full h-2 overflow-hidden mt-2">
                    <div class="progress-bar-animated bg-gradient-to-r from-primary-500 to-primary-600 h-2 rounded-full" style="width: ${strategy.successRate}%"></div>
                </div>`;

                html += '</div>';
                return html;
            },

            successBadge(rate) {
                if (rate >= 95) return '<span class="inline-block px-1.5 py-0.5 text-xs font-semibold rounded bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300">Excellent</span>';
                if (rate >= 85) return '<span class="inline-block px-1.5 py-0.5 text-xs font-semibold rounded bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300">Good</span>';
                return '<span class="inline-block px-1.5 py-0.5 text-xs font-semibold rounded bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300">Risky</span>';
            },

            getSuccessRateRecommendation(strategies, targetRate) {
                let html = '<p class="text-[#e5e5e7]">';

                const qualifying = strategies.filter(s => s.successRate >= targetRate);

                if (qualifying.length === 0) {
                    html += `<strong class="text-red-700 dark:text-red-400">Warning:</strong> None of the strategies meet your target success rate of ${targetRate}%. `;
                    html += 'Consider reducing withdrawal amounts, increasing portfolio value, or accepting a lower success rate target.';
                } else {
                    const best = qualifying.reduce((max, s) => s.medianWithdrawals > max.medianWithdrawals ? s : max);
                    html += `Given your target success rate of <strong>${targetRate}%</strong>, we recommend `;
                    html += `<span class="inline-block px-3 py-1 bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300 rounded-lg font-semibold">${this.strategyDisplayName(best.name)}</span> `;
                    html += `which achieves a ${best.successRate.toFixed(1)}% success rate with lifetime withdrawals of ${Charts.formatCurrency(best.medianWithdrawals)}.`;
                }

                html += '</p>';
                return html;
            }
        };

        // ============================================
        // UI MODULE
        // Handles all user interaction and display logic:
        // - Collects form inputs and validates them
        // - Triggers simulation runs and displays results
        // - Manages tab switching between Summary/Charts/Tables/Report
        // - Handles dark/light theme toggling
        // - Shows status messages and loading states
        // ============================================
        const UI = {
            /**
             * Reads all form inputs and returns them as a structured object.
             * Handles number parsing and defaults for optional fields.
             */
            getInputs() {
                const selectedStrategies = [];
                if (document.getElementById('strategy-constant-real').checked) selectedStrategies.push('constant-real');
                if (document.getElementById('strategy-constant-pct').checked) selectedStrategies.push('constant-pct');
                if (document.getElementById('strategy-vpw').checked) selectedStrategies.push('vpw');
                if (document.getElementById('strategy-guardrails').checked) selectedStrategies.push('guardrails');
                if (document.getElementById('strategy-rmd').checked) selectedStrategies.push('rmd');

                return {
                    retirementAge: parseInt(document.getElementById('retirement-age').value),
                    planningAge: parseInt(document.getElementById('planning-age').value),
                    startingPortfolio: parseFormattedNumber(document.getElementById('starting-portfolio').value),
                    startingWithdrawal: parseFormattedNumber(document.getElementById('starting-withdrawal').value),
                    expectedReturn: parseFloat(document.getElementById('expected-return').value.replace(/,/g, '')),
                    volatility: parseFloat(document.getElementById('volatility').value.replace(/,/g, '')),
                    inflationRate: parseFloat(document.getElementById('inflation-rate').value.replace(/,/g, '')),
                    monteCarloRuns: parseInt(parseFormattedNumber(document.getElementById('monte-carlo-runs').value)),
                    minSpending: parseFormattedNumber(document.getElementById('min-spending').value),
                    maxSpending: parseFormattedNumber(document.getElementById('max-spending').value),
                    oneTimeExpense: parseFormattedNumber(document.getElementById('one-time-expense').value),
                    socialSecurity: parseFormattedNumber(document.getElementById('social-security').value),
                    ssStartAge: parseInt(document.getElementById('ss-start-age').value),
                    targetSuccessRate: parseInt(document.getElementById('risk-tolerance').value),
                    strategies: selectedStrategies
                };
            },

            /**
             * Shows status message to user
             * @param {string} message
             * @param {string} type - 'info', 'success', or 'error'
             */
            showStatus(message, type = 'info') {
                const statusEl = document.getElementById('status-message');
                const colorClasses = {
                    info: 'bg-blue-50 dark:bg-blue-900/20 border-blue-300 dark:border-blue-800 text-blue-900 dark:text-blue-200',
                    success: 'bg-green-50 dark:bg-green-900/20 border-green-300 dark:border-green-800 text-green-900 dark:text-green-200',
                    error: 'bg-red-50 dark:bg-red-900/20 border-red-300 dark:border-red-800 text-red-900 dark:text-red-200'
                };
                statusEl.className = `p-4 rounded-lg border ${colorClasses[type]} animate-slide-up text-center max-w-2xl mx-auto`;
                statusEl.innerHTML = message;
                statusEl.classList.remove('hidden');
            },

            hideStatus() {
                document.getElementById('status-message').classList.add('hidden');
            },

            /**
             * Main simulation execution function
             * Runs Monte Carlo analysis and updates UI
             */
            async runSimulation() {
                const inputs = this.getInputs();

                // Input validation
                if (inputs.strategies.length === 0) {
                    this.showStatus('Please select at least one withdrawal strategy.', 'error');
                    return;
                }

                if (inputs.planningAge <= inputs.retirementAge) {
                    this.showStatus('Planning age must be after retirement age.', 'error');
                    return;
                }

                const btn = document.getElementById('run-simulation');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<svg class="inline w-5 h-5 mr-2 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Running simulations...';
                this.hideStatus();

                // Small delay to allow UI to update
                await new Promise(resolve => setTimeout(resolve, 100));

                try {
                    // Run simulations for each selected strategy
                    const results = {};
                    for (const strategyName of inputs.strategies) {
                        results[strategyName] = Simulation.runStrategy(strategyName, inputs);
                    }

                    // Store globally for tab switching
                    globalResults = results;
                    globalInputs = inputs;

                    // Hide assumptions panel and show results
                    document.getElementById('assumptions-panel').classList.add('hidden');
                    document.getElementById('results-panel').classList.remove('hidden');
                    document.getElementById('back-to-assumptions').classList.remove('hidden');

                    // Display results in all tabs
                    this.displayResults(results, inputs);

                    this.showStatus('‚úì Simulation completed successfully!', 'success');
                    setTimeout(() => this.hideStatus(), 3000);

                } catch (error) {
                    console.error('Simulation error:', error);
                    this.showStatus('Error running simulation. Please check your inputs.', 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            },

            /**
             * Populates all results tabs with simulation data
             */
            displayResults(results, inputs) {
                this.displaySummary(results, inputs);
                this.displayCharts(results, inputs);
                this.displayDetailedTables(results, inputs);
                this.displayReport(results, inputs);
                this.displayAssumptions(inputs);

                // Trigger celebration for good outcomes
                const bestSuccessRate = Math.max(...Object.values(results).map(r => r.successRate));
                setTimeout(() => {
                    CelebrationEffects.celebrateIfWarranted(bestSuccessRate, inputs.targetSuccessRate);
                }, 500);
            },

            /**
             * Summary tab: Quick comparison table
             */
            displaySummary(results, inputs) {
                const strategies = Object.values(results);

                // Calculate deflator for final values (end of retirement period)
                const years = inputs.planningAge - inputs.retirementAge;
                const inflationMultiplier = 1 + inputs.inflationRate / 100;
                const finalDeflator = Math.pow(inflationMultiplier, years - 1); // Deflate final year values

                let html = '<div class="space-y-6 animate-fade-in">';

                // Key Insights Panel
                const insights = InsightsGenerator.generate(results, inputs);
                html += InsightsGenerator.display(insights);

                // Success Rate Gauges
                html += '<div>';
                html += '<h3 class="text-xl font-semibold text-white mb-4">Success Rates</h3>';
                html += '<div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">';
                strategies.forEach((strategy, index) => {
                    html += `<div class="bg-[#1c1c1e] rounded-lg border border-[#38383a] p-4 stagger-item hover-lift" style="animation-delay: ${index * 0.1}s">
                        <h4 class="text-sm font-medium text-[#98989d] mb-2 text-center">${Report.strategyDisplayName(strategy.name)}</h4>
                        ${SuccessRateGauge.render(strategy.successRate, inputs.targetSuccessRate)}
                    </div>`;
                });
                html += '</div>';
                html += '</div>';

                html += '<div>';
                html += '<h3 class="text-xl font-semibold text-white mb-3">Simulation Results</h3>';
                html += `<p class="text-[#e5e5e7]">Analyzed <strong>${inputs.monteCarloRuns.toLocaleString()}</strong> scenarios for each strategy over <strong>${inputs.planningAge - inputs.retirementAge} years</strong> (ages ${inputs.retirementAge}-${inputs.planningAge}).</p>`;
                html += '</div>';

                html += '<div>';
                html += '<h4 class="text-lg font-semibold text-white mb-1">Quick Comparison</h4>';
                html += '<p class="text-xs text-[#636366] mb-3">All dollar amounts are in today\'s dollars (inflation-adjusted)</p>';
                html += '<div class="overflow-x-auto rounded-lg border border-[#38383a]">';
                html += '<table class="min-w-full divide-y divide-[#38383a]">';
                html += '<thead class="bg-black">';
                html += '<tr>';
                html += '<th class="px-4 py-3 text-left text-xs font-medium text-[#98989d] uppercase">Strategy</th>';
                html += '<th class="px-4 py-3 text-left text-xs font-medium text-[#98989d] uppercase">Success Rate</th>';
                html += '<th class="px-4 py-3 text-left text-xs font-medium text-[#98989d] uppercase">Median Final</th>';
                html += '<th class="px-4 py-3 text-left text-xs font-medium text-[#98989d] uppercase">75th %ile Final</th>';
                html += '<th class="px-4 py-3 text-left text-xs font-medium text-[#98989d] uppercase">90th %ile Final</th>';
                html += '<th class="px-4 py-3 text-left text-xs font-medium text-[#98989d] uppercase">95th %ile Final</th>';
                html += '</tr>';
                html += '</thead>';
                html += '<tbody class="bg-[#1c1c1e] divide-y divide-[#38383a]">';

                strategies.forEach((s, index) => {
                    html += `<tr class="hover:bg-[#2c2c2e] stagger-item" style="animation-delay: ${0.3 + index * 0.08}s">`;
                    html += `<td class="px-4 py-3 text-sm font-medium text-white">${Report.strategyDisplayName(s.name)}</td>`;
                    html += `<td class="px-4 py-3 text-sm">
                        <div class="flex items-center gap-2 mb-1">
                            ${Report.successBadge(s.successRate)}
                            <span class="text-white font-medium">${s.successRate.toFixed(1)}%</span>
                        </div>
                        <div class="w-32 bg-gray-200 dark:bg-slate-800 rounded-full h-1.5">
                            <div class="progress-bar-animated bg-gradient-to-r from-primary-500 to-primary-600 h-1.5 rounded-full" style="width: ${s.successRate}%"></div>
                        </div>
                    </td>`;
                    html += `<td class="px-4 py-3 text-sm font-mono text-[#e5e5e7]">${Charts.formatCurrency(s.medianFinal / finalDeflator)}</td>`;
                    html += `<td class="px-4 py-3 text-sm font-mono text-[#e5e5e7]">${Charts.formatCurrency(s.p75Final / finalDeflator)}</td>`;
                    html += `<td class="px-4 py-3 text-sm font-mono text-[#e5e5e7]">${Charts.formatCurrency(s.p90Final / finalDeflator)}</td>`;
                    html += `<td class="px-4 py-3 text-sm font-mono text-[#e5e5e7]">${Charts.formatCurrency(s.p95Final / finalDeflator)}</td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                html += '</div>';
                html += '<p class="text-xs text-[#636366] mt-2">Success rate = percentage of scenarios where portfolio lasted the full planning period</p>';
                html += '</div>';
                html += '</div>';

                document.getElementById('tab-summary').innerHTML = html;
            },

            /**
             * Charts tab: Interactive visualizations
             */
            displayCharts(results, inputs) {
                const strategies = Object.values(results);

                let html = '<div class="space-y-8">';

                // Portfolio chart
                html += '<div class="animate-fade-in">';
                html += '<h3 class="text-lg font-semibold text-white mb-4">Portfolio Value Over Time <span class="text-sm font-normal text-[#636366]">(Today\'s Dollars ¬∑ Shaded regions show 10th-90th percentile range)</span></h3>';
                html += '<div class="bg-black rounded-lg p-4 border border-[#38383a]">';
                html += '<canvas id="chart-portfolio" class="chart-animated" width="1600" height="600"></canvas>';
                html += '</div>';
                html += '<p class="text-xs text-[#636366] mt-2">Hover over the chart to see detailed values for each year. Darker shaded region = 25th-75th percentile, lighter = 10th-90th percentile.</p>';
                html += '</div>';

                // Withdrawals chart
                html += '<div class="animate-fade-in">';
                html += '<h3 class="text-lg font-semibold text-white mb-4">Annual Withdrawals Over Time <span class="text-sm font-normal text-[#636366]">(Today\'s Dollars)</span></h3>';
                html += '<div class="bg-black rounded-lg p-4 border border-[#38383a]">';
                html += '<canvas id="chart-withdrawals" class="chart-animated" width="1600" height="600"></canvas>';
                html += '</div>';
                html += '<p class="text-xs text-[#636366] mt-2">Hover over the chart to see detailed withdrawal amounts for each year</p>';
                html += '</div>';

                // Distribution Histograms
                html += '<div class="animate-fade-in mt-8">';
                html += '<h3 class="text-lg font-semibold text-white mb-4">Outcome Distributions</h3>';
                html += '<p class="text-sm text-[#98989d] mb-4">Distribution of final portfolio values across all Monte Carlo simulations. Red bars indicate portfolio depletion.</p>';

                strategies.forEach(strategy => {
                    html += `<div class="mb-8 bg-black rounded-lg p-4 border border-[#38383a]">`;
                    html += `<h4 class="text-md font-semibold text-white mb-3">${Report.strategyDisplayName(strategy.name)}</h4>`;
                    html += `<div id="histogram-${strategy.name}"></div>`;
                    html += '</div>';
                });

                html += '</div>';

                html += '</div>';

                document.getElementById('tab-charts').innerHTML = html;

                // Wait for DOM update, then draw charts
                setTimeout(() => {
                    // Deflate nominal values to today's dollars for display
                    const inflationMultiplier = 1 + inputs.inflationRate / 100;
                    const deflate = (values) => values.map((v, idx) => v / Math.pow(inflationMultiplier, idx));
                    const deflatePercentilePaths = (paths) => ({
                        p10: deflate(paths.p10),
                        p25: deflate(paths.p25),
                        p50: deflate(paths.p50),
                        p75: deflate(paths.p75),
                        p90: deflate(paths.p90),
                        p95: deflate(paths.p95)
                    });

                    const portfolioData = {
                        startAge: inputs.retirementAge,
                        series: strategies.map(s => ({
                            label: Report.strategyDisplayName(s.name),
                            values: deflate(s.medianPath.map(y => y.portfolioEnd)),
                            percentilePaths: deflatePercentilePaths(s.percentilePaths)
                        }))
                    };

                    const withdrawalData = {
                        startAge: inputs.retirementAge,
                        series: strategies.map(s => ({
                            label: Report.strategyDisplayName(s.name),
                            values: deflate(s.medianPath.map(y => y.withdrawal))
                            // No percentile paths for withdrawals chart (less useful)
                        }))
                    };

                    Charts.drawLineChart(document.getElementById('chart-portfolio'), portfolioData, 'Portfolio Value (Median Path)');
                    Charts.drawLineChart(document.getElementById('chart-withdrawals'), withdrawalData, 'Annual Withdrawals (Median Path)');

                    // Draw histograms using ApexCharts
                    DistributionHistogram.destroyAll(); // Clean up previous charts
                    strategies.forEach(strategy => {
                        const histogramContainer = document.getElementById(`histogram-${strategy.name}`);
                        if (histogramContainer) {
                            histogramContainer.innerHTML = DistributionHistogram.render(results, strategy.name);
                            // Render ApexChart after container is in DOM
                            setTimeout(() => {
                                DistributionHistogram.renderApexChart(results, strategy.name, inputs);
                            }, 50);
                        }
                    });
                }, 100);
            },

            /**
             * Detailed Tables tab: Year-by-year breakdown for each strategy
             */
            displayDetailedTables(results, inputs) {
                const strategies = Object.values(results);
                // Calculate percentiles based on target success rate
                // Poor = lower percentile (worse outcomes), Good = higher percentile (better outcomes)
                const rawPoor = 100 - inputs.targetSuccessRate;
                const rawGood = inputs.targetSuccessRate;
                const poorPercentile = Math.min(rawPoor, rawGood);
                const goodPercentile = Math.max(rawPoor, rawGood);

                let html = '<div class="space-y-8">';

                html += '<h3 class="text-xl font-semibold text-white mb-2">Year-by-Year Details</h3>';
                html += '<p class="text-[#e5e5e7] mb-2">Detailed breakdown showing portfolio value and withdrawals for each year of retirement under each strategy.</p>';
                html += '<p class="text-xs text-[#636366] mb-2 font-medium">All dollar amounts are in today\'s dollars (inflation-adjusted to maintain purchasing power)</p>';
                html += `<p class="text-xs text-[#636366] mb-6"><span class="text-red-600 dark:text-red-400 font-medium">${poorPercentile}th %ile (Poor)</span> = worst ${poorPercentile}% of outcomes ¬∑ <span class="font-medium">Median</span> = typical outcome ¬∑ <span class="text-green-600 dark:text-green-400 font-medium">${goodPercentile}th %ile (Good)</span> = best ${100 - goodPercentile}% of outcomes</p>`;

                strategies.forEach(strategy => {
                    html += `<div class="border border-[#38383a] rounded-lg p-4 bg-black">`;
                    html += `<h4 class="text-lg font-semibold text-white mb-3">${Report.strategyDisplayName(strategy.name)}</h4>`;

                    html += '<div class="overflow-x-auto rounded-lg border border-[#38383a] mb-2">';
                    html += '<table class="min-w-full divide-y divide-[#38383a] text-xs">';
                    html += '<thead class="bg-[#1c1c1e]">';
                    html += '<tr>';
                    html += '<th class="px-3 py-2 text-left text-xs font-medium text-[#98989d] uppercase">Year</th>';
                    html += '<th class="px-3 py-2 text-left text-xs font-medium text-[#98989d] uppercase">Age</th>';
                    html += '<th class="px-3 py-2 text-right text-xs font-medium text-[#98989d] uppercase">Portfolio Start</th>';
                    html += '<th class="px-3 py-2 text-right text-xs font-medium text-[#98989d] uppercase">Return %</th>';
                    html += '<th class="px-3 py-2 text-right text-xs font-medium text-[#98989d] uppercase">Annual Withdrawal</th>';
                    html += '<th class="px-3 py-2 text-right text-xs font-medium text-[#98989d] uppercase">Monthly Withdrawal</th>';
                    html += `<th class="px-3 py-2 text-right text-xs font-medium text-red-700 dark:text-red-400 uppercase">${poorPercentile}th %ile (Poor)</th>`;
                    html += '<th class="px-3 py-2 text-right text-xs font-medium text-[#98989d] uppercase">Portfolio End (Median)</th>';
                    html += `<th class="px-3 py-2 text-right text-xs font-medium text-green-700 dark:text-green-400 uppercase">${goodPercentile}th %ile (Good)</th>`;
                    html += '</tr>';
                    html += '</thead>';
                    html += '<tbody class="bg-[#1c1c1e] divide-y divide-[#38383a]">';

                    // Show all years - deflate nominal values to today's dollars
                    const years = strategy.medianPath;
                    const inflationMultiplier = 1 + inputs.inflationRate / 100;

                    // Get the correct percentile paths based on target success rate
                    const poorKey = 'p' + poorPercentile;
                    const goodKey = 'p' + goodPercentile;
                    const poorPath = strategy.percentilePaths[poorKey] || strategy.percentilePaths.p10;
                    const goodPath = strategy.percentilePaths[goodKey] || strategy.percentilePaths.p90;

                    years.forEach((year, idx) => {
                        // Deflate nominal values back to today's purchasing power
                        const deflator = Math.pow(inflationMultiplier, idx);
                        const realPortfolioStart = year.portfolioStart / deflator;
                        const realWithdrawal = year.withdrawal / deflator;
                        const realMonthlyWithdrawal = realWithdrawal / 12;
                        const realPortfolioEnd = year.portfolioEnd / deflator;
                        const realPoorEnd = (poorPath[idx] || 0) / deflator;
                        const realGoodEnd = (goodPath[idx] || 0) / deflator;

                        // Highlight poor outcomes in red
                        const poorClass = realPoorEnd === 0 ? 'text-red-600 dark:text-red-400 font-semibold' : 'text-[#e5e5e7]';

                        html += '<tr class="hover:bg-[#2c2c2e]">';
                        html += `<td class="px-3 py-2 text-white">${year.year + 1}</td>`;
                        html += `<td class="px-3 py-2 text-white">${year.age}</td>`;
                        html += `<td class="px-3 py-2 text-right font-mono text-[#e5e5e7]">${Charts.formatCurrency(realPortfolioStart)}</td>`;
                        html += `<td class="px-3 py-2 text-right font-mono text-[#e5e5e7]">${year.returnPct.toFixed(2)}%</td>`;
                        html += `<td class="px-3 py-2 text-right font-mono text-[#e5e5e7]">${Charts.formatCurrency(realWithdrawal)}</td>`;
                        html += `<td class="px-3 py-2 text-right font-mono text-[#e5e5e7]">${Charts.formatCurrency(realMonthlyWithdrawal)}</td>`;
                        html += `<td class="px-3 py-2 text-right font-mono ${poorClass}">${Charts.formatCurrency(realPoorEnd)}</td>`;
                        html += `<td class="px-3 py-2 text-right font-mono text-[#e5e5e7] font-semibold">${Charts.formatCurrency(realPortfolioEnd)}</td>`;
                        html += `<td class="px-3 py-2 text-right font-mono text-green-700 dark:text-green-400">${Charts.formatCurrency(realGoodEnd)}</td>`;
                        html += '</tr>';
                    });

                    html += '</tbody></table>';
                    html += '</div>';
                    html += '<p class="text-xs text-[#636366]">Complete year-by-year breakdown for entire retirement period. Monthly withdrawal = Annual / 12.</p>';
                    html += '</div>';
                });

                html += '</div>';

                document.getElementById('tab-tables').innerHTML = html;
            },

            /**
             * Report tab: Narrative analysis and recommendations
             */
            displayReport(results, inputs) {
                let html = Report.generateReport(results, inputs);

                // Add historical backtesting section
                html += '<div class="page-break"></div>';
                html += HistoricalBacktesting.generateReport(results, inputs);

                document.getElementById('tab-report').innerHTML = html;
            },

            /**
             * Assumptions tab: Shows all input parameters
             */
            displayAssumptions(inputs) {
                let html = '<div class="space-y-6">';
                html += '<h3 class="text-xl font-semibold text-white mb-4">Current Assumptions</h3>';

                html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">';

                // Plan Setup
                html += '<div class="border border-[#38383a] rounded-lg p-4 bg-black">';
                html += '<h4 class="font-semibold text-white mb-3">Plan Setup</h4>';
                html += '<div class="space-y-2 text-sm text-[#e5e5e7]">';
                html += `<div><span class="font-medium">Retirement Age:</span> ${inputs.retirementAge}</div>`;
                html += `<div><span class="font-medium">Planning Horizon:</span> ${inputs.planningAge}</div>`;
                html += `<div><span class="font-medium">Starting Portfolio:</span> ${Charts.formatCurrency(inputs.startingPortfolio)}</div>`;
                html += `<div><span class="font-medium">Starting Withdrawal:</span> ${inputs.startingWithdrawal > 0 ? Charts.formatCurrency(inputs.startingWithdrawal) + '/year' : 'Use strategy default'}</div>`;
                html += `<div><span class="font-medium">Years in Retirement:</span> ${inputs.planningAge - inputs.retirementAge}</div>`;
                html += '</div>';
                html += '</div>';

                // Market Assumptions
                html += '<div class="border border-[#38383a] rounded-lg p-4 bg-black">';
                html += '<h4 class="font-semibold text-white mb-3">Market Assumptions</h4>';
                html += '<div class="space-y-2 text-sm text-[#e5e5e7]">';
                html += `<div><span class="font-medium">Expected Real Return:</span> ${inputs.expectedReturn.toFixed(1)}% per year</div>`;
                html += `<div><span class="font-medium">Volatility:</span> ${inputs.volatility.toFixed(1)}% std dev</div>`;
                html += `<div><span class="font-medium">Inflation Rate:</span> ${inputs.inflationRate.toFixed(1)}% per year</div>`;
                html += `<div><span class="font-medium">Monte Carlo Runs:</span> ${inputs.monteCarloRuns.toLocaleString()}</div>`;
                html += '</div>';
                html += '</div>';

                // Income & Constraints
                html += '<div class="border border-[#38383a] rounded-lg p-4 bg-black">';
                html += '<h4 class="font-semibold text-white mb-3">Income & Constraints</h4>';
                html += '<div class="space-y-2 text-sm text-[#e5e5e7]">';
                html += `<div><span class="font-medium">Min Withdrawal:</span> ${Charts.formatCurrency(inputs.minSpending)}/year</div>`;
                html += `<div><span class="font-medium">Max Withdrawal:</span> ${inputs.maxSpending > 0 ? Charts.formatCurrency(inputs.maxSpending) + '/year' : 'No cap'}</div>`;
                html += `<div><span class="font-medium">One-Time Expense (Every 5 Years):</span> ${Charts.formatCurrency(inputs.oneTimeExpense || 0)}</div>`;
                html += `<div><span class="font-medium">Social Security:</span> ${Charts.formatCurrency(inputs.socialSecurity)}/year</div>`;
                html += `<div><span class="font-medium">SS Start Age:</span> ${inputs.ssStartAge}</div>`;
                html += `<div><span class="font-medium">Target Success Rate:</span> ${inputs.targetSuccessRate}%</div>`;
                html += '</div>';
                html += '</div>';

                // Strategies
                html += '<div class="border border-[#38383a] rounded-lg p-4 bg-black">';
                html += '<h4 class="font-semibold text-white mb-3">Selected Strategies</h4>';
                html += '<ul class="space-y-1 text-sm text-[#e5e5e7] list-disc list-inside">';
                inputs.strategies.forEach(s => {
                    html += `<li>${Report.strategyDisplayName(s)}</li>`;
                });
                html += '</ul>';
                html += '</div>';

                html += '</div>';

                html += '<div class="mt-6 text-center">';
                html += '<button id="edit-assumptions-btn" class="bg-primary-600 hover:bg-primary-700 text-white font-semibold py-2 px-6 rounded-lg shadow transition-colors">';
                html += 'Edit Assumptions';
                html += '</button>';
                html += '</div>';

                html += '</div>';

                document.getElementById('tab-assumptions').innerHTML = html;

                // Add click handler to edit button
                setTimeout(() => {
                    const editBtn = document.getElementById('edit-assumptions-btn');
                    if (editBtn) {
                        editBtn.addEventListener('click', () => {
                            document.getElementById('results-panel').classList.add('hidden');
                            document.getElementById('assumptions-panel').classList.remove('hidden');
                            document.getElementById('back-to-assumptions').classList.add('hidden');
                        });
                    }
                }, 100);
            },

            /**
             * Initialize tab switching functionality
             */
            initTabs() {
                const tabButtons = document.querySelectorAll('.tab-button');
                const tabContents = document.querySelectorAll('.tab-content');

                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const targetTab = button.getAttribute('data-tab');

                        // Update button states
                        tabButtons.forEach(btn => {
                            btn.classList.remove('active', 'border-primary-500', 'text-primary-600', 'dark:text-primary-400');
                            btn.classList.add('text-gray-600', 'dark:text-gray-400', 'border-transparent');
                        });
                        button.classList.add('active', 'border-primary-500', 'text-primary-600', 'dark:text-primary-400');
                        button.classList.remove('text-gray-600', 'dark:text-gray-400', 'border-transparent');

                        // Update content visibility with animation
                        tabContents.forEach(content => {
                            if (content.id === `tab-${targetTab}`) {
                                // Fade in the new content
                                content.classList.remove('hidden');
                                content.classList.add('active');
                                content.style.opacity = '0';
                                content.style.transform = 'translateY(10px)';
                                requestAnimationFrame(() => {
                                    content.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                                    content.style.opacity = '1';
                                    content.style.transform = 'translateY(0)';
                                });
                            } else {
                                content.classList.add('hidden');
                                content.classList.remove('active');
                            }
                        });

                        // Wiggle animation on the active tab button
                        button.classList.add('animate-wiggle');
                        setTimeout(() => button.classList.remove('animate-wiggle'), 500);
                    });
                });
            },

            /**
             * Initialize theme toggle functionality
             */
            initThemeToggle() {
                // Always use dark mode
                document.documentElement.classList.add('dark');
            },

            /**
             * Initialize all UI components and event handlers
             */
            init() {
                this.initTabs();
                this.initThemeToggle();
                this.initTippyTooltips();
                this.initAccessibility();

                // Run simulation button
                document.getElementById('run-simulation').addEventListener('click', () => {
                    this.runSimulation();
                });

                // Back to assumptions link
                document.getElementById('back-to-assumptions').addEventListener('click', () => {
                    document.getElementById('results-panel').classList.add('hidden');
                    document.getElementById('assumptions-panel').classList.remove('hidden');
                    document.getElementById('back-to-assumptions').classList.add('hidden');
                });

            },

            /**
             * Initialize Tippy.js tooltips for all info icons
             * WCAG 2.2 compliant with keyboard support
             */
            initTippyTooltips() {
                if (typeof tippy === 'undefined') return;

                // Find all tooltip elements and convert to Tippy
                document.querySelectorAll('.tooltip').forEach(tooltip => {
                    const content = tooltip.querySelector('.tooltiptext');
                    if (!content) return;

                    const infoIcon = tooltip.querySelector('.info-icon');
                    if (!infoIcon) return;

                    // Make info icon focusable for keyboard users
                    infoIcon.setAttribute('tabindex', '0');
                    infoIcon.setAttribute('role', 'button');
                    infoIcon.setAttribute('aria-label', 'More information');

                    tippy(infoIcon, {
                        content: content.textContent,
                        theme: 'custom',
                        animation: 'shift-away',
                        placement: 'top',
                        trigger: 'mouseenter focus',
                        interactive: true,
                        allowHTML: false,
                        maxWidth: 300,
                        // WCAG: Tooltip stays open on hover
                        hideOnClick: false,
                        // WCAG: Support keyboard navigation
                        appendTo: document.body
                    });

                    // Hide the original tooltiptext since Tippy handles it now
                    content.style.display = 'none';
                });
            },

            /**
             * Initialize accessibility features
             */
            initAccessibility() {
                // Announce dynamic content changes to screen readers
                this.ariaLive = document.getElementById('aria-live');

                // Always enable animations (user preference)
                this.prefersReducedMotion = false;
            },

            /**
             * Announce message to screen readers
             */
            announceToScreenReader(message) {
                if (this.ariaLive) {
                    this.ariaLive.textContent = message;
                    // Clear after announcement
                    setTimeout(() => {
                        this.ariaLive.textContent = '';
                    }, 1000);
                }
            }
        };

        // ============================================
        // CELEBRATION EFFECTS
        // Visual feedback for successful outcomes
        // ============================================
        const CelebrationEffects = {
            /**
             * Create confetti celebration for high success rates
             */
            triggerConfetti(count = 50) {
                const colors = ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#22c55e', '#06b6d4'];

                for (let i = 0; i < count; i++) {
                    setTimeout(() => {
                        const confetti = document.createElement('div');
                        confetti.className = 'confetti-piece';
                        confetti.style.left = Math.random() * 100 + 'vw';
                        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                        confetti.style.animationDelay = Math.random() * 0.5 + 's';
                        confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
                        confetti.style.transform = `rotate(${Math.random() * 360}deg)`;

                        if (Math.random() > 0.5) {
                            confetti.style.borderRadius = '50%';
                        }

                        document.body.appendChild(confetti);

                        // Remove after animation
                        setTimeout(() => confetti.remove(), 4000);
                    }, i * 30);
                }
            },

            /**
             * Trigger celebration based on success rate
             */
            celebrateIfWarranted(bestSuccessRate, targetRate) {
                if (bestSuccessRate >= targetRate && bestSuccessRate >= 90) {
                    this.triggerConfetti(60);
                    this.addSparkles(12);
                } else if (bestSuccessRate >= targetRate) {
                    this.triggerConfetti(30);
                    this.addSparkles(6);
                }
            },

            /**
             * Add sparkle effects around the screen
             */
            addSparkles(count) {
                for (let i = 0; i < count; i++) {
                    setTimeout(() => {
                        const sparkle = document.createElement('div');
                        sparkle.className = 'sparkle';
                        sparkle.style.left = (10 + Math.random() * 80) + 'vw';
                        sparkle.style.top = (10 + Math.random() * 80) + 'vh';
                        sparkle.style.animationDelay = (Math.random() * 0.5) + 's';
                        sparkle.style.zIndex = '9998';
                        sparkle.style.position = 'fixed';
                        document.body.appendChild(sparkle);

                        setTimeout(() => sparkle.remove(), 2000);
                    }, i * 100);
                }
            }
        };

        // ============================================
        // KEY INSIGHTS GENERATOR
        // Enhanced with actionable guidance and recommendations
        // ============================================
        const InsightsGenerator = {
            /**
             * Calculate what portfolio size would be needed to achieve target success rate
             * Uses binary search to find the portfolio that achieves the target
             */
            estimateRequiredPortfolio(inputs, targetSuccessRate) {
                const bestStrategy = 'constant-pct'; // Most resilient strategy
                let low = inputs.startingPortfolio * 0.5;
                let high = inputs.startingPortfolio * 5;

                // Simple estimation: assume linear relationship between portfolio and success
                // This is a rough approximation for guidance
                const currentResult = Simulation.runStrategy(bestStrategy, inputs);
                const currentSuccess = currentResult.successRate;

                if (currentSuccess >= targetSuccessRate) {
                    return inputs.startingPortfolio; // Already meeting target
                }

                // Estimate based on ratio needed
                const successGap = targetSuccessRate - currentSuccess;
                const multiplier = 1 + (successGap / 100) * 2.5; // Rough heuristic
                return Math.round(inputs.startingPortfolio * multiplier);
            },

            /**
             * Calculate what spending level would achieve target success rate
             */
            estimateSafeSpending(inputs, targetSuccessRate) {
                // Run a quick simulation with reduced spending to estimate safe level
                const testInputs = { ...inputs };
                const currentWithdrawalRate = inputs.minSpending / inputs.startingPortfolio;

                // If withdrawal rate is already low, spending is probably fine
                if (currentWithdrawalRate <= 0.03) {
                    return inputs.minSpending;
                }

                // Estimate safe spending based on classic safe withdrawal research
                // Adjusted for retirement length and expected returns
                const yearsInRetirement = inputs.planningAge - inputs.retirementAge;
                let safeRate = 0.04; // Start with 4% rule

                // Adjust for longer retirements
                if (yearsInRetirement > 30) {
                    safeRate = 0.035;
                }
                if (yearsInRetirement > 40) {
                    safeRate = 0.03;
                }

                // Adjust for expected returns
                if (inputs.expectedReturn < 4) {
                    safeRate -= 0.005;
                }
                if (inputs.expectedReturn > 6) {
                    safeRate += 0.005;
                }

                // Account for Social Security
                const ssAtRetirement = inputs.retirementAge >= inputs.ssStartAge ? inputs.socialSecurity : 0;
                const safePortfolioSpending = inputs.startingPortfolio * safeRate;

                return Math.round(safePortfolioSpending + ssAtRetirement);
            },

            /**
             * Estimate impact of delaying retirement
             */
            estimateDelayImpact(inputs, yearsDelay) {
                // Each year of delay provides:
                // 1. More time for portfolio to grow
                // 2. Fewer years to fund
                // 3. Higher Social Security (if applicable)

                const currentYears = inputs.planningAge - inputs.retirementAge;
                const newYears = inputs.planningAge - (inputs.retirementAge + yearsDelay);
                const yearsReduction = ((currentYears - newYears) / currentYears) * 100;

                // Estimate portfolio growth during delay
                const growthMultiplier = Math.pow(1 + inputs.expectedReturn / 100, yearsDelay);
                const projectedPortfolio = inputs.startingPortfolio * growthMultiplier;

                return {
                    yearsReduction,
                    projectedPortfolio,
                    additionalGrowth: projectedPortfolio - inputs.startingPortfolio
                };
            },

            generate(results, inputs) {
                const strategies = Object.values(results);
                const insights = [];
                const recommendations = [];

                // Calculate deflator for final values (end of retirement period)
                const years = inputs.planningAge - inputs.retirementAge;
                const inflationMultiplier = 1 + inputs.inflationRate / 100;
                const finalDeflator = Math.pow(inflationMultiplier, years - 1);

                // ============================================
                // CORE SUCCESS ANALYSIS
                // ============================================
                const bestSuccess = strategies.reduce((max, s) => s.successRate > max.successRate ? s : max);
                const worstSuccess = strategies.reduce((min, s) => s.successRate < min.successRate ? s : min);
                const meetsTarget = strategies.filter(s => s.successRate >= inputs.targetSuccessRate);

                // Primary success message
                if (meetsTarget.length === 0) {
                    insights.push({
                        type: 'warning',
                        icon: '‚ö†Ô∏è',
                        text: `None of the strategies meet your ${inputs.targetSuccessRate}% target success rate. The best performing strategy (${Report.strategyDisplayName(bestSuccess.name)}) achieves ${bestSuccess.successRate.toFixed(1)}%. See recommendations below.`,
                        priority: 1
                    });
                } else if (meetsTarget.length === strategies.length) {
                    insights.push({
                        type: 'success',
                        icon: '‚úÖ',
                        text: `All ${meetsTarget.length} strategies meet your ${inputs.targetSuccessRate}% target! Your plan appears well-funded with a comfortable margin of safety.`,
                        priority: 1
                    });
                } else {
                    insights.push({
                        type: 'success',
                        icon: '‚úÖ',
                        text: `${meetsTarget.length} of ${strategies.length} strategies meet your ${inputs.targetSuccessRate}% target. ${Report.strategyDisplayName(bestSuccess.name)} performs best at ${bestSuccess.successRate.toFixed(1)}%.`,
                        priority: 1
                    });
                }

                // ============================================
                // WITHDRAWAL RATE ANALYSIS
                // ============================================
                const initialWithdrawalRate = (inputs.minSpending / inputs.startingPortfolio) * 100;
                const yearsInRetirement = inputs.planningAge - inputs.retirementAge;

                // Determine safe withdrawal rate based on retirement length
                let safeWRBenchmark = 4.0;
                let safeWRLabel = "4% rule";
                if (yearsInRetirement > 40) {
                    safeWRBenchmark = 3.0;
                    safeWRLabel = "3% (40+ year retirement)";
                } else if (yearsInRetirement > 30) {
                    safeWRBenchmark = 3.5;
                    safeWRLabel = "3.5% (30+ year retirement)";
                }

                if (initialWithdrawalRate > safeWRBenchmark * 1.5) {
                    insights.push({
                        type: 'warning',
                        icon: 'üìâ',
                        text: `Your initial withdrawal rate of ${initialWithdrawalRate.toFixed(1)}% is significantly higher than the ${safeWRLabel} benchmark. This is the primary risk factor in your plan.`,
                        priority: 2
                    });
                } else if (initialWithdrawalRate > safeWRBenchmark) {
                    insights.push({
                        type: 'warning',
                        icon: 'üìä',
                        text: `Your initial withdrawal rate of ${initialWithdrawalRate.toFixed(1)}% exceeds the ${safeWRLabel} benchmark. Consider strategies that adapt spending to market conditions.`,
                        priority: 2
                    });
                } else if (initialWithdrawalRate < safeWRBenchmark * 0.75) {
                    insights.push({
                        type: 'success',
                        icon: 'üõ°Ô∏è',
                        text: `Your withdrawal rate of ${initialWithdrawalRate.toFixed(1)}% is conservative, well below the ${safeWRLabel} benchmark. You have a strong margin of safety.`,
                        priority: 2
                    });
                }

                // ============================================
                // SOCIAL SECURITY ANALYSIS
                // ============================================
                if (inputs.socialSecurity > 0) {
                    const yearsUntilSS = Math.max(0, inputs.ssStartAge - inputs.retirementAge);
                    const ssPercentOfSpending = (inputs.socialSecurity / inputs.minSpending) * 100;

                    if (yearsUntilSS > 0) {
                        insights.push({
                            type: 'info',
                            icon: 'üìÖ',
                            text: `Social Security begins ${yearsUntilSS} years after retirement (age ${inputs.ssStartAge}). During this gap, your portfolio must cover 100% of spending. Once SS starts, it covers ${ssPercentOfSpending.toFixed(0)}% of your minimum spending.`,
                            priority: 3
                        });

                        // Calculate the portfolio draw during SS gap
                        const inflationMultiplier = 1 + inputs.inflationRate / 100;
                        let totalGapSpending = 0;
                        for (let i = 0; i < yearsUntilSS; i++) {
                            totalGapSpending += inputs.minSpending * Math.pow(inflationMultiplier, i);
                        }

                        if (totalGapSpending > inputs.startingPortfolio * 0.3) {
                            insights.push({
                                type: 'warning',
                                icon: '‚è≥',
                                text: `Before Social Security starts, you'll need approximately ${Charts.formatCurrency(totalGapSpending)} from your portfolio (${((totalGapSpending / inputs.startingPortfolio) * 100).toFixed(0)}% of starting value). This early drawdown period is critical.`,
                                priority: 3
                            });
                        }
                    } else {
                        insights.push({
                            type: 'success',
                            icon: '‚úì',
                            text: `Social Security provides ${Charts.formatCurrency(inputs.socialSecurity)}/year (${ssPercentOfSpending.toFixed(0)}% of minimum spending) from day one, significantly reducing portfolio strain.`,
                            priority: 3
                        });
                    }
                }

                // ============================================
                // LONGEVITY & SEQUENCE RISK
                // ============================================
                if (yearsInRetirement > 35) {
                    insights.push({
                        type: 'info',
                        icon: '‚è∞',
                        text: `A ${yearsInRetirement}-year retirement requires careful planning. The first 10 years are critical‚Äîa severe market downturn early in retirement (sequence-of-returns risk) has the greatest impact on long-term success.`,
                        priority: 4
                    });
                }

                // ============================================
                // STRATEGY-SPECIFIC INSIGHTS
                // ============================================
                // Analyze spread between strategies
                const successSpread = bestSuccess.successRate - worstSuccess.successRate;
                if (successSpread > 20) {
                    insights.push({
                        type: 'info',
                        icon: 'üîÑ',
                        text: `Strategy choice matters significantly for your plan: success rates range from ${worstSuccess.successRate.toFixed(1)}% to ${bestSuccess.successRate.toFixed(1)}% (${successSpread.toFixed(0)} point spread). Flexible strategies like ${Report.strategyDisplayName(bestSuccess.name)} adapt better to your situation.`,
                        priority: 4
                    });
                }

                // Check if constant-pct is available and how it compares
                const constantPct = strategies.find(s => s.name === 'constant-pct');
                const constantReal = strategies.find(s => s.name === 'constant-real');
                if (constantPct && constantReal && constantPct.successRate > constantReal.successRate + 10) {
                    insights.push({
                        type: 'info',
                        icon: 'üí°',
                        text: `Constant % of Portfolio outperforms the traditional 4% Rule by ${(constantPct.successRate - constantReal.successRate).toFixed(0)} points because it automatically reduces spending during downturns. Trade-off: income varies with market performance.`,
                        priority: 5
                    });
                }

                // ============================================
                // ACTIONABLE RECOMMENDATIONS
                // ============================================
                if (bestSuccess.successRate < inputs.targetSuccessRate) {
                    const gap = inputs.targetSuccessRate - bestSuccess.successRate;

                    // Recommendation 1: Reduce spending
                    const safeSpending = this.estimateSafeSpending(inputs, inputs.targetSuccessRate);
                    if (safeSpending < inputs.minSpending) {
                        const reduction = inputs.minSpending - safeSpending;
                        const reductionPct = (reduction / inputs.minSpending) * 100;
                        recommendations.push({
                            icon: 'üìâ',
                            title: 'Reduce Annual Spending',
                            text: `Reducing spending to ${Charts.formatCurrency(safeSpending)}/year (-${reductionPct.toFixed(0)}%) would significantly improve success rates. This brings your withdrawal rate closer to sustainable levels.`,
                            impact: 'High Impact'
                        });
                    }

                    // Recommendation 2: Increase portfolio
                    const requiredPortfolio = this.estimateRequiredPortfolio(inputs, inputs.targetSuccessRate);
                    if (requiredPortfolio > inputs.startingPortfolio) {
                        const additional = requiredPortfolio - inputs.startingPortfolio;
                        recommendations.push({
                            icon: 'üí∞',
                            title: 'Increase Starting Portfolio',
                            text: `A portfolio of approximately ${Charts.formatCurrency(requiredPortfolio)} (+${Charts.formatCurrency(additional)}) would better support your spending goals at your target success rate.`,
                            impact: 'High Impact'
                        });
                    }

                    // Recommendation 3: Delay retirement
                    if (inputs.retirementAge < 70) {
                        const delayYears = Math.min(5, 70 - inputs.retirementAge);
                        const delayImpact = this.estimateDelayImpact(inputs, delayYears);
                        recommendations.push({
                            icon: 'üìÖ',
                            title: `Delay Retirement by ${delayYears} Years`,
                            text: `Working until age ${inputs.retirementAge + delayYears} would: (1) allow your portfolio to grow to ~${Charts.formatCurrency(delayImpact.projectedPortfolio)}, (2) reduce retirement years by ${delayImpact.yearsReduction.toFixed(0)}%, and (3) potentially increase Social Security benefits.`,
                            impact: 'High Impact'
                        });
                    }

                    // Recommendation 4: Increase expected return (with caveats)
                    if (inputs.expectedReturn < 6 && recommendations.length < 4) {
                        recommendations.push({
                            icon: 'üìà',
                            title: 'Review Asset Allocation',
                            text: `Your expected return of ${inputs.expectedReturn}% is conservative. A more equity-heavy allocation could increase returns, but also increases volatility and sequence-of-returns risk. Consider your risk tolerance carefully.`,
                            impact: 'Medium Impact'
                        });
                    }
                } else {
                    // Already meeting target - provide optimization recommendations
                    if (bestSuccess.successRate > inputs.targetSuccessRate + 15) {
                        recommendations.push({
                            icon: 'üéØ',
                            title: 'Consider Higher Spending',
                            text: `Your ${bestSuccess.successRate.toFixed(1)}% success rate exceeds your ${inputs.targetSuccessRate}% target by a wide margin. You may be able to spend more or retire earlier while still meeting your goals.`,
                            impact: 'Opportunity'
                        });
                    }

                    // Wealth preservation insight
                    const bestWealth = strategies.reduce((max, s) => s.medianFinal > max.medianFinal ? s : max);
                    if (bestWealth.medianFinal / finalDeflator > inputs.startingPortfolio * 0.5) {
                        recommendations.push({
                            icon: 'üè¶',
                            title: 'Legacy Planning',
                            text: `${Report.strategyDisplayName(bestWealth.name)} has a median final balance of ${Charts.formatCurrency(bestWealth.medianFinal / finalDeflator)}. If leaving wealth to heirs is important, this strategy preserves the most capital.`,
                            impact: 'Consideration'
                        });
                    }
                }

                // Store recommendations for display
                this._recommendations = recommendations;

                return insights;
            },

            display(insights) {
                let html = '<div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 border border-blue-300 dark:border-blue-800 rounded-lg p-6 mb-6">';
                html += '<h3 class="text-lg font-semibold text-white mb-4 flex items-center">';
                html += '<svg class="w-6 h-6 mr-2 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>';
                html += 'Key Insights';
                html += '</h3>';
                html += '<div class="space-y-3">';

                // Sort insights by priority if available
                const sortedInsights = [...insights].sort((a, b) => (a.priority || 99) - (b.priority || 99));

                sortedInsights.forEach(insight => {
                    const bgColor = {
                        'warning': 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-300 dark:border-yellow-800',
                        'success': 'bg-green-50 dark:bg-green-900/20 border-green-300 dark:border-green-800',
                        'info': 'bg-blue-50 dark:bg-blue-900/20 border-blue-300 dark:border-blue-800'
                    }[insight.type];

                    const textColor = {
                        'warning': 'text-yellow-900 dark:text-yellow-200',
                        'success': 'text-green-900 dark:text-green-200',
                        'info': 'text-blue-900 dark:text-blue-200'
                    }[insight.type];

                    const className = insight.type === 'warning' ? 'insight-warning' : '';

                    html += `<div class="${bgColor} border rounded-lg p-3 ${className}">
                        <p class="text-sm ${textColor} flex items-start">
                            <span class="mr-2 text-lg flex-shrink-0">${insight.icon}</span>
                            <span>${insight.text}</span>
                        </p>
                    </div>`;
                });

                html += '</div>';

                // Add recommendations section if there are any
                if (this._recommendations && this._recommendations.length > 0) {
                    html += '<div class="mt-6 pt-6 border-t border-blue-200 dark:border-blue-800">';
                    html += '<h4 class="text-md font-semibold text-white mb-4 flex items-center">';
                    html += '<svg class="w-5 h-5 mr-2 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>';
                    html += 'Actionable Recommendations';
                    html += '</h4>';
                    html += '<div class="grid gap-3">';

                    this._recommendations.forEach(rec => {
                        const impactColor = rec.impact === 'High Impact'
                            ? 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200'
                            : rec.impact === 'Medium Impact'
                            ? 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-200'
                            : 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200';

                        html += `<div class="bg-[#2c2c2e] border border-gray-200 dark:border-slate-700 rounded-lg p-4">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex items-center">
                                    <span class="text-xl mr-2">${rec.icon}</span>
                                    <span class="font-medium text-white">${rec.title}</span>
                                </div>
                                <span class="text-xs px-2 py-1 rounded-full ${impactColor}">${rec.impact}</span>
                            </div>
                            <p class="text-sm text-[#98989d] ml-8">${rec.text}</p>
                        </div>`;
                    });

                    html += '</div>';
                    html += '</div>';
                }

                html += '</div>';
                return html;
            }
        };

        // ============================================
        // SUCCESS RATE GAUGE
        // ============================================
        const SuccessRateGauge = {
            render(successRate, targetSuccessRate = 90) {
                const radius = 80;
                const circumference = radius * Math.PI; // Half circle
                const offset = circumference - (successRate / 100) * circumference;

                // Color based on target success rate
                // Green if meets/exceeds target, otherwise scale from red to yellow
                let color;
                if (successRate >= targetSuccessRate) {
                    color = '#10b981'; // Green - meets target
                } else {
                    // Scale from red (0%) to yellow (just below target)
                    const ratio = successRate / targetSuccessRate;
                    // Interpolate between red (#ef4444) and yellow (#f59e0b)
                    const r = Math.round(239 + (245 - 239) * ratio); // 239 -> 245
                    const g = Math.round(68 + (158 - 68) * ratio);   // 68 -> 158
                    const b = Math.round(68 + (11 - 68) * ratio);    // 68 -> 11
                    color = `rgb(${r}, ${g}, ${b})`;
                }

                const darkMode = document.documentElement.classList.contains('dark');
                const textColor = darkMode ? '#e2e8f0' : '#1f2937';
                const bgStroke = darkMode ? '#1e293b' : '#e5e7eb';

                const pulseClass = successRate >= targetSuccessRate ? 'ring-pulse' : '';

                let html = `
                    <div class="gauge-container">
                        <svg width="200" height="120" viewBox="0 0 200 120" class="${pulseClass}" style="color: ${color}">
                            <path class="gauge-background"
                                d="M 20 100 A 80 80 0 1 1 180 100"
                                stroke="${bgStroke}"
                                stroke-width="12"
                                fill="none">
                            </path>
                            <path class="gauge-fill"
                                d="M 20 100 A 80 80 0 1 1 180 100"
                                stroke="${color}"
                                stroke-width="12"
                                fill="none"
                                stroke-dasharray="${circumference}"
                                stroke-dashoffset="${circumference}"
                                stroke-linecap="round"
                                style="transition: stroke-dashoffset 1.5s ease-out; animation: gaugeIn 1.5s ease-out forwards;">
                                <animate attributeName="stroke-dashoffset" from="${circumference}" to="${offset}" dur="1.5s" fill="freeze" calcMode="spline" keySplines="0.4 0 0.2 1"/>
                            </path>
                            <text x="100" y="90" text-anchor="middle" font-size="32" font-weight="bold" fill="${textColor}">
                                ${successRate.toFixed(1)}%
                            </text>
                            <text x="100" y="110" text-anchor="middle" font-size="12" fill="${textColor}" opacity="0.7">
                                Success Rate
                            </text>
                        </svg>
                    </div>`;

                return html;
            }
        };

        // ============================================
        // DISTRIBUTION HISTOGRAM
        // Renders an interactive ApexCharts histogram showing the spread of
        // final portfolio values across all Monte Carlo simulations.
        // Features: Animated bars, hover tooltips, percentile annotations
        // Uses 2nd-98th percentile range to minimize dead space from outliers.
        // ============================================
        const DistributionHistogram = {
            charts: {}, // Store chart instances for cleanup

            render(results, strategyName) {
                const strategy = results[strategyName];
                if (!strategy || !strategy.allFinalValues) return '';

                // Generate unique ID for this chart
                const chartId = `apex-histogram-${strategyName}`;

                // Return container, chart will be rendered after DOM insertion
                return `<div id="${chartId}" class="histogram-chart" data-strategy="${strategyName}" style="min-height: 300px;"></div>`;
            },

            // Call this after the container is added to DOM
            renderApexChart(results, strategyName, inputs) {
                const strategy = results[strategyName];
                if (!strategy || !strategy.allFinalValues) return;

                const chartId = `apex-histogram-${strategyName}`;
                const container = document.getElementById(chartId);
                if (!container) return;

                // Destroy previous chart if exists
                if (this.charts[strategyName]) {
                    this.charts[strategyName].destroy();
                }

                // Calculate deflator for final values (end of retirement period)
                const years = inputs.planningAge - inputs.retirementAge;
                const inflationMultiplier = 1 + inputs.inflationRate / 100;
                const finalDeflator = Math.pow(inflationMultiplier, years - 1);

                // Deflate all final values to today's dollars
                const values = strategy.allFinalValues.map(v => v / finalDeflator);
                const sorted = [...values].sort((a, b) => a - b);

                // Calculate percentiles
                const p2 = this.calculatePercentile(sorted, 2);
                const p25 = this.calculatePercentile(sorted, 25);
                const p50 = this.calculatePercentile(sorted, 50);
                const p75 = this.calculatePercentile(sorted, 75);
                const p95 = this.calculatePercentile(sorted, 95);
                const p98 = this.calculatePercentile(sorted, 98);

                const displayMin = Math.min(0, p2);
                const displayMax = p98 * 1.05;
                const binCount = 20;
                const binWidth = (displayMax - displayMin) / binCount;

                // Count values in each bin
                const bins = Array(binCount).fill(0);
                const categories = [];
                let excludedHigh = 0;

                for (let i = 0; i < binCount; i++) {
                    const binStart = displayMin + i * binWidth;
                    const binEnd = binStart + binWidth;
                    categories.push(Charts.formatCurrency((binStart + binEnd) / 2, true));
                }

                values.forEach(val => {
                    if (val > displayMax) {
                        excludedHigh++;
                        return;
                    }
                    if (val < displayMin) return;
                    const binIndex = Math.min(Math.floor((val - displayMin) / binWidth), binCount - 1);
                    bins[binIndex]++;
                });

                // Create color array (red for $0 bin, gradient for rest)
                const colors = bins.map((_, i) => {
                    const binValue = displayMin + i * binWidth;
                    if (binValue <= 0) return '#ef4444'; // Red for depleted
                    return '#3b82f6'; // Blue for positive
                });

                const isDark = document.documentElement.classList.contains('dark');
                const textColor = isDark ? '#e2e8f0' : '#1f2937';
                const gridColor = isDark ? '#334155' : '#e2e8f0';

                const options = {
                    series: [{
                        name: 'Simulations',
                        data: bins
                    }],
                    chart: {
                        type: 'bar',
                        height: 300,
                        background: 'transparent',
                        animations: {
                            enabled: true,
                            speed: 1000,
                            animateGradually: {
                                enabled: true,
                                delay: 80
                            },
                            dynamicAnimation: {
                                enabled: true,
                                speed: 500
                            }
                        },
                        toolbar: {
                            show: false
                        },
                        fontFamily: 'inherit'
                    },
                    plotOptions: {
                        bar: {
                            borderRadius: 2,
                            columnWidth: '90%',
                            distributed: true,
                            dataLabels: {
                                position: 'top'
                            }
                        }
                    },
                    colors: colors,
                    dataLabels: {
                        enabled: false
                    },
                    legend: {
                        show: false
                    },
                    title: {
                        text: 'Final Portfolio Distribution (Today\'s Dollars)',
                        align: 'center',
                        style: {
                            fontSize: '14px',
                            fontWeight: 600,
                            color: textColor
                        }
                    },
                    subtitle: {
                        text: excludedHigh > 0 ? `${((excludedHigh / values.length) * 100).toFixed(1)}% exceeded ${Charts.formatCurrency(displayMax, true)}` : '',
                        align: 'right',
                        style: {
                            fontSize: '10px',
                            color: textColor,
                            opacity: 0.6
                        }
                    },
                    xaxis: {
                        categories: categories,
                        labels: {
                            style: {
                                colors: textColor,
                                fontSize: '10px'
                            },
                            rotate: -45,
                            rotateAlways: true,
                            hideOverlappingLabels: true
                        },
                        title: {
                            text: 'Final Portfolio Value',
                            style: {
                                color: textColor,
                                fontSize: '11px'
                            }
                        },
                        axisBorder: {
                            color: gridColor
                        },
                        axisTicks: {
                            color: gridColor
                        }
                    },
                    yaxis: {
                        title: {
                            text: 'Count',
                            style: {
                                color: textColor,
                                fontSize: '11px'
                            }
                        },
                        labels: {
                            style: {
                                colors: textColor,
                                fontSize: '10px'
                            }
                        }
                    },
                    grid: {
                        borderColor: gridColor,
                        strokeDashArray: 4
                    },
                    tooltip: {
                        theme: 'dark',
                        y: {
                            formatter: (val) => `${val.toLocaleString()} simulations`
                        }
                    },
                    annotations: {
                        xaxis: [
                            {
                                x: this.findBinCategory(p25, displayMin, binWidth, categories),
                                borderColor: '#f59e0b',
                                borderWidth: 2,
                                strokeDashArray: 4,
                                label: {
                                    text: `P25: ${Charts.formatCurrency(p25, true)}`,
                                    borderColor: '#f59e0b',
                                    style: {
                                        color: '#fff',
                                        background: '#f59e0b',
                                        fontSize: '10px',
                                        fontWeight: 600
                                    }
                                }
                            },
                            {
                                x: this.findBinCategory(p50, displayMin, binWidth, categories),
                                borderColor: '#22c55e',
                                borderWidth: 2,
                                strokeDashArray: 4,
                                label: {
                                    text: `Median: ${Charts.formatCurrency(p50, true)}`,
                                    borderColor: '#22c55e',
                                    style: {
                                        color: '#fff',
                                        background: '#22c55e',
                                        fontSize: '10px',
                                        fontWeight: 600
                                    }
                                }
                            },
                            {
                                x: this.findBinCategory(p75, displayMin, binWidth, categories),
                                borderColor: '#3b82f6',
                                borderWidth: 2,
                                strokeDashArray: 4,
                                label: {
                                    text: `P75: ${Charts.formatCurrency(p75, true)}`,
                                    borderColor: '#3b82f6',
                                    style: {
                                        color: '#fff',
                                        background: '#3b82f6',
                                        fontSize: '10px',
                                        fontWeight: 600
                                    }
                                }
                            },
                            {
                                x: this.findBinCategory(p95, displayMin, binWidth, categories),
                                borderColor: '#8b5cf6',
                                borderWidth: 2,
                                strokeDashArray: 4,
                                label: {
                                    text: `P95: ${Charts.formatCurrency(p95, true)}`,
                                    borderColor: '#8b5cf6',
                                    style: {
                                        color: '#fff',
                                        background: '#8b5cf6',
                                        fontSize: '10px',
                                        fontWeight: 600
                                    }
                                }
                            }
                        ]
                    },
                    states: {
                        hover: {
                            filter: {
                                type: 'lighten',
                                value: 0.1
                            }
                        },
                        active: {
                            filter: {
                                type: 'darken',
                                value: 0.1
                            }
                        }
                    }
                };

                // Create and store chart instance
                this.charts[strategyName] = new ApexCharts(container, options);
                this.charts[strategyName].render();
            },

            findBinCategory(value, displayMin, binWidth, categories) {
                const binIndex = Math.floor((value - displayMin) / binWidth);
                const clampedIndex = Math.max(0, Math.min(binIndex, categories.length - 1));
                return categories[clampedIndex];
            },

            calculatePercentile(values, percentile) {
                const sorted = [...values].sort((a, b) => a - b);
                const index = Math.floor(sorted.length * percentile / 100);
                return sorted[index];
            },

            // Cleanup all charts
            destroyAll() {
                Object.values(this.charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                this.charts = {};
            }
        };

        // ============================================
        // HISTORICAL BACKTESTING
        // ============================================
        const HistoricalBacktesting = {
            // Historical annual real returns (simplified data)
            historicalScenarios: {
                '1929-great-depression': {
                    name: '1929 (Great Depression)',
                    description: 'Stock market crash and Great Depression',
                    returns: [-8.4, -24.9, -43.3, -8.2, 54.0, -1.4, 47.7, 33.9, 31.9, 7.5, -35.0, 28.1, 6.4, 31.1, -0.4, 11.9, -3.1, 29.3, -11.6, 0.5]
                },
                '1966-stagflation': {
                    name: '1966 (Stagflation Era)',
                    description: 'High inflation and stagnant growth',
                    returns: [-10.1, 24.0, 11.1, -8.5, 4.0, 14.3, -14.7, -26.5, 37.2, 23.8, -7.2, 6.6, 18.4, -4.9, 12.3, 32.4, 6.3, 18.5, -14.7, -9.7]
                },
                '2000-dotcom': {
                    name: '2000 (Dot-com Crash)',
                    description: 'Tech bubble burst',
                    returns: [-9.1, -11.9, -22.1, 28.7, 10.9, 4.9, 15.8, 5.5, -37.0, 26.5, 15.1, 2.1, 16.0, 13.7, 1.4, -4.4, 21.8, 28.7, 18.4, 21.1]
                },
                '2008-financial-crisis': {
                    name: '2008 (Financial Crisis)',
                    description: 'Global financial meltdown',
                    returns: [-37.0, 26.5, 15.1, 2.1, 16.0, 13.7, 1.4, -4.4, 21.8, 28.7, 18.4, 21.1, 12.0, -4.4, 31.5, 18.4, -8.8, 31.3, 28.7, 16.3]
                },
                '2020-covid': {
                    name: '2020 (COVID)',
                    description: 'Pandemic-induced volatility',
                    returns: [18.4, -18.0, 28.7, 21.1, 26.9, 16.3, 11.9, 7.5, 10.1, 12.4, 15.3, 18.2, 9.7, 14.5, 19.2, 22.1, 13.4, 16.8, 20.5, 15.9]
                }
            },

            /**
             * Runs a single simulation with fixed historical returns (not random).
             * Used to test how a strategy would have performed in a specific period.
             */
            runHistoricalSimulation(inputs, strategyName, historicalReturns) {
                const years = Math.min(inputs.planningAge - inputs.retirementAge, historicalReturns.length);
                const inflationMultiplier = 1 + inputs.inflationRate / 100;
                const baseMinSpending = inputs.minSpending || 0;

                let portfolio = inputs.startingPortfolio;
                let withdrawal;

                // Initialize withdrawal based on strategy
                if (strategyName === 'constant-real') {
                    const initialRate = 4.5;
                    const calculated = inputs.startingPortfolio * (initialRate / 100);
                    withdrawal = Math.max(calculated, baseMinSpending);
                } else if (strategyName === 'guardrails') {
                    const initialRate = 5.0;
                    const calculated = inputs.startingPortfolio * (initialRate / 100);
                    withdrawal = Math.max(calculated, baseMinSpending);
                }

                for (let i = 0; i < years; i++) {
                    const age = inputs.retirementAge + i;
                    const inflationAdjustedMinSpending = baseMinSpending * Math.pow(inflationMultiplier, i);

                    // One-time expense every 5 years (inflation-adjusted)
                    const isExpenseYear = ((i + 1) % 5 === 0);
                    const oneTimeExpenseThisYear = isExpenseYear ? (inputs.oneTimeExpense || 0) * Math.pow(inflationMultiplier, i) : 0;

                    // Social Security with COLA
                    const ssYearsReceiving = Math.max(0, age - inputs.ssStartAge);
                    const ss = (age >= inputs.ssStartAge) ? inputs.socialSecurity * Math.pow(inflationMultiplier, ssYearsReceiving) : 0;

                    let targetWithdrawal;
                    if (strategyName === 'constant-real') {
                        targetWithdrawal = withdrawal;
                    } else if (strategyName === 'constant-pct') {
                        const pctWithdrawal = portfolio * 0.04;
                        targetWithdrawal = Math.max(pctWithdrawal, inflationAdjustedMinSpending);
                    } else if (strategyName === 'vpw') {
                        const yearsRemaining = inputs.planningAge - age;
                        const vpwPct = Simulation.vpwPercentage(yearsRemaining, 60);
                        const vpwWithdrawal = portfolio * (vpwPct / 100);
                        targetWithdrawal = Math.max(vpwWithdrawal, inflationAdjustedMinSpending);
                    } else if (strategyName === 'guardrails') {
                        targetWithdrawal = Math.max(withdrawal, inflationAdjustedMinSpending);
                    } else if (strategyName === 'rmd') {
                        const lifeExp = Simulation.lifeExpectancy(age);
                        const rmdWithdrawal = portfolio / lifeExp;
                        targetWithdrawal = Math.max(rmdWithdrawal, inflationAdjustedMinSpending);
                    }

                    const netWithdrawal = Math.max(0, targetWithdrawal - ss) + oneTimeExpenseThisYear;
                    portfolio -= netWithdrawal;

                    if (portfolio <= 0) {
                        return { survived: false, finalBalance: 0, yearsLasted: i };
                    }

                    // Apply historical return for this year
                    const returnPct = historicalReturns[i] / 100;
                    portfolio *= (1 + returnPct);

                    // Inflate withdrawal for next year (constant-real and guardrails)
                    if (strategyName === 'constant-real' || strategyName === 'guardrails') {
                        withdrawal *= inflationMultiplier;
                    }
                }

                return { survived: true, finalBalance: portfolio, yearsLasted: years };
            },

            generateReport(results, inputs) {
                let html = '<div class="space-y-6">';
                html += '<h3 class="text-xl font-semibold text-white mb-4">Historical Backtesting</h3>';
                html += '<p class="text-[#e5e5e7] mb-6">How would your strategies have performed if you retired during major historical market events? (Based on actual historical returns)</p>';

                Object.entries(this.historicalScenarios).forEach(([key, scenario]) => {
                    html += `<div class="bg-[#1c1c1e] rounded-lg border border-[#38383a] p-6">`;
                    html += `<h4 class="text-lg font-semibold text-white mb-2">${scenario.name}</h4>`;
                    html += `<p class="text-sm text-[#636366] mb-4">${scenario.description}</p>`;

                    html += '<div class="grid grid-cols-2 md:grid-cols-3 gap-3 mt-4">';

                    Object.values(results).forEach(strategyResult => {
                        // Actually run the simulation with historical returns
                        const historicalResult = this.runHistoricalSimulation(inputs, strategyResult.name, scenario.returns);
                        const survived = historicalResult.survived;
                        const finalBalance = historicalResult.finalBalance;

                        html += `<div class="p-3 rounded-lg ${survived ? 'bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800' : 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800'}">`;
                        html += `<div class="text-xs font-medium text-[#98989d] mb-1">${Report.strategyDisplayName(strategyResult.name)}</div>`;
                        html += `<div class="text-lg font-bold ${survived ? 'text-green-700 dark:text-green-300' : 'text-red-700 dark:text-red-300'}">${survived ? '‚úì Survived' : '‚úó Depleted'}</div>`;
                        if (survived) {
                            html += `<div class="text-xs text-[#636366] mt-1">Final: ${Charts.formatCurrency(finalBalance, true)}</div>`;
                        } else {
                            html += `<div class="text-xs text-[#636366] mt-1">Lasted ${historicalResult.yearsLasted} years</div>`;
                        }
                        html += '</div>';
                    });

                    html += '</div></div>';
                });

                html += '</div>';
                return html;
            }
        };

        // ============================================
        // APPLICATION INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            UI.init();
        });
    </script>
</body>
</html>
