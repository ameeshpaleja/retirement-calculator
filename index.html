<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Retirement Planner</title>
    <meta name="description" content="Monte Carlo retirement withdrawal simulator comparing different withdrawal strategies">

    <!-- SF Pro-inspired typography stack -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://ameeshpaleja.github.io/retirement-calculator/">
    <meta property="og:title" content="Retirement Withdrawal Simulator">
    <meta property="og:description" content="Plan your retirement with confidence. Compare 5 withdrawal strategies using Monte Carlo simulation with 10,000+ scenarios.">
    <meta property="og:image" content="https://ameeshpaleja.github.io/retirement-calculator/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Retirement Withdrawal Simulator">
    <meta name="twitter:description" content="Plan your retirement with confidence. Compare 5 withdrawal strategies using Monte Carlo simulation.">
    <meta name="twitter:image" content="https://ameeshpaleja.github.io/retirement-calculator/og-image.png">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ApexCharts - Interactive animated charts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.44.0/dist/apexcharts.min.js"></script>

    <!-- CountUp.js - Animated number counting -->
    <script src="https://cdn.jsdelivr.net/npm/countup.js@2.8.0/dist/countUp.umd.min.js"></script>

    <!-- Tippy.js - Accessible animated tooltips -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/shift-away.css"/>

    <!-- noUiSlider - Beautiful range sliders -->
    <link href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>

    <!-- Tailwind Custom Configuration - APPLE-INSPIRED DESIGN SYSTEM -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Apple-inspired DARK MODE palette
                        apple: {
                            bg: '#000000',
                            bgAlt: '#1c1c1e',
                            surface: '#2c2c2e',
                            elevated: '#3a3a3c',
                            border: '#48484a',
                            borderLight: '#38383a',
                            // Primary blue accent (brighter for dark mode)
                            blue: '#0a84ff',
                            blueHover: '#409cff',
                            blueLight: 'rgba(10, 132, 255, 0.2)',
                            // Semantic colors (brighter for dark mode)
                            green: '#30d158',
                            greenLight: 'rgba(48, 209, 88, 0.2)',
                            orange: '#ff9f0a',
                            orangeLight: 'rgba(255, 159, 10, 0.2)',
                            red: '#ff453a',
                            redLight: 'rgba(255, 69, 58, 0.2)',
                            // Text hierarchy (light text for dark mode)
                            text: '#f5f5f7',
                            textSecondary: '#a1a1a6',
                            textTertiary: '#8e8e93',
                        }
                    },
                    fontFamily: {
                        'sans': ['-apple-system', 'BlinkMacSystemFont', 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', 'Helvetica', 'Arial', 'sans-serif'],
                        'display': ['-apple-system', 'BlinkMacSystemFont', 'SF Pro Display', 'Helvetica Neue', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'fade-in-up': 'fadeInUp 0.6s ease-out',
                        'fade-in-scale': 'fadeInScale 0.4s ease-out',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-subtle': 'pulseSubtle 2s ease-in-out infinite',
                        'shimmer': 'shimmer 2s linear infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(30px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        fadeInScale: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        pulseSubtle: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.7' },
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-200% 0' },
                            '100%': { backgroundPosition: '200% 0' },
                        },
                    },
                    boxShadow: {
                        'apple-sm': '0 1px 3px rgba(0,0,0,0.08)',
                        'apple': '0 4px 20px rgba(0,0,0,0.08)',
                        'apple-lg': '0 8px 40px rgba(0,0,0,0.12)',
                        'apple-xl': '0 20px 60px rgba(0,0,0,0.15)',
                        'card': '0 2px 12px rgba(0,0,0,0.08), 0 1px 3px rgba(0,0,0,0.06)',
                        'card-hover': '0 8px 30px rgba(0,0,0,0.12), 0 2px 8px rgba(0,0,0,0.06)',
                        'inner-glow': 'inset 0 1px 0 rgba(255,255,255,0.8)',
                    },
                    borderRadius: {
                        'apple': '12px',
                        'apple-lg': '18px',
                        'apple-xl': '24px',
                    },
                }
            }
        }
    </script>

    <style>
        /* ============================================
           APPLE-INSPIRED DESIGN SYSTEM
           Clean, minimal, sophisticated - Cupertino style
           ============================================ */

        /* CSS Custom Properties - Apple DARK MODE Theme */
        :root {
            --apple-bg: #000000;
            --apple-bg-alt: #1c1c1e;
            --apple-surface: #2c2c2e;
            --apple-elevated: #3a3a3c;
            --apple-border: #48484a;
            --apple-border-light: #38383a;
            /* Primary accent - brighter for dark mode */
            --apple-blue: #0a84ff;
            --apple-blue-hover: #409cff;
            --apple-blue-light: rgba(10, 132, 255, 0.2);
            /* Semantic colors - brighter for dark mode */
            --apple-green: #30d158;
            --apple-green-light: rgba(48, 209, 88, 0.2);
            --apple-orange: #ff9f0a;
            --apple-orange-light: rgba(255, 159, 10, 0.2);
            --apple-red: #ff453a;
            --apple-red-light: rgba(255, 69, 58, 0.2);
            /* Text hierarchy - light text for dark mode */
            --text-primary: #f5f5f7;
            --text-secondary: #a1a1a6;
            --text-tertiary: #8e8e93;
        }

        /* Base Typography */
        html {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            font-size: 16px;
            line-height: 1.5;
        }

        body {
            background: var(--apple-bg-alt);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
        }

        /* WCAG 2.2 - Skip Navigation */
        .skip-link {
            position: absolute;
            top: -50px;
            left: 16px;
            background: var(--apple-blue);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            z-index: 10000;
            transition: top 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            font-size: 14px;
            text-decoration: none;
        }

        .skip-link:focus {
            top: 16px;
        }

        /* ============================================
           ANIMATIONS - Playful & Delightful
           Springy, bouncy, alive!
           ============================================ */

        /* Spring easing for that satisfying bounce */
        :root {
            --spring: cubic-bezier(0.34, 1.56, 0.64, 1);
            --spring-soft: cubic-bezier(0.25, 1.25, 0.5, 1);
            --smooth: cubic-bezier(0.16, 1, 0.3, 1);
            --bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 1; transform: scale(1.05); }
            70% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.8) translateY(10px); }
            60% { opacity: 1; transform: scale(1.02) translateY(-2px); }
            100% { transform: scale(1) translateY(0); }
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-3deg); }
            75% { transform: rotate(3deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02); }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            25% { transform: translateY(-6px) rotate(1deg); }
            75% { transform: translateY(6px) rotate(-1deg); }
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(10, 132, 255, 0.3); }
            50% { box-shadow: 0 0 40px rgba(10, 132, 255, 0.5); }
        }

        @keyframes numberPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes successPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(48, 209, 88, 0.4); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 15px rgba(48, 209, 88, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(48, 209, 88, 0); }
        }

        @keyframes ripple {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(4); opacity: 0; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes countUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Staggered entrance animations - more dramatic */
        .stagger-item {
            opacity: 1; /* Fallback - visible by default */
            -webkit-animation: popIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) both;
            animation: popIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) both;
        }
        .stagger-item:nth-child(1) { -webkit-animation-delay: 0.05s; animation-delay: 0.05s; }
        .stagger-item:nth-child(2) { -webkit-animation-delay: 0.12s; animation-delay: 0.12s; }
        .stagger-item:nth-child(3) { -webkit-animation-delay: 0.19s; animation-delay: 0.19s; }
        .stagger-item:nth-child(4) { -webkit-animation-delay: 0.26s; animation-delay: 0.26s; }
        .stagger-item:nth-child(5) { -webkit-animation-delay: 0.33s; animation-delay: 0.33s; }
        .stagger-item:nth-child(6) { -webkit-animation-delay: 0.4s; animation-delay: 0.4s; }

        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        .animate-fade-in-up { animation: fadeInUp 0.5s var(--smooth); }
        .animate-fade-in-scale { animation: fadeInScale 0.4s var(--spring); }
        .animate-bounce-in { animation: bounceIn 0.6s var(--spring); }
        .animate-pop-in { animation: popIn 0.5s var(--spring); }
        .animate-float { animation: float 4s ease-in-out infinite; }
        .animate-breathe { animation: breathe 3s ease-in-out infinite; }
        .animate-glow { animation: glow 2s ease-in-out infinite; }
        .animate-wiggle:hover { animation: wiggle 0.3s ease-in-out; }
        .animate-spin { animation: spin 1s linear infinite; }

        /* ============================================
           GLASS CARDS - Dark mode frosted glass effect
           With playful hover interactions
           ============================================ */
        .glass-card {
            background: #2c2c2e; /* Solid fallback for iOS */
            background: rgba(44, 44, 46, 0.95);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 18px;
            box-shadow:
                0 2px 20px rgba(0, 0, 0, 0.3),
                0 1px 3px rgba(0, 0, 0, 0.2);
            -webkit-transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: center center;
        }

        .glass-card:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow:
                0 20px 50px rgba(0, 0, 0, 0.5),
                0 8px 20px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .glass-card:active {
            transform: translateY(-2px) scale(0.99);
            transition: all 0.1s ease;
        }

        .glass-card-elevated {
            background: var(--apple-surface);
            border: 1px solid var(--apple-border-light);
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
            transition: all 0.4s var(--spring);
        }

        .glass-card-elevated:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        /* ============================================
           FORM INPUTS - Playful interactions
           ============================================ */
        input[type="text"],
        input[type="number"],
        select {
            display: block;
            width: 100%;
            height: 48px;
            background-color: #3a3a3c !important; /* Fallback for iOS */
            background: var(--apple-elevated) !important;
            border: 1px solid var(--apple-border) !important;
            border-radius: 12px !important;
            color: #f5f5f7 !important; /* Fallback for iOS */
            color: var(--text-primary) !important;
            font-family: inherit !important;
            font-size: 17px;
            line-height: 1.2;
            padding: 12px 16px !important;
            transition: all 0.3s var(--spring);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            opacity: 1; /* iOS fix */
            -webkit-opacity: 1; /* iOS fix */
        }

        input[type="text"]:hover,
        input[type="number"]:hover,
        select:hover {
            border-color: rgba(255, 255, 255, 0.2) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: var(--apple-blue) !important;
            box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.25), 0 4px 20px rgba(10, 132, 255, 0.15) !important;
            outline: none !important;
            transform: translateY(-1px);
        }

        /* Value change animation */
        input.value-changed {
            animation: numberPop 0.3s var(--spring);
        }

        input::placeholder {
            color: var(--text-tertiary);
        }

        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a1a1a6' d='M6 8L1 3h10z'/%3E%3C/svg%3E") !important;
            background-repeat: no-repeat !important;
            background-position: right 16px center !important;
            padding-right: 44px !important;
            cursor: pointer;
        }

        select option {
            background: var(--apple-elevated);
            color: var(--text-primary);
        }

        /* Hide number spinners */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] { -moz-appearance: textfield; }

        /* Inputs with prefix symbols (like $) need more left padding */
        input.pl-8 {
            padding-left: 2.5rem !important;
        }

        /* Labels */
        label {
            color: var(--text-primary) !important;
            font-weight: 600;
            font-size: 14px;
            letter-spacing: -0.01em;
        }

        /* ============================================
           BUTTONS - Playful & Bouncy
           ============================================ */
        .btn-apple {
            background: linear-gradient(135deg, var(--apple-blue) 0%, #0066cc 100%);
            color: white;
            border: none;
            border-radius: 14px;
            padding: 16px 32px;
            font-size: 17px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s var(--spring);
            min-height: 54px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(10, 132, 255, 0.3);
        }

        .btn-apple::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .btn-apple:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 30px rgba(10, 132, 255, 0.4), 0 0 0 1px rgba(255,255,255,0.1) inset;
        }

        .btn-apple:hover::before {
            opacity: 1;
        }

        .btn-apple:active {
            transform: translateY(-1px) scale(0.98);
            transition: all 0.1s ease;
        }

        /* Ripple effect on click */
        .btn-apple .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            animation: ripple 0.6s ease-out;
            pointer-events: none;
        }

        .btn-apple-secondary {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: none;
        }

        .btn-apple-secondary:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .btn-apple-outline {
            background: transparent;
            color: var(--apple-blue);
            border: 2px solid var(--apple-blue);
            box-shadow: none;
        }

        .btn-apple-outline:hover {
            background: rgba(10, 132, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(10, 132, 255, 0.2);
        }

        /* ============================================
           TAB BAR - Animated segmented control
           ============================================ */
        .tab-button {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s var(--spring);
            position: relative;
            min-height: 44px;
            border-radius: 10px;
        }

        .tab-button::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background: var(--apple-blue);
            transition: all 0.3s var(--spring);
            transform: translateX(-50%);
            border-radius: 1px;
        }

        .tab-button:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.06);
            transform: translateY(-1px);
        }

        .tab-button:hover::after {
            width: 20px;
        }

        .tab-button[aria-selected="true"],
        .tab-button.active {
            color: var(--apple-blue);
            background: rgba(10, 132, 255, 0.15);
            transform: scale(1.02);
        }

        .tab-button[aria-selected="true"]::after,
        .tab-button.active::after {
            width: 100%;
            left: 0;
            transform: none;
        }

        .tab-content {
            transition: all 0.4s var(--smooth);
        }

        .tab-content.hidden {
            opacity: 0;
            pointer-events: none;
            display: none;
        }

        .tab-content:not(.hidden) {
            animation: fadeInUp 0.4s var(--smooth);
        }

        /* ============================================
           CHECKBOXES - Bouncy & Satisfying
           ============================================ */
        input[type="checkbox"] {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border: 2px solid var(--apple-border);
            border-radius: 7px;
            background: var(--apple-elevated);
            cursor: pointer;
            transition: all 0.3s var(--spring);
            position: relative;
        }

        input[type="checkbox"]:hover {
            border-color: var(--apple-blue);
            transform: scale(1.05);
            box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.1);
        }

        input[type="checkbox"]:checked {
            background: var(--apple-blue);
            border-color: var(--apple-blue);
            animation: bounceIn 0.4s var(--spring);
        }

        input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            left: 7px;
            top: 3px;
            width: 6px;
            height: 12px;
            border: solid white;
            border-width: 0 2.5px 2.5px 0;
            transform: rotate(45deg) scale(0);
            animation: checkPop 0.3s var(--spring) 0.1s forwards;
        }

        @keyframes checkPop {
            0% { transform: rotate(45deg) scale(0); }
            50% { transform: rotate(45deg) scale(1.2); }
            100% { transform: rotate(45deg) scale(1); }
        }

        input[type="checkbox"]:focus {
            box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.25);
        }

        /* ============================================
           STATUS COLORS
           ============================================ */
        .status-success { color: var(--apple-green); }
        .status-warning { color: var(--apple-orange); }
        .status-danger { color: var(--apple-red); }

        .bg-success { background: var(--apple-green-light); }
        .bg-warning { background: var(--apple-orange-light); }
        .bg-danger { background: var(--apple-red-light); }

        /* ============================================
           TOOLTIPS - Apple style
           ============================================ */
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--apple-elevated);
            color: var(--text-tertiary);
            font-size: 12px;
            font-weight: 600;
            cursor: help;
            margin-left: 6px;
            transition: all 0.2s ease;
        }

        .info-icon::before {
            content: '?';
        }

        .info-icon:hover {
            background: var(--apple-blue-light);
            color: var(--apple-blue);
        }

        /* Tippy.js theme - with animation */
        .tippy-box[data-theme~='custom'] {
            background: var(--text-primary);
            color: white;
            border-radius: 10px;
            font-family: inherit;
            font-size: 13px;
            padding: 4px 8px;
            animation: tooltipPop 0.3s var(--spring);
        }

        .tippy-box[data-theme~='custom'] .tippy-arrow {
            color: var(--text-primary);
        }

        @keyframes tooltipPop {
            0% {
                opacity: 0;
                transform: scale(0.8) translateY(5px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* ============================================
           noUiSlider - Apple style
           ============================================ */
        .noUi-target {
            background: var(--apple-border-light);
            border: none;
            border-radius: 4px;
            height: 4px;
        }

        .noUi-connect {
            background: var(--apple-blue);
            border-radius: 4px;
        }

        .noUi-handle {
            width: 26px !important;
            height: 26px !important;
            right: -13px !important;
            top: -11px !important;
            background: linear-gradient(135deg, var(--apple-blue) 0%, #0066cc 100%);
            border: none;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(10, 132, 255, 0.4);
            cursor: grab;
            transition: all 0.3s var(--spring);
        }

        .noUi-handle:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 20px rgba(10, 132, 255, 0.5);
        }

        .noUi-handle:active {
            cursor: grabbing;
            transform: scale(1.1);
        }

        .noUi-handle::before,
        .noUi-handle::after {
            display: none;
        }

        .noUi-tooltip {
            background: var(--text-primary);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 12px;
            font-weight: 600;
        }

        /* ============================================
           CHARTS & CANVAS
           ============================================ */
        canvas {
            max-width: 100%;
            height: auto;
        }

        /* Chart tooltip */
        #chart-tooltip {
            position: fixed;
            z-index: 1000;
            background: var(--text-primary);
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            font-size: 13px;
            pointer-events: none;
            animation: fadeIn 0.15s ease-out;
        }

        #chart-tooltip.hidden {
            display: none;
        }

        /* ============================================
           APEXCHARTS - Apple Dark Theme
           ============================================ */
        .apexcharts-tooltip {
            background: var(--apple-elevated) !important;
            border: 1px solid var(--apple-border) !important;
            border-radius: 10px !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4) !important;
            color: var(--text-primary) !important;
        }

        .apexcharts-tooltip-title {
            background: var(--apple-bg-alt) !important;
            border-bottom: 1px solid var(--apple-border-light) !important;
            color: var(--text-primary) !important;
            font-weight: 600 !important;
        }

        .apexcharts-tooltip-text {
            color: var(--text-primary) !important;
        }

        .apexcharts-xaxis-label,
        .apexcharts-yaxis-label {
            fill: var(--text-tertiary) !important;
        }

        .apexcharts-gridline {
            stroke: var(--apple-border-light) !important;
        }

        .apexcharts-legend-text {
            color: var(--text-secondary) !important;
        }

        /* ============================================
           HISTOGRAM BARS - Animated
           ============================================ */
        .histogram-bar {
            transition: all 0.3s var(--spring);
            border-radius: 6px;
        }

        .histogram-bar:hover {
            filter: brightness(1.2);
            transform: scaleY(1.05);
            transform-origin: bottom;
        }

        /* ============================================
           CELEBRATIONS - Spectacular!
           ============================================ */
        .confetti-piece {
            position: fixed;
            width: 10px;
            height: 10px;
            top: -10px;
            animation: confettiFall 4s ease-out forwards;
            z-index: 9999;
            pointer-events: none;
        }

        .confetti-piece:nth-child(odd) {
            animation-name: confettiFallSpin;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(0) rotate(0deg) scale(0);
                opacity: 1;
            }
            10% {
                transform: translateY(10vh) rotate(90deg) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg) scale(0.5);
                opacity: 0;
            }
        }

        @keyframes confettiFallSpin {
            0% {
                transform: translateY(0) rotate(0deg) rotateY(0deg) scale(0);
                opacity: 1;
            }
            10% {
                transform: translateY(10vh) rotate(90deg) rotateY(180deg) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(1080deg) rotateY(1080deg) scale(0.5);
                opacity: 0;
            }
        }

        /* Success burst effect */
        .success-burst {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 200px;
            height: 200px;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 9998;
        }

        .success-burst::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(48, 209, 88, 0.4) 0%, transparent 70%);
            animation: burstPulse 0.8s ease-out forwards;
        }

        @keyframes burstPulse {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(3); opacity: 0; }
        }

        /* ============================================
           PROGRESS BAR - Animated
           ============================================ */
        .progress-bar {
            background: var(--apple-border-light);
            border-radius: 6px;
            height: 8px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255,255,255,0.1) 50%,
                transparent 100%
            );
            animation: shimmer 1.5s infinite;
            background-size: 200% 100%;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 6px;
            background: linear-gradient(90deg, var(--apple-blue) 0%, #40c8ff 100%);
            transition: width 0.8s var(--spring);
            position: relative;
        }

        /* ============================================
           LOADING SPINNER - Fun!
           ============================================ */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--apple-border);
            border-top-color: var(--apple-blue);
            border-radius: 50%;
            animation: spin 0.8s ease-in-out infinite;
        }

        .loading-dots {
            display: flex;
            gap: 6px;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            background: var(--apple-blue);
            border-radius: 50%;
            animation: loadingDot 1.4s ease-in-out infinite;
        }

        .loading-dots span:nth-child(1) { animation-delay: 0s; }
        .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes loadingDot {
            0%, 80%, 100% {
                transform: scale(0.6);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* ============================================
           SPARKLE EFFECTS
           ============================================ */
        .sparkle {
            width: 10px;
            height: 10px;
            background: radial-gradient(circle, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
            animation: sparkle 1.5s ease-out forwards;
            pointer-events: none;
        }

        @keyframes sparkle {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: scale(1.5) rotate(180deg);
                opacity: 1;
            }
            100% {
                transform: scale(0) rotate(360deg);
                opacity: 0;
            }
        }

        /* Floating orbs for hero section */
        .floating-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(40px);
            opacity: 0.5;
            animation: floatOrb 8s ease-in-out infinite;
            pointer-events: none;
        }

        .floating-orb-1 {
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(10, 132, 255, 0.3) 0%, transparent 70%);
            top: -100px;
            right: -100px;
            animation-delay: 0s;
        }

        .floating-orb-2 {
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(48, 209, 88, 0.25) 0%, transparent 70%);
            bottom: 20%;
            left: -50px;
            animation-delay: -3s;
        }

        .floating-orb-3 {
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, rgba(191, 90, 242, 0.2) 0%, transparent 70%);
            top: 40%;
            right: 10%;
            animation-delay: -5s;
        }

        @keyframes floatOrb {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            25% {
                transform: translate(20px, -20px) scale(1.05);
            }
            50% {
                transform: translate(-10px, 10px) scale(0.95);
            }
            75% {
                transform: translate(-20px, -10px) scale(1.02);
            }
        }

        /* Animated gradient text */
        .gradient-text {
            background: linear-gradient(135deg, var(--apple-blue) 0%, #bf5af2 50%, var(--apple-blue) 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 4s ease-in-out infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% center; }
            50% { background-position: 100% center; }
        }

        /* Typing cursor effect */
        .typing-cursor::after {
            content: '|';
            animation: blink 1s step-end infinite;
            color: var(--apple-blue);
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Counting number animation */
        .count-up {
            display: inline-block;
            animation: countReveal 0.8s var(--spring) forwards;
        }

        @keyframes countReveal {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(0.8);
                filter: blur(10px);
            }
            60% {
                opacity: 1;
                transform: translateY(-5px) scale(1.05);
                filter: blur(0);
            }
            100% {
                transform: translateY(0) scale(1);
            }
        }

        /* Success burst ring */
        .success-ring {
            position: absolute;
            inset: -20px;
            border: 3px solid var(--apple-green);
            border-radius: inherit;
            animation: ringExpand 0.8s ease-out forwards;
            pointer-events: none;
        }

        @keyframes ringExpand {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }
            100% {
                transform: scale(1.2);
                opacity: 0;
            }
        }

        /* Pulse ring for run button */
        .btn-pulse-ring {
            position: absolute;
            inset: 0;
            border-radius: inherit;
            border: 2px solid var(--apple-blue);
            animation: pulseRing 2s ease-out infinite;
            pointer-events: none;
        }

        @keyframes pulseRing {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.15);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 0;
            }
        }

        /* Shimmer effect for buttons */
        .btn-shimmer::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.2),
                transparent
            );
            animation: btnShimmer 3s ease-in-out infinite;
        }

        @keyframes btnShimmer {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: 100%; }
        }

        /* Result card reveal */
        .result-card-reveal {
            animation: resultCardReveal 0.6s var(--spring) forwards;
        }

        @keyframes resultCardReveal {
            0% {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Percentage fill animation */
        .percentage-fill {
            animation: fillGrow 1s var(--smooth) forwards;
        }

        @keyframes fillGrow {
            0% {
                width: 0;
            }
        }

        /* Bounce attention animation */
        .attention-bounce {
            animation: attentionBounce 0.6s var(--spring);
        }

        @keyframes attentionBounce {
            0%, 100% { transform: translateY(0); }
            25% { transform: translateY(-8px); }
            50% { transform: translateY(4px); }
            75% { transform: translateY(-4px); }
        }

        /* Icon spin on hover */
        .icon-spin-hover:hover svg {
            animation: iconSpin 0.6s var(--spring);
        }

        @keyframes iconSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Shake for errors */
        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        /* Jelly hover effect */
        .jelly-hover:hover {
            animation: jelly 0.5s ease;
        }

        @keyframes jelly {
            0%, 100% { transform: scale(1, 1); }
            25% { transform: scale(0.95, 1.05); }
            50% { transform: scale(1.05, 0.95); }
            75% { transform: scale(0.97, 1.03); }
        }

        /* ============================================
           HOVER LIFT EFFECT
           ============================================ */
        .hover-lift {
            transition: all 0.3s var(--spring);
        }

        .hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }

        /* ============================================
           NUMBER ANIMATION CLASS
           ============================================ */
        .number-animate {
            display: inline-block;
            transition: all 0.3s var(--spring);
        }

        .number-animate.updating {
            animation: numberPop 0.4s var(--spring);
        }

        /* ============================================
           TOOLTIP ANIMATION
           ============================================ */
        .tooltip-animated {
            animation: popIn 0.2s var(--spring);
        }

        /* ============================================
           SCROLLBAR - Subtle dark mode style
           ============================================ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        /* ============================================
           FOCUS STATES
           ============================================ */
        :focus-visible {
            outline: 2px solid var(--apple-blue);
            outline-offset: 2px;
        }

        :focus:not(:focus-visible) {
            outline: none;
        }

        /* ============================================
           SELECTION
           ============================================ */
        ::selection {
            background: rgba(0, 113, 227, 0.2);
            color: var(--text-primary);
        }

        /* ============================================
           MOBILE RESPONSIVENESS
           ============================================ */
        @media (max-width: 768px) {
            .glass-card {
                border-radius: 14px;
            }

            input[type="text"],
            input[type="number"],
            select,
            .btn-apple {
                font-size: 16px;
            }

            .tab-button {
                padding: 10px 16px;
                font-size: 13px;
            }
        }

        /* Safe area insets */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(0px, env(safe-area-inset-left));
                padding-right: max(0px, env(safe-area-inset-right));
                padding-bottom: max(0px, env(safe-area-inset-bottom));
            }
        }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ============================================
           PRINT STYLES
           ============================================ */
        @media print {
            body {
                background: white !important;
            }
            header, .no-print, .skip-link {
                display: none !important;
            }
            .glass-card {
                background: white !important;
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }
        }
    </style>
</head>
<body class="bg-apple-bgAlt font-sans antialiased">
    <!-- WCAG 2.2: Skip Navigation Link -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- ARIA Live Region for Dynamic Updates -->
    <div id="aria-live" class="sr-only" aria-live="polite" aria-atomic="true"></div>

    <!-- ============================================
         MAIN APP CONTAINER
         ============================================ -->
    <div class="min-h-screen flex flex-col">

        <!-- ============================================
             HEADER - Apple Style Navigation
             ============================================ -->
        <header class="sticky top-0 z-50 bg-apple-surface/80 backdrop-blur-xl border-b border-apple-borderLight">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <h1 class="text-xl sm:text-2xl font-semibold text-apple-text tracking-tight">
                            Retirement Planner
                        </h1>
                        <!-- Back to Assumptions button (hidden initially) -->
                        <button id="back-to-assumptions" class="hidden text-sm font-medium text-apple-blue hover:text-apple-blueHover transition-colors flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                            Edit Inputs
                        </button>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="hidden sm:inline text-sm text-apple-textSecondary">Monte Carlo Simulator</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- ============================================
             MAIN CONTENT AREA
             ============================================ -->
        <main id="main-content" class="flex-1 max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-12 w-full" role="main">

            <!-- ============================================
                 ASSUMPTIONS PANEL - SHOWN INITIALLY
                 ============================================ -->
            <div id="assumptions-panel" class="animate-fade-in">
                <div class="max-w-2xl mx-auto">

                    <!-- Hero Section - Apple Style with animations -->
                    <div class="text-center mb-12 sm:mb-16">
                        <h2 class="text-4xl sm:text-5xl font-bold text-apple-text mb-4 tracking-tight leading-tight animate-fade-in-up" style="animation-delay: 0.1s">
                            Plan your retirement<br class="hidden sm:block">
                            <span class="gradient-text">with confidence.</span>
                        </h2>
                        <p class="text-lg sm:text-xl text-apple-textSecondary max-w-xl mx-auto leading-relaxed animate-fade-in-up" style="animation-delay: 0.3s; animation-fill-mode: both">
                            See how different withdrawal strategies perform across 10,000 market scenarios.
                        </p>
                    </div>

                    <!-- ============================================
                         ESSENTIAL INPUTS
                         ============================================ -->
                    <div class="glass-card p-6 sm:p-8 mb-6 stagger-item">
                        <h3 class="text-lg font-semibold text-apple-text mb-6">
                            Your Numbers
                        </h3>

                        <div class="space-y-6">
                            <!-- Age inputs -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-apple-text mb-2">
                                        Retirement Age
                                        <button type="button" class="help-trigger info-icon" data-tooltip="The age you plan to stop working and start living off your savings."></button>
                                    </label>
                                    <input type="number" id="retirement-age" value="65" min="18" max="100"
                                        class="w-full">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-apple-text mb-2">
                                        Plan Until Age
                                        <button type="button" class="help-trigger info-icon" data-tooltip="How long should your money last? Most planners recommend 90-95 to be safe."></button>
                                    </label>
                                    <input type="number" id="planning-age" value="90" min="18" max="120"
                                        class="w-full">
                                </div>
                            </div>

                            <!-- Savings Amount -->
                            <div>
                                <label class="block text-sm font-medium text-apple-text mb-2">
                                    Starting Portfolio
                                    <button type="button" class="help-trigger info-icon" data-tooltip="Total retirement savings at start. Include 401(k), IRA, brokerage accounts."></button>
                                </label>
                                <div class="relative">
                                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-apple-textSecondary">$</span>
                                    <input type="text" id="starting-portfolio" value="500,000"
                                        class="w-full pl-8">
                                </div>
                            </div>

                            <!-- Annual Spending -->
                            <div>
                                <label class="block text-sm font-medium text-apple-text mb-2">
                                    Annual Spending
                                    <button type="button" class="help-trigger info-icon" data-tooltip="Desired annual spending in today's dollars. Include all expenses."></button>
                                </label>
                                <div class="relative">
                                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-apple-textSecondary">$</span>
                                    <input type="text" id="starting-withdrawal" value="40,000"
                                        class="w-full pl-8">
                                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-apple-textTertiary text-sm">/year</span>
                                </div>
                                <p class="text-sm text-apple-textSecondary mt-2" id="withdrawal-rate-hint">Withdrawal rate: 8.0%</p>
                            </div>

                            <!-- Social Security -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-apple-text mb-2">
                                        Social Security
                                        <button type="button" class="help-trigger info-icon" data-tooltip="Expected annual Social Security benefit. Check ssa.gov for your estimate."></button>
                                    </label>
                                    <div class="relative">
                                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-apple-textSecondary">$</span>
                                        <input type="text" id="social-security" value="21,000"
                                            class="w-full pl-8">
                                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-apple-textTertiary text-sm">/year</span>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-apple-text mb-2">
                                        SS Start Age
                                        <button type="button" class="help-trigger info-icon" data-tooltip="When to start collecting. 62=reduced, 67=full, 70=max (+24%)."></button>
                                    </label>
                                    <select id="ss-start-age" class="w-full">
                                        <option value="62">62 (Early)  $14,700/yr</option>
                                        <option value="65">65  $18,200/yr</option>
                                        <option value="67" selected>67 (Full)  $21,000/yr</option>
                                        <option value="70">70 (Max)  $26,040/yr</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ============================================
                         INVESTMENT STYLE
                         ============================================ -->
                    <div class="glass-card p-6 sm:p-8 mb-6 stagger-item" style="animation-delay: 0.1s">
                        <h3 class="text-lg font-semibold text-apple-text mb-2">
                            Investment Style
                        </h3>
                        <p class="text-sm text-apple-textSecondary mb-6">Choose your risk tolerance</p>

                        <!-- Investment Style Presets - Apple Style with animations -->
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                            <button type="button" class="investment-preset p-5 bg-apple-surface border-2 border-apple-border rounded-2xl hover:border-apple-green hover:shadow-lg hover:-translate-y-1 transition-all text-left group jelly-hover" data-return="4" data-volatility="10">
                                <div class="w-10 h-10 rounded-full bg-apple-green/10 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                                    <svg class="w-5 h-5 text-apple-green group-hover:animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                                </div>
                                <div class="font-semibold text-apple-text mb-1">Conservative</div>
                                <p class="text-sm text-apple-textSecondary leading-relaxed mb-2">Lower risk, steady growth</p>
                                <p class="text-xs text-apple-textTertiary">4% return  10% volatility</p>
                            </button>

                            <button type="button" class="investment-preset p-5 bg-apple-surface border-2 border-apple-blue rounded-2xl shadow-lg transition-all text-left selected animate-glow jelly-hover" data-return="5" data-volatility="12">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="w-10 h-10 rounded-full bg-apple-blue/10 flex items-center justify-center group-hover:scale-110 transition-transform">
                                        <svg class="w-5 h-5 text-apple-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/></svg>
                                    </div>
                                    <span class="text-xs font-medium text-apple-blue bg-apple-blueLight px-2.5 py-1 rounded-full animate-pulse">Recommended</span>
                                </div>
                                <div class="font-semibold text-apple-text mb-1">Balanced</div>
                                <p class="text-sm text-apple-textSecondary leading-relaxed mb-2">Optimal risk-reward balance</p>
                                <p class="text-xs text-apple-textTertiary">5% return  12% volatility</p>
                            </button>

                            <button type="button" class="investment-preset p-5 bg-apple-surface border-2 border-apple-border rounded-2xl hover:border-apple-orange hover:shadow-lg hover:-translate-y-1 transition-all text-left group jelly-hover" data-return="6" data-volatility="15">
                                <div class="w-10 h-10 rounded-full bg-apple-orange/10 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                                    <svg class="w-5 h-5 text-apple-orange group-hover:animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                                </div>
                                <div class="font-semibold text-apple-text mb-1">Aggressive</div>
                                <p class="text-sm text-apple-textSecondary leading-relaxed mb-2">Higher risk, maximum growth</p>
                                <p class="text-xs text-apple-textTertiary">6% return  15% volatility</p>
                            </button>
                        </div>

                        <!-- Hidden inputs that get updated by presets -->
                        <input type="hidden" id="expected-return" value="5.0">
                        <input type="hidden" id="volatility" value="12.0">
                        <input type="hidden" id="inflation-rate" value="2.5">
                        <input type="hidden" id="monte-carlo-runs" value="10000">
                        <input type="hidden" id="return-distribution" value="normal">
                    </div>

                    <!-- ============================================
                         ADVANCED OPTIONS - Hidden by Default
                         ============================================ -->
                    <div class="mb-6">
                        <button type="button" id="toggle-advanced" class="w-full flex items-center justify-center gap-2 py-3 text-apple-textSecondary hover:text-apple-blue transition-colors text-sm font-medium">
                            <span>Advanced Options</span>
                            <svg id="advanced-chevron" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </button>

                        <div id="advanced-options" class="hidden mt-4 space-y-6 animate-fade-in">

                            <!-- Market Assumptions - For Advanced Users -->
                            <div class="glass-card p-6">
                                <h4 class="text-lg font-semibold text-apple-text mb-4 flex items-center">
                                    <svg class="w-5 h-5 text-apple-blue mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                                    Market Assumptions
                                </h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-apple-textSecondary mb-2">
                                            Expected Return
                                            <button type="button" class="help-trigger info-icon" data-tooltip="Average annual investment return after inflation. Historical stock market: ~7%, balanced portfolio: ~5%."></button>
                                        </label>
                                        <div class="relative">
                                            <input type="text" id="expected-return-display" value="5.0"
                                                class="w-full pr-8">
                                            <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-apple-textTertiary">%</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-apple-textSecondary mb-2">
                                            Market Volatility
                                            <button type="button" class="help-trigger info-icon" data-tooltip="How much returns vary year-to-year. Higher = more uncertainty. Stocks: ~15-18%, bonds: ~5-7%."></button>
                                        </label>
                                        <div class="relative">
                                            <input type="text" id="volatility-display" value="12.0"
                                                class="w-full pr-8">
                                            <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-apple-textTertiary">%</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-apple-textSecondary mb-2">
                                            Inflation Rate
                                            <button type="button" class="help-trigger info-icon" data-tooltip="Expected long-term inflation. US historical average: ~2-3%. This affects your purchasing power over time."></button>
                                        </label>
                                        <div class="relative">
                                            <input type="text" id="inflation-rate-display" value="2.5"
                                                class="w-full pr-8">
                                            <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-apple-textTertiary">%</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-apple-textSecondary mb-2">
                                            Simulations
                                            <button type="button" class="help-trigger info-icon" data-tooltip="Number of different market scenarios to test. More = more accurate but slower. 10,000 is a good balance."></button>
                                        </label>
                                        <input type="text" id="monte-carlo-runs-display" value="10,000"
                                            class="w-full">
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-apple-textSecondary mb-2">
                                        Return Distribution
                                        <button type="button" class="help-trigger info-icon" data-tooltip="How market returns are distributed. 'Fat-tailed' includes more extreme events (crashes/booms) - more realistic but scarier results."></button>
                                    </label>
                                    <select id="return-distribution-display"
                                        class="w-full sm:w-auto">
                                        <option value="normal" selected>Standard (Normal Distribution)</option>
                                        <option value="fat-tailed">Realistic (Fat-Tailed - More Extremes)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Spending Constraints -->
                            <div class="glass-card p-6">
                                <h4 class="text-lg font-semibold text-apple-text mb-4 flex items-center">
                                    <svg class="w-5 h-5 text-apple-orange mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    Spending Limits
                                </h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-apple-textSecondary mb-2">
                                            Minimum Spending Floor
                                            <button type="button" class="help-trigger info-icon" data-tooltip="The least you're willing to spend per year, even in bad markets. Set to $0 if flexible."></button>
                                        </label>
                                        <div class="relative">
                                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-apple-textSecondary">$</span>
                                            <input type="text" id="min-spending" value="0"
                                                class="w-full pl-8">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-apple-textSecondary mb-2">
                                            Maximum Spending Cap
                                            <button type="button" class="help-trigger info-icon" data-tooltip="The most you'd spend per year, even in great markets. Helps preserve wealth. Set to $0 for no cap."></button>
                                        </label>
                                        <div class="relative">
                                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-apple-textSecondary">$</span>
                                            <input type="text" id="max-spending" value="0"
                                                class="w-full pl-8">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Big Purchases -->
                            <div class="glass-card p-6">
                                <h4 class="text-lg font-semibold text-apple-text mb-4 flex items-center">
                                    <svg class="w-5 h-5 text-purple-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                                    Big Purchases
                                    <button type="button" class="help-trigger info-icon" data-tooltip="Recurring large expenses like new cars, home renovations, or major trips. These are added on top of regular spending."></button>
                                </h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-apple-textSecondary mb-2">Amount</label>
                                        <div class="relative">
                                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-apple-textSecondary">$</span>
                                            <input type="text" id="one-time-expense" value="0"
                                                class="w-full pl-8">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-apple-textSecondary mb-2">First year</label>
                                        <input type="number" id="expense-first-year" value="5" min="1" max="50"
                                            class="w-full">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-apple-textSecondary mb-2">Every N years</label>
                                        <input type="number" id="expense-frequency" value="5" min="1" max="50"
                                            class="w-full">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-apple-textSecondary mb-2">Max times</label>
                                        <input type="number" id="expense-max-count" value="0" min="0" max="50"
                                            class="w-full"
                                            placeholder="0 = unlimited">
                                    </div>
                                </div>
                                <p class="text-sm text-apple-textTertiary mt-3">Example: $30,000 every 5 years for a new car</p>
                            </div>

                            <!-- Strategy Parameters -->
                            <div class="glass-card p-6">
                                <h4 class="text-lg font-semibold text-apple-text mb-4 flex items-center">
                                    <svg class="w-5 h-5 text-cyan-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                    Strategy Fine-Tuning
                                </h4>
                                <p class="text-sm text-apple-textSecondary mb-4">Customize the parameters for each withdrawal strategy. Leave blank to use defaults.</p>
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                    <div>
                                        <label class="block text-xs font-medium text-apple-textSecondary mb-2">4% Rule Rate</label>
                                        <div class="relative">
                                            <input type="text" id="constant-real-rate" value="4" placeholder="4"
                                                class="w-full pr-8 text-sm">
                                            <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-apple-textTertiary text-xs">%</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-apple-textSecondary mb-2">Constant % Rate</label>
                                        <div class="relative">
                                            <input type="text" id="constant-pct-rate" value="4.0" placeholder="4.0"
                                                class="w-full pr-8 text-sm">
                                            <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-apple-textTertiary text-xs">%</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-apple-textSecondary mb-2">Guardrails Rate</label>
                                        <div class="relative">
                                            <input type="text" id="guardrails-initial-rate" value="5.0" placeholder="5.0"
                                                class="w-full pr-8 text-sm">
                                            <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-apple-textTertiary text-xs">%</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-apple-textSecondary mb-2">VPW Stock %</label>
                                        <div class="relative">
                                            <input type="text" id="vpw-stock-allocation" value="60" placeholder="60"
                                                class="w-full pr-8 text-sm">
                                            <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-apple-textTertiary text-xs">%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-4 mt-4">
                                    <div>
                                        <label class="block text-xs font-medium text-apple-textSecondary mb-2">Guardrails Upper</label>
                                        <input type="text" id="guardrails-upper" value="1.2" placeholder="1.2"
                                            class="w-full text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-apple-textSecondary mb-2">Guardrails Lower</label>
                                        <input type="text" id="guardrails-lower" value="0.8" placeholder="0.8"
                                            class="w-full text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-apple-textSecondary mb-2">Guardrails Adj %</label>
                                        <div class="relative">
                                            <input type="text" id="guardrails-adjustment" value="10" placeholder="10"
                                                class="w-full pr-8 text-sm">
                                            <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-apple-textTertiary text-xs">%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Risk Tolerance -->
                            <div class="glass-card p-6">
                                <h4 class="text-lg font-semibold text-apple-text mb-4">Success Target</h4>
                                <label class="block text-sm font-medium text-apple-textSecondary mb-2">
                                    What success rate are you comfortable with?
                                    <button type="button" class="help-trigger info-icon" data-tooltip="The percentage of scenarios where your money lasts. 90%+ is conservative, 75-85% is moderate, below 75% is aggressive."></button>
                                </label>
                                <select id="risk-tolerance"
                                    class="w-full sm:w-auto">
                                    <option value="50">50% - I'm flexible and can adjust</option>
                                    <option value="75">75% - Some risk is okay</option>
                                    <option value="85" selected>85% - I want to feel secure</option>
                                    <option value="90">90% - I need high confidence</option>
                                    <option value="95">95% - I want maximum safety</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ============================================
                         STRATEGY SELECTION
                         ============================================ -->
                    <div class="glass-card p-6 sm:p-8 mb-6 stagger-item" style="animation-delay: 0.15s">
                        <h3 class="text-lg font-semibold text-apple-text mb-2">
                            Withdrawal Strategies
                        </h3>
                        <p class="text-sm text-apple-textSecondary mb-6">Select strategies to compare</p>

                        <div class="space-y-3">
                            <label class="flex items-start p-4 bg-apple-surface border border-apple-border rounded-xl hover:border-apple-green hover:shadow-md hover:-translate-y-0.5 cursor-pointer transition-all group">
                                <input type="checkbox" id="strategy-constant-real" checked class="mt-1 mr-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="font-semibold text-apple-text group-hover:text-apple-green transition-colors">4% Rule</span>
                                        <span class="text-xs font-medium text-apple-green bg-apple-greenLight px-2 py-0.5 rounded-full">Classic</span>
                                    </div>
                                    <p class="text-sm text-apple-textSecondary">Withdraw 4% initially, adjust for inflation each year</p>
                                </div>
                            </label>

                            <label class="flex items-start p-4 bg-apple-surface border border-apple-border rounded-xl hover:border-apple-blue hover:shadow-md hover:-translate-y-0.5 cursor-pointer transition-all group">
                                <input type="checkbox" id="strategy-constant-pct" checked class="mt-1 mr-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="font-semibold text-apple-text group-hover:text-apple-blue transition-colors">Constant %</span>
                                        <span class="text-xs font-medium text-apple-blue bg-apple-blueLight px-2 py-0.5 rounded-full">Flexible</span>
                                    </div>
                                    <p class="text-sm text-apple-textSecondary">Withdraw fixed percentage of current balance each year</p>
                                </div>
                            </label>

                            <label class="flex items-start p-4 bg-apple-surface border border-apple-border rounded-xl hover:border-apple-orange hover:shadow-md hover:-translate-y-0.5 cursor-pointer transition-all group">
                                <input type="checkbox" id="strategy-guardrails" checked class="mt-1 mr-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="font-semibold text-apple-text group-hover:text-apple-orange transition-colors">Guardrails</span>
                                        <span class="text-xs font-medium text-apple-orange bg-apple-orangeLight px-2 py-0.5 rounded-full">Adaptive</span>
                                    </div>
                                    <p class="text-sm text-apple-textSecondary">4% rule with automatic adjustments based on portfolio performance</p>
                                </div>
                            </label>

                            <label class="flex items-start p-4 bg-apple-surface border border-apple-border rounded-xl hover:border-purple-500 hover:shadow-md hover:-translate-y-0.5 cursor-pointer transition-all group">
                                <input type="checkbox" id="strategy-vpw" class="mt-1 mr-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="font-semibold text-apple-text group-hover:text-purple-400 transition-colors">Variable Percentage</span>
                                    </div>
                                    <p class="text-sm text-apple-textSecondary">Adjusts withdrawal rate based on remaining life expectancy</p>
                                </div>
                            </label>

                            <label class="flex items-start p-4 bg-apple-surface border border-apple-border rounded-xl hover:border-cyan-500 hover:shadow-md hover:-translate-y-0.5 cursor-pointer transition-all group">
                                <input type="checkbox" id="strategy-rmd" class="mt-1 mr-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="font-semibold text-apple-text group-hover:text-cyan-400 transition-colors">RMD Style</span>
                                    </div>
                                    <p class="text-sm text-apple-textSecondary">Based on IRS Required Minimum Distribution methodology</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Run Button - Apple Style with animations -->
                    <div class="mt-8 mb-6">
                        <div class="flex flex-col items-center gap-4">
                            <button id="run-simulation"
                                class="btn-apple btn-shimmer w-full sm:w-auto py-4 px-12 text-lg relative group jelly-hover"
                                aria-describedby="simulation-description">
                                <span class="btn-pulse-ring"></span>
                                <span class="relative z-10 flex items-center gap-3">
                                    <svg class="w-5 h-5 group-hover:animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    Run Simulation
                                </span>
                            </button>

                            <div class="flex flex-wrap items-center justify-center gap-4 mt-2">
                                <button id="copy-share-url"
                                    class="btn-apple-secondary py-3 px-5 rounded-xl text-sm font-medium"
                                    aria-label="Copy shareable URL to clipboard">
                                    <span class="flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                                        <span id="copy-share-text">Share</span>
                                    </span>
                                </button>
                                <label class="flex items-center gap-2 text-sm text-apple-textSecondary cursor-pointer hover:text-apple-blue transition-colors">
                                    <input type="checkbox" id="include-autorun">
                                    <span>Auto-run when opened</span>
                                </label>
                            </div>

                            <p id="simulation-description" class="sr-only">Runs Monte Carlo simulation with your configured assumptions</p>
                        </div>
                    </div>

                    <!-- Status Message -->
                    <div id="status-message" class="hidden mt-6"></div>
                </div>
            </div>

            <!-- ============================================
                 RESULTS PANEL - SHOWN AFTER SIMULATION
                 ============================================ -->
            <div id="results-panel" class="hidden animate-fade-in">
                <div class="max-w-5xl mx-auto">

                    <!-- Hero Result Section -->
                    <div id="results-hero" class="mb-8">
                        <!-- Populated by JavaScript with simulation results -->
                    </div>

                    <!-- Apple-style Tabs -->
                    <div class="bg-apple-surface rounded-2xl border border-apple-borderLight shadow-lg overflow-hidden">
                        <nav class="bg-apple-bgAlt border-b border-apple-borderLight">
                            <ul class="flex p-2 gap-2">
                                <li class="flex-1">
                                    <button class="tab-button active w-full"
                                        data-tab="summary">
                                        Overview
                                    </button>
                                </li>
                                <li class="flex-1">
                                    <button class="tab-button w-full"
                                        data-tab="charts">
                                        Charts
                                    </button>
                                </li>
                                <li class="flex-1">
                                    <button class="tab-button w-full"
                                        data-tab="details">
                                        Details
                                    </button>
                                </li>
                            </ul>
                        </nav>

                        <!-- Tab Content -->
                        <div class="p-4 sm:p-6 max-h-[calc(100vh-400px)] overflow-y-auto">

                        <!-- Tab: Overview (Summary) -->
                        <div class="tab-content active" id="tab-summary">
                            <!-- Populated by JavaScript -->
                        </div>

                        <!-- Tab: Charts -->
                        <div class="tab-content hidden" id="tab-charts">
                            <!-- Populated by JavaScript -->
                        </div>

                        <!-- Tab: All Details (combines report, tables, assumptions) -->
                        <div class="tab-content hidden" id="tab-details">
                            <!-- Expandable sections populated by JavaScript -->
                        </div>

                        <!-- Hidden tabs for backwards compatibility -->
                        <div class="hidden" id="tab-tables"></div>
                        <div class="hidden" id="tab-report"></div>
                        <div class="hidden" id="tab-assumptions"></div>

                    </div>
                </div>
                </div>
            </div>

        </main>

        <!-- Apple-style Footer with subtle animation -->
        <footer class="bg-apple-surface border-t border-apple-borderLight mt-auto">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <div class="flex flex-col sm:flex-row items-center justify-between gap-3 text-sm text-apple-textSecondary">
                    <div class="flex items-center gap-2">
                        <span class="animate-float" style="animation-duration: 3s"></span>
                        Monte Carlo Retirement Simulator
                    </div>
                    <div class="flex items-center gap-2 hover:text-apple-blue transition-colors cursor-default">
                        <span>Built for financial planning</span>
                        <span class="text-apple-textTertiary"></span>
                        <span class="text-xs text-apple-textTertiary">10,000 simulations per run</span>
                    </div>
                </div>
            </div>
        </footer>

    </div>

    <!-- Chart tooltip (hidden by default, shown on hover) -->
    <div id="chart-tooltip" class="hidden"></div>

    <!-- ============================================
         JAVASCRIPT APPLICATION CODE
         ============================================

         ARCHITECTURE OVERVIEW:
         ----------------------
         1. INPUT FORMATTING: Handles number/currency formatting
         2. SIMULATION ENGINE: Monte Carlo simulations for all strategies
         3. CHARTS MODULE: Canvas-based interactive charts with tooltips
         4. REPORT MODULE: Generates narrative recommendations
         5. UI MODULE: Manages application state and user interactions

         DATA FLOW:
         ----------
         User Inputs  Validation  Simulation Engine  Aggregation  [Charts, Tables, Report]

         ============================================ -->
    <script type="module">
        'use strict';

        // ============================================
        // GLOBAL STATE MANAGEMENT
        // ============================================
        // Stores simulation results for use across modules
        let globalResults = null;
        let globalInputs = null;

        // ============================================
        // INPUT FORMATTING UTILITIES
        // ============================================
        // Formats numbers with commas for readability
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // Parses formatted numbers back to raw values
        function parseFormattedNumber(str) {
            return parseFloat(str.replace(/,/g, ''));
        }

        /**
         * Sets up automatic number formatting for input fields
         * On focus: shows raw number for editing
         * On blur: formats with commas/symbols
         */
        function setupNumberInput(id, formatter, parser) {
            const input = document.getElementById(id);

            input.addEventListener('focus', function() {
                const val = parser(this.value);
                if (!isNaN(val)) {
                    this.value = val.toString();
                }
            });

            input.addEventListener('blur', function() {
                const val = parser(this.value);
                if (!isNaN(val)) {
                    this.value = formatter(val);
                }
            });
        }

        // Initialize formatters on page load
        document.addEventListener('DOMContentLoaded', () => {
            setupNumberInput('starting-portfolio', formatNumber, parseFormattedNumber);
            setupNumberInput('min-spending', formatNumber, parseFormattedNumber);
            setupNumberInput('one-time-expense', formatNumber, parseFormattedNumber);
            setupNumberInput('social-security', formatNumber, parseFormattedNumber);
            setupNumberInput('monte-carlo-runs', formatNumber, parseFormattedNumber);
        });

        // ============================================
        // SOCIAL SECURITY AUTO-ADJUSTMENT
        // Automatically adjusts SS benefit based on claiming age
        // Uses median US Social Security benefits (2024 data)
        // ============================================

        // Median SS benefits by claiming age (based on SSA data)
        // FRA (67) median benefit: ~$21,000/year
        // Reduction: 6.67%/year before 67 (first 3 years), 5%/year for years 4-5
        // Increase: 8%/year after 67 until age 70
        const ssMedianBenefitsByAge = {
            62: 14700,   // 70% of FRA (30% reduction for claiming 5 years early)
            63: 15750,   // 75% of FRA
            64: 16800,   // 80% of FRA
            65: 18200,   // 86.7% of FRA
            66: 19600,   // 93.3% of FRA
            67: 21000,   // 100% of FRA (Full Retirement Age)
            68: 22680,   // 108% of FRA
            69: 24360,   // 116% of FRA
            70: 26040    // 124% of FRA (maximum benefit)
        };

        // Track if user has manually edited SS amount
        let ssManuallyEdited = false;
        let ssUserIsFocused = false;

        // Initialize SS auto-adjustment
        document.addEventListener('DOMContentLoaded', () => {
            const ssAgeSelect = document.getElementById('ss-start-age');
            const ssAmountInput = document.getElementById('social-security');

            if (ssAgeSelect && ssAmountInput) {
                // When user changes SS start age, auto-update amount (unless manually edited)
                ssAgeSelect.addEventListener('change', function() {
                    if (!ssManuallyEdited) {
                        const age = parseInt(this.value);
                        const benefit = ssMedianBenefitsByAge[age] || ssMedianBenefitsByAge[67];
                        ssAmountInput.value = formatNumber(benefit);
                    }
                });

                // Track when user focuses the SS input (about to edit)
                ssAmountInput.addEventListener('focus', function() {
                    ssUserIsFocused = true;
                });

                // When user leaves the field, check if they changed it from the default
                ssAmountInput.addEventListener('blur', function() {
                    if (ssUserIsFocused) {
                        const currentValue = parseFormattedNumber(ssAmountInput.value);
                        const age = parseInt(ssAgeSelect.value);
                        const expectedDefault = ssMedianBenefitsByAge[age] || ssMedianBenefitsByAge[67];

                        // If value differs from expected default, mark as manually edited
                        if (Math.abs(currentValue - expectedDefault) > 1) {
                            ssManuallyEdited = true;
                        }
                        ssUserIsFocused = false;
                    }
                });

                // Add a reset button/link to revert to median
                const ssContainer = ssAmountInput.closest('div').parentElement;
                const resetLink = document.createElement('button');
                resetLink.type = 'button';
                resetLink.className = 'text-xs text-apple-blue hover:text-apple-blueHover mt-1 underline';
                resetLink.textContent = 'Use median for my age';
                resetLink.addEventListener('click', function() {
                    const age = parseInt(ssAgeSelect.value);
                    const benefit = ssMedianBenefitsByAge[age] || ssMedianBenefitsByAge[67];
                    ssAmountInput.value = formatNumber(benefit);
                    ssManuallyEdited = false;
                });
                ssContainer.appendChild(resetLink);

                // After URL params are loaded, check if SS value matches expected default
                // This runs after a small delay to allow URL params to be applied first
                setTimeout(() => {
                    const currentValue = parseFormattedNumber(ssAmountInput.value);
                    const age = parseInt(ssAgeSelect.value);
                    const expectedDefault = ssMedianBenefitsByAge[age] || ssMedianBenefitsByAge[67];

                    // If URL loaded a custom value, mark as manually edited
                    if (Math.abs(currentValue - expectedDefault) > 1) {
                        ssManuallyEdited = true;
                    }
                }, 100);
            }
        });

        // ============================================
        // TYPE DEFINITIONS (JSDoc for type safety)
        // ============================================

        /**
         * @typedef {Object} Inputs
         * @property {number} retirementAge
         * @property {number} planningAge
         * @property {number} startingPortfolio
         * @property {number} expectedReturn - Real return % per year
         * @property {number} volatility - Standard deviation %
         * @property {number} inflationRate - % per year
         * @property {number} monteCarloRuns
         * @property {number} minSpending
         * @property {number} socialSecurity
         * @property {number} ssStartAge
         * @property {number} targetSuccessRate
         * @property {string[]} strategies
         */

        /**
         * @typedef {Object} YearResult
         * @property {number} year - Year index (0-based)
         * @property {number} age - Retiree's age
         * @property {number} portfolioStart - Portfolio value at start of year
         * @property {number} returnPct - Annual return percentage
         * @property {number} withdrawal - Annual withdrawal amount
         * @property {number} portfolioEnd - Portfolio value at end of year
         * @property {boolean} ruined - Whether portfolio hit zero
         */

        /**
         * @typedef {Object} PathResult
         * @property {YearResult[]} years
         * @property {number} finalBalance
         * @property {number} totalWithdrawals
         * @property {boolean} ruined
         * @property {number} ruinAge
         */

        /**
         * @typedef {Object} StrategyResult
         * @property {string} name
         * @property {PathResult[]} paths
         * @property {number} successRate
         * @property {number} medianFinal
         * @property {number} p10Final
         * @property {number} p90Final
         * @property {number} medianWithdrawals
         * @property {YearResult[]} medianPath
         */

        // ============================================
        // SIMULATION ENGINE
        // Core Monte Carlo simulation that runs thousands of retirement scenarios.
        // Each scenario uses random market returns drawn from a normal distribution
        // to test if your portfolio survives the full retirement period.
        // All dollar values are computed in "real" (inflation-adjusted) terms.
        // ============================================
        const Simulation = {
            /**
             * Box-Muller transform: converts uniform random numbers to normal distribution.
             * This gives us realistic market return variation (most years near average,
             * occasional extreme years). Essential for accurate Monte Carlo simulation.
             */
            randomNormal() {
                let u = 0, v = 0;
                while (u === 0) u = Math.random(); // Avoid log(0)
                while (v === 0) v = Math.random();
                return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            },

            /**
             * Generates a random number from Student's t distribution
             * Uses the ratio of uniforms method for df=4 (fat tails)
             * @param {number} df - Degrees of freedom (lower = fatter tails)
             * @returns {number} Random value from t-distribution
             */
            randomStudentT(df = 4) {
                // Generate t-distributed random using chi-squared transformation
                // t = Z / sqrt(V/df) where Z ~ N(0,1) and V ~ chi-squared(df)
                const z = this.randomNormal();

                // Generate chi-squared(df) as sum of df squared normals
                let chiSq = 0;
                for (let i = 0; i < df; i++) {
                    const n = this.randomNormal();
                    chiSq += n * n;
                }

                return z / Math.sqrt(chiSq / df);
            },

            /**
             * Generates annual return based on mean and volatility
             * @param {number} mean - Expected return %
             * @param {number} volatility - Standard deviation %
             * @param {boolean} deterministic - If true, return mean (for median path)
             * @param {string} distribution - 'normal' or 'fat-tailed'
             * @returns {number} Annual return as decimal
             */
            generateReturn(mean, volatility, deterministic = false, distribution = 'normal') {
                if (deterministic) return mean / 100;

                let z;
                if (distribution === 'fat-tailed') {
                    // Student's t with df=4: fatter tails than normal
                    // Scale by sqrt(df/(df-2)) to normalize variance to 1
                    const df = 4;
                    z = this.randomStudentT(df) * Math.sqrt((df - 2) / df);
                } else {
                    z = this.randomNormal();
                }

                return (mean + z * volatility) / 100;
            },

            /**
             * IRS Uniform Lifetime Table - Life Expectancy by Age
             * Used for RMD-style withdrawal calculations.
             * Values are approximate and based on IRS Publication 590-B.
             * Linear interpolation is used between table entries for smooth results.
             *
             * Key properties:
             * - Monotonically decreasing (life expectancy never increases with age)
             * - Minimum return value of 2.0 years to avoid excessive withdrawal rates
             * - Realistic values matching IRS tables
             */
            _lifeExpectancyTable: [
                { age: 20, expectancy: 63.0 },
                { age: 30, expectancy: 53.3 },
                { age: 40, expectancy: 43.6 },
                { age: 50, expectancy: 34.2 },
                { age: 55, expectancy: 29.6 },
                { age: 60, expectancy: 25.2 },
                { age: 65, expectancy: 21.0 },
                { age: 70, expectancy: 17.0 },
                { age: 72, expectancy: 15.5 },  // RMD start age
                { age: 75, expectancy: 13.4 },
                { age: 80, expectancy: 10.2 },
                { age: 85, expectancy: 7.6 },
                { age: 90, expectancy: 5.3 },
                { age: 95, expectancy: 3.7 },
                { age: 100, expectancy: 2.7 },
                { age: 105, expectancy: 2.2 },
                { age: 110, expectancy: 2.0 },
                { age: 120, expectancy: 2.0 }   // Cap at minimum
            ],

            /**
             * Returns expected years remaining at given age.
             * Uses linear interpolation between IRS Uniform Lifetime Table values.
             * Always returns at least 2.0 years to avoid excessive withdrawal rates.
             *
             * @param {number} age - Current age in years
             * @returns {number} - Expected years remaining (float, minimum 2.0)
             */
            lifeExpectancy(age) {
                const table = this._lifeExpectancyTable;

                // Clamp age to table bounds
                if (age <= table[0].age) {
                    return table[0].expectancy;
                }
                if (age >= table[table.length - 1].age) {
                    return Math.max(2.0, table[table.length - 1].expectancy);
                }

                // Find the two table entries to interpolate between
                for (let i = 0; i < table.length - 1; i++) {
                    if (age >= table[i].age && age < table[i + 1].age) {
                        const ageLow = table[i].age;
                        const ageHigh = table[i + 1].age;
                        const expLow = table[i].expectancy;
                        const expHigh = table[i + 1].expectancy;

                        // Linear interpolation
                        const fraction = (age - ageLow) / (ageHigh - ageLow);
                        const expectancy = expLow + fraction * (expHigh - expLow);

                        return Math.max(2.0, expectancy);
                    }
                }

                // Fallback (should never reach here)
                return 2.0;
            },

            /**
             * VPW (Variable Percentage Withdrawal) lookup table
             * Withdrawal % increases with age and stock allocation
             */
            vpwPercentage(yearsRemaining, stockAllocation = 60) {
                if (yearsRemaining >= 30) return 3.0 + stockAllocation * 0.02;
                if (yearsRemaining >= 25) return 3.5 + stockAllocation * 0.02;
                if (yearsRemaining >= 20) return 4.0 + stockAllocation * 0.025;
                if (yearsRemaining >= 15) return 5.0 + stockAllocation * 0.03;
                if (yearsRemaining >= 10) return 6.5 + stockAllocation * 0.035;
                if (yearsRemaining >= 5) return 9.0 + stockAllocation * 0.04;
                return Math.min(100, 20.0 + yearsRemaining * 2);
            },

            /**
             * Calculates periodic expense for a given year
             * @param {number} yearIndex - Year index (0-based)
             * @param {object} inputs - Input parameters
             * @param {number} inflationMultiplier - Inflation multiplier
             * @returns {number} Expense amount for this year (0 if not an expense year)
             */
            calculatePeriodicExpense(yearIndex, inputs, inflationMultiplier) {
                if (!inputs.oneTimeExpense || inputs.oneTimeExpense <= 0) return 0;

                const firstExpenseYear = (inputs.expenseFirstYear || 5) - 1; // Convert to 0-based
                const frequency = inputs.expenseFrequency || 5;
                const maxCount = inputs.expenseMaxCount || 0; // 0 = unlimited

                // Check if this is an expense year
                if (yearIndex < firstExpenseYear) return 0;

                const yearsSinceFirst = yearIndex - firstExpenseYear;
                if (yearsSinceFirst % frequency !== 0) return 0;

                // Check max count limit
                if (maxCount > 0) {
                    const expenseNumber = Math.floor(yearsSinceFirst / frequency) + 1;
                    if (expenseNumber > maxCount) return 0;
                }

                return inputs.oneTimeExpense * Math.pow(inflationMultiplier, yearIndex);
            },

            /**
             * STRATEGY 1: Constant Real Withdrawal (4% Rule)
             * Withdraws the GREATER of: configured rate of initial portfolio OR minSpending.
             * Amount is then inflation-adjusted each year to maintain purchasing power.
             */
            strategyConstantReal(inputs, deterministic = false) {
                const years = inputs.planningAge - inputs.retirementAge;
                const initialRate = inputs.constantRealRate || 4;
                const inflationMultiplier = 1 + inputs.inflationRate / 100;

                // Use startingWithdrawal if specified, otherwise use configured rate
                let baseWithdrawal;
                if (inputs.startingWithdrawal && inputs.startingWithdrawal > 0) {
                    baseWithdrawal = inputs.startingWithdrawal;
                } else {
                    baseWithdrawal = inputs.startingPortfolio * (initialRate / 100);
                }

                // Apply min/max spending constraints
                let initialWithdrawal = Math.max(baseWithdrawal, inputs.minSpending || 0);
                if (inputs.maxSpending && inputs.maxSpending > 0) {
                    initialWithdrawal = Math.min(initialWithdrawal, inputs.maxSpending);
                }

                let portfolio = inputs.startingPortfolio;
                let withdrawal = initialWithdrawal;
                const yearResults = [];
                let ruined = false;
                let ruinAge = null;

                const baseMaxSpending = inputs.maxSpending || 0;

                for (let i = 0; i < years; i++) {
                    const age = inputs.retirementAge + i;
                    const portfolioStart = portfolio;

                    // If already ruined, no more withdrawals
                    if (ruined) {
                        const returnPct = this.generateReturn(inputs.expectedReturn, inputs.volatility, deterministic, inputs.returnDistribution);
                        portfolio *= (1 + returnPct);
                        yearResults.push({
                            year: i,
                            age,
                            portfolioStart,
                            returnPct: returnPct * 100,
                            withdrawal: 0,
                            portfolioEnd: portfolio,
                            ruined: true
                        });
                        continue;
                    }

                    // Apply max spending cap (inflation-adjusted) if specified
                    if (baseMaxSpending > 0) {
                        const inflationAdjustedMaxSpending = baseMaxSpending * Math.pow(inflationMultiplier, i);
                        withdrawal = Math.min(withdrawal, inflationAdjustedMaxSpending);
                    }

                    // Periodic expense (inflation-adjusted)
                    const oneTimeExpenseThisYear = this.calculatePeriodicExpense(i, inputs, inflationMultiplier);

                    // Social Security reduces portfolio withdrawal needs (with COLA adjustment)
                    const ssYearsReceiving = Math.max(0, age - inputs.ssStartAge);
                    const ss = (age >= inputs.ssStartAge) ? inputs.socialSecurity * Math.pow(inflationMultiplier, ssYearsReceiving) : 0;
                    const netWithdrawal = Math.max(0, withdrawal - ss) + oneTimeExpenseThisYear;
                    // Total spending includes both portfolio withdrawal and SS
                    const totalSpending = withdrawal + oneTimeExpenseThisYear;

                    // Apply withdrawal
                    portfolio -= netWithdrawal;

                    if (portfolio < 0) {
                        portfolio = 0;
                        ruined = true;
                        ruinAge = age;
                    }

                    // Apply investment return
                    const returnPct = this.generateReturn(inputs.expectedReturn, inputs.volatility, deterministic, inputs.returnDistribution);
                    portfolio *= (1 + returnPct);

                    yearResults.push({
                        year: i,
                        age,
                        portfolioStart,
                        returnPct: returnPct * 100,
                        withdrawal: totalSpending,  // Show total spending for charts
                        portfolioEnd: portfolio,
                        ruined: portfolio <= 0
                    });

                    if (portfolio <= 0 && !ruined) {
                        ruined = true;
                        ruinAge = age;
                    }

                    // Inflate withdrawal for next year to maintain purchasing power
                    withdrawal *= inflationMultiplier;
                }

                return {
                    years: yearResults,
                    finalBalance: portfolio,
                    totalWithdrawals: yearResults.reduce((sum, y) => sum + y.withdrawal, 0),
                    ruined,
                    ruinAge
                };
            },

            /**
             * STRATEGY 2: Constant Percentage of Portfolio
             * Withdraws configured % of current portfolio each year, but never less than minSpending.
             * Self-adjusting to market conditions while maintaining minimum lifestyle.
             */
            strategyConstantPercent(inputs, deterministic = false) {
                const years = inputs.planningAge - inputs.retirementAge;
                const withdrawalRate = inputs.constantPctRate || 4.0;
                const inflationMultiplier = 1 + inputs.inflationRate / 100;
                const baseMinSpending = inputs.minSpending || 0;
                const baseMaxSpending = inputs.maxSpending || 0;
                const baseStartingWithdrawal = inputs.startingWithdrawal || 0;

                let portfolio = inputs.startingPortfolio;
                const yearResults = [];
                let ruined = false;
                let ruinAge = null;

                for (let i = 0; i < years; i++) {
                    const age = inputs.retirementAge + i;
                    const portfolioStart = portfolio;

                    // If already ruined, no more withdrawals
                    if (ruined) {
                        const returnPct = this.generateReturn(inputs.expectedReturn, inputs.volatility, deterministic, inputs.returnDistribution);
                        portfolio *= (1 + returnPct);
                        yearResults.push({
                            year: i,
                            age,
                            portfolioStart,
                            returnPct: returnPct * 100,
                            withdrawal: 0,
                            portfolioEnd: portfolio,
                            ruined: true
                        });
                        continue;
                    }

                    // Min/max spending grows with inflation to maintain purchasing power
                    const inflationAdjustedMinSpending = baseMinSpending * Math.pow(inflationMultiplier, i);
                    const inflationAdjustedMaxSpending = baseMaxSpending > 0 ? baseMaxSpending * Math.pow(inflationMultiplier, i) : Infinity;

                    // Periodic expense (inflation-adjusted)
                    const oneTimeExpenseThisYear = this.calculatePeriodicExpense(i, inputs, inflationMultiplier);

                    // Social Security with COLA adjustment
                    const ssYearsReceiving = Math.max(0, age - inputs.ssStartAge);
                    const ss = (age >= inputs.ssStartAge) ? inputs.socialSecurity * Math.pow(inflationMultiplier, ssYearsReceiving) : 0;

                    // Year 1: Use startingWithdrawal if specified, otherwise use configured % of portfolio
                    // Years 2+: Use configured % of current portfolio (the strategy's natural behavior)
                    let targetWithdrawal;
                    if (i === 0 && baseStartingWithdrawal > 0) {
                        targetWithdrawal = baseStartingWithdrawal;
                    } else {
                        targetWithdrawal = portfolio * (withdrawalRate / 100);
                    }
                    // Apply min/max spending constraints
                    targetWithdrawal = Math.max(targetWithdrawal, inflationAdjustedMinSpending);
                    targetWithdrawal = Math.min(targetWithdrawal, inflationAdjustedMaxSpending);
                    const netWithdrawal = Math.max(0, targetWithdrawal - ss) + oneTimeExpenseThisYear;
                    // Total spending includes both portfolio withdrawal and SS
                    const totalSpending = targetWithdrawal + oneTimeExpenseThisYear;

                    portfolio -= netWithdrawal;

                    if (portfolio < 0) {
                        portfolio = 0;
                        ruined = true;
                        ruinAge = age;
                    }

                    const returnPct = this.generateReturn(inputs.expectedReturn, inputs.volatility, deterministic, inputs.returnDistribution);
                    portfolio *= (1 + returnPct);

                    yearResults.push({
                        year: i,
                        age,
                        portfolioStart,
                        returnPct: returnPct * 100,
                        withdrawal: totalSpending,  // Show total spending for charts
                        portfolioEnd: portfolio,
                        ruined: portfolio <= 0
                    });

                    if (portfolio <= 0 && !ruined) {
                        ruined = true;
                        ruinAge = age;
                    }
                }

                return {
                    years: yearResults,
                    finalBalance: portfolio,
                    totalWithdrawals: yearResults.reduce((sum, y) => sum + y.withdrawal, 0),
                    ruined,
                    ruinAge
                };
            },

            /**
             * STRATEGY 3: Variable Percentage Withdrawal (VPW)
             * Withdrawal % increases with age based on life expectancy.
             * Never withdraws less than minSpending (inflation-adjusted).
             */
            strategyVPW(inputs, deterministic = false) {
                const years = inputs.planningAge - inputs.retirementAge;
                const inflationMultiplier = 1 + inputs.inflationRate / 100;
                const baseMinSpending = inputs.minSpending || 0;
                const baseMaxSpending = inputs.maxSpending || 0;
                const baseStartingWithdrawal = inputs.startingWithdrawal || 0;
                const stockAllocation = inputs.vpwStockAllocation || 60;

                let portfolio = inputs.startingPortfolio;
                const yearResults = [];
                let ruined = false;
                let ruinAge = null;

                for (let i = 0; i < years; i++) {
                    const age = inputs.retirementAge + i;
                    const portfolioStart = portfolio;

                    // If already ruined, no more withdrawals
                    if (ruined) {
                        const returnPct = this.generateReturn(inputs.expectedReturn, inputs.volatility, deterministic, inputs.returnDistribution);
                        portfolio *= (1 + returnPct);
                        yearResults.push({
                            year: i,
                            age,
                            portfolioStart,
                            returnPct: returnPct * 100,
                            withdrawal: 0,
                            portfolioEnd: portfolio,
                            ruined: true
                        });
                        continue;
                    }

                    const inflationAdjustedMinSpending = baseMinSpending * Math.pow(inflationMultiplier, i);
                    const inflationAdjustedMaxSpending = baseMaxSpending > 0 ? baseMaxSpending * Math.pow(inflationMultiplier, i) : Infinity;

                    // Periodic expense (inflation-adjusted)
                    const oneTimeExpenseThisYear = this.calculatePeriodicExpense(i, inputs, inflationMultiplier);

                    // Social Security with COLA adjustment
                    const ssYearsReceiving = Math.max(0, age - inputs.ssStartAge);
                    const ss = (age >= inputs.ssStartAge) ? inputs.socialSecurity * Math.pow(inflationMultiplier, ssYearsReceiving) : 0;

                    // Year 1: Use startingWithdrawal if specified, otherwise use VPW calculation
                    // Years 2+: Use VPW calculation (the strategy's natural behavior)
                    let targetWithdrawal;
                    if (i === 0 && baseStartingWithdrawal > 0) {
                        targetWithdrawal = baseStartingWithdrawal;
                    } else {
                        const yearsRemaining = inputs.planningAge - age;
                        const vpwPct = this.vpwPercentage(yearsRemaining, stockAllocation);
                        targetWithdrawal = portfolio * (vpwPct / 100);
                    }
                    // Apply min/max spending constraints
                    targetWithdrawal = Math.max(targetWithdrawal, inflationAdjustedMinSpending);
                    targetWithdrawal = Math.min(targetWithdrawal, inflationAdjustedMaxSpending);
                    const netWithdrawal = Math.max(0, targetWithdrawal - ss) + oneTimeExpenseThisYear;
                    // Total spending includes both portfolio withdrawal and SS
                    const totalSpending = targetWithdrawal + oneTimeExpenseThisYear;

                    portfolio -= netWithdrawal;

                    if (portfolio < 0) {
                        portfolio = 0;
                        ruined = true;
                        ruinAge = age;
                    }

                    const returnPct = this.generateReturn(inputs.expectedReturn, inputs.volatility, deterministic, inputs.returnDistribution);
                    portfolio *= (1 + returnPct);

                    yearResults.push({
                        year: i,
                        age,
                        portfolioStart,
                        returnPct: returnPct * 100,
                        withdrawal: totalSpending,  // Show total spending for charts
                        portfolioEnd: portfolio,
                        ruined: portfolio <= 0
                    });

                    if (portfolio <= 0 && !ruined) {
                        ruined = true;
                        ruinAge = age;
                    }
                }

                return {
                    years: yearResults,
                    finalBalance: portfolio,
                    totalWithdrawals: yearResults.reduce((sum, y) => sum + y.withdrawal, 0),
                    ruined,
                    ruinAge
                };
            },

            /**
             * STRATEGY 4: Guardrails (Guyton-Klinger)
             * Adjusts spending when withdrawal rate crosses thresholds.
             * Initial withdrawal is the greater of configured rate of portfolio or minSpending.
             * Guardrails can adjust spending but never below minSpending floor.
             */
            strategyGuardrails(inputs, deterministic = false) {
                const years = inputs.planningAge - inputs.retirementAge;
                const initialRate = inputs.guardrailsInitialRate || 5.0;
                const upperMultiplier = inputs.guardrailsUpper || 1.2;
                const lowerMultiplier = inputs.guardrailsLower || 0.8;
                const upperGuardrail = initialRate * upperMultiplier;
                const lowerGuardrail = initialRate * lowerMultiplier;
                const adjustmentFactor = (inputs.guardrailsAdjustment || 10.0) / 100;
                const inflationMultiplier = 1 + inputs.inflationRate / 100;
                const baseMinSpending = inputs.minSpending || 0;
                const baseMaxSpending = inputs.maxSpending || 0;

                let portfolio = inputs.startingPortfolio;

                // Use startingWithdrawal if specified, otherwise use configured rate
                let baseWithdrawal;
                if (inputs.startingWithdrawal && inputs.startingWithdrawal > 0) {
                    baseWithdrawal = inputs.startingWithdrawal;
                } else {
                    baseWithdrawal = inputs.startingPortfolio * (initialRate / 100);
                }

                // Apply min/max spending constraints to initial withdrawal
                let withdrawal = Math.max(baseWithdrawal, baseMinSpending);
                if (baseMaxSpending > 0) {
                    withdrawal = Math.min(withdrawal, baseMaxSpending);
                }

                const yearResults = [];
                let ruined = false;
                let ruinAge = null;

                for (let i = 0; i < years; i++) {
                    const age = inputs.retirementAge + i;
                    const portfolioStart = portfolio;

                    // If already ruined, no more withdrawals
                    if (ruined) {
                        const returnPct = this.generateReturn(inputs.expectedReturn, inputs.volatility, deterministic, inputs.returnDistribution);
                        portfolio *= (1 + returnPct);
                        yearResults.push({
                            year: i,
                            age,
                            portfolioStart,
                            returnPct: returnPct * 100,
                            withdrawal: 0,
                            portfolioEnd: portfolio,
                            ruined: true
                        });
                        continue;
                    }

                    const inflationAdjustedMinSpending = baseMinSpending * Math.pow(inflationMultiplier, i);
                    const inflationAdjustedMaxSpending = baseMaxSpending > 0 ? baseMaxSpending * Math.pow(inflationMultiplier, i) : Infinity;

                    // Periodic expense (inflation-adjusted)
                    const oneTimeExpenseThisYear = this.calculatePeriodicExpense(i, inputs, inflationMultiplier);

                    // Social Security with COLA adjustment
                    const ssYearsReceiving = Math.max(0, age - inputs.ssStartAge);
                    const ss = (age >= inputs.ssStartAge) ? inputs.socialSecurity * Math.pow(inflationMultiplier, ssYearsReceiving) : 0;

                    // Check if withdrawal rate is outside guardrails
                    const currentRate = (withdrawal / portfolioStart) * 100;

                    // Don't apply guardrails in Year 1 if user specified startingWithdrawal
                    // (respect the user's explicit Year 1 choice)
                    const skipGuardrailsYear1 = (i === 0 && inputs.startingWithdrawal && inputs.startingWithdrawal > 0);

                    if (!skipGuardrailsYear1) {
                        if (currentRate > upperGuardrail) {
                            withdrawal *= (1 - adjustmentFactor); // Reduce spending
                        } else if (currentRate < lowerGuardrail && portfolio > 0) {
                            withdrawal *= (1 + adjustmentFactor); // Increase spending
                        }
                    }

                    // Apply min/max spending constraints
                    withdrawal = Math.max(withdrawal, inflationAdjustedMinSpending);
                    withdrawal = Math.min(withdrawal, inflationAdjustedMaxSpending);

                    const netWithdrawal = Math.max(0, withdrawal - ss) + oneTimeExpenseThisYear;
                    // Total spending includes both portfolio withdrawal and SS
                    const totalSpending = withdrawal + oneTimeExpenseThisYear;

                    portfolio -= netWithdrawal;

                    if (portfolio < 0) {
                        portfolio = 0;
                        ruined = true;
                        ruinAge = age;
                    }

                    const returnPct = this.generateReturn(inputs.expectedReturn, inputs.volatility, deterministic, inputs.returnDistribution);
                    portfolio *= (1 + returnPct);

                    yearResults.push({
                        year: i,
                        age,
                        portfolioStart,
                        returnPct: returnPct * 100,
                        withdrawal: totalSpending,  // Show total spending for charts
                        portfolioEnd: portfolio,
                        ruined: portfolio <= 0
                    });

                    if (portfolio <= 0 && !ruined) {
                        ruined = true;
                        ruinAge = age;
                    }

                    // Inflate base withdrawal for next year
                    withdrawal *= inflationMultiplier;
                }

                return {
                    years: yearResults,
                    finalBalance: portfolio,
                    totalWithdrawals: yearResults.reduce((sum, y) => sum + y.withdrawal, 0),
                    ruined,
                    ruinAge
                };
            },

            /**
             * STRATEGY 5: RMD / Life Expectancy
             * Divides portfolio by remaining life expectancy each year.
             * Never withdraws less than minSpending (inflation-adjusted).
             */
            strategyRMD(inputs, deterministic = false) {
                const years = inputs.planningAge - inputs.retirementAge;
                const inflationMultiplier = 1 + inputs.inflationRate / 100;
                const baseMinSpending = inputs.minSpending || 0;
                const baseMaxSpending = inputs.maxSpending || 0;
                const baseStartingWithdrawal = inputs.startingWithdrawal || 0;

                let portfolio = inputs.startingPortfolio;
                const yearResults = [];
                let ruined = false;
                let ruinAge = null;

                for (let i = 0; i < years; i++) {
                    const age = inputs.retirementAge + i;
                    const portfolioStart = portfolio;

                    // If already ruined, no more withdrawals
                    if (ruined) {
                        const returnPct = this.generateReturn(inputs.expectedReturn, inputs.volatility, deterministic, inputs.returnDistribution);
                        portfolio *= (1 + returnPct);
                        yearResults.push({
                            year: i,
                            age,
                            portfolioStart,
                            returnPct: returnPct * 100,
                            withdrawal: 0,
                            portfolioEnd: portfolio,
                            ruined: true
                        });
                        continue;
                    }

                    const inflationAdjustedMinSpending = baseMinSpending * Math.pow(inflationMultiplier, i);
                    const inflationAdjustedMaxSpending = baseMaxSpending > 0 ? baseMaxSpending * Math.pow(inflationMultiplier, i) : Infinity;

                    // Periodic expense (inflation-adjusted)
                    const oneTimeExpenseThisYear = this.calculatePeriodicExpense(i, inputs, inflationMultiplier);

                    // Social Security with COLA adjustment
                    const ssYearsReceiving = Math.max(0, age - inputs.ssStartAge);
                    const ss = (age >= inputs.ssStartAge) ? inputs.socialSecurity * Math.pow(inflationMultiplier, ssYearsReceiving) : 0;

                    // Year 1: Use startingWithdrawal if specified, otherwise use RMD calculation
                    // Years 2+: Use RMD calculation (the strategy's natural behavior)
                    let targetWithdrawal;
                    if (i === 0 && baseStartingWithdrawal > 0) {
                        targetWithdrawal = baseStartingWithdrawal;
                    } else {
                        const lifeExp = this.lifeExpectancy(age);
                        targetWithdrawal = portfolio / lifeExp;
                    }
                    // Apply min/max spending constraints
                    targetWithdrawal = Math.max(targetWithdrawal, inflationAdjustedMinSpending);
                    targetWithdrawal = Math.min(targetWithdrawal, inflationAdjustedMaxSpending);
                    const netWithdrawal = Math.max(0, targetWithdrawal - ss) + oneTimeExpenseThisYear;
                    // Total spending includes both portfolio withdrawal and SS
                    const totalSpending = targetWithdrawal + oneTimeExpenseThisYear;

                    portfolio -= netWithdrawal;

                    if (portfolio < 0) {
                        portfolio = 0;
                        ruined = true;
                        ruinAge = age;
                    }

                    const returnPct = this.generateReturn(inputs.expectedReturn, inputs.volatility, deterministic, inputs.returnDistribution);
                    portfolio *= (1 + returnPct);

                    yearResults.push({
                        year: i,
                        age,
                        portfolioStart,
                        returnPct: returnPct * 100,
                        withdrawal: totalSpending,  // Show total spending for charts
                        portfolioEnd: portfolio,
                        ruined: portfolio <= 0
                    });

                    if (portfolio <= 0 && !ruined) {
                        ruined = true;
                        ruinAge = age;
                    }
                }

                return {
                    years: yearResults,
                    finalBalance: portfolio,
                    totalWithdrawals: yearResults.reduce((sum, y) => sum + y.withdrawal, 0),
                    ruined,
                    ruinAge
                };
            },

            /**
             * Runs Monte Carlo simulation for a given strategy
             * Executes thousands of scenarios with random returns
             */
            runStrategy(strategyName, inputs) {
                const strategyMap = {
                    'constant-real': this.strategyConstantReal,
                    'constant-pct': this.strategyConstantPercent,
                    'vpw': this.strategyVPW,
                    'guardrails': this.strategyGuardrails,
                    'rmd': this.strategyRMD
                };

                const strategy = strategyMap[strategyName];
                if (!strategy) throw new Error(`Unknown strategy: ${strategyName}`);

                const paths = [];

                // Run Monte Carlo simulations
                for (let i = 0; i < inputs.monteCarloRuns; i++) {
                    paths.push(strategy.call(this, inputs, false));
                }

                // Calculate aggregate statistics
                const failedPaths = paths.filter(p => p.ruined);
                const successfulPaths = paths.filter(p => !p.ruined);
                const successRate = (successfulPaths.length / paths.length) * 100;
                const failureRate = (failedPaths.length / paths.length) * 100;

                // Failure metrics
                let avgFailureAge = null;
                let avgFailureSeverity = null;
                if (failedPaths.length > 0) {
                    const failureAges = failedPaths.map(p => p.ruinAge);
                    avgFailureAge = failureAges.reduce((sum, age) => sum + age, 0) / failureAges.length;

                    // Severity = years of shortfall (planningAge - ruinAge)
                    const severities = failedPaths.map(p => inputs.planningAge - p.ruinAge);
                    avgFailureSeverity = severities.reduce((sum, s) => sum + s, 0) / severities.length;
                }

                const finalBalances = paths.map(p => p.finalBalance).sort((a, b) => a - b);
                const totalWithdrawals = paths.map(p => p.totalWithdrawals).sort((a, b) => a - b);

                const medianFinal = this.percentile(finalBalances, 50);
                const p10Final = this.percentile(finalBalances, 10);
                const p75Final = this.percentile(finalBalances, 75);
                const p90Final = this.percentile(finalBalances, 90);
                const p95Final = this.percentile(finalBalances, 95);
                const medianWithdrawals = this.percentile(totalWithdrawals, 50);
                const p75Withdrawals = this.percentile(totalWithdrawals, 75);
                const p90Withdrawals = this.percentile(totalWithdrawals, 90);
                const p95Withdrawals = this.percentile(totalWithdrawals, 95);

                // Find a representative path from Monte Carlo simulations
                // If there are successful simulations, show the median of SUCCESSFUL paths
                // This ensures charts show realistic successful scenarios, not failed ones
                let medianPath;
                let medianPathFailed = false;

                if (successfulPaths.length > 0) {
                    // Show median of successful simulations
                    const sortedSuccessful = [...successfulPaths].sort((a, b) => a.finalBalance - b.finalBalance);
                    const medianSuccessIndex = Math.floor(sortedSuccessful.length / 2);
                    medianPath = sortedSuccessful[medianSuccessIndex].years;
                } else {
                    // All simulations failed - show the one that lasted longest
                    const sortedByDuration = [...failedPaths].sort((a, b) => {
                        const aLastPositive = a.years.findIndex(y => y.ruined) || a.years.length;
                        const bLastPositive = b.years.findIndex(y => y.ruined) || b.years.length;
                        return bLastPositive - aLastPositive; // Longest-lasting first
                    });
                    medianPath = sortedByDuration[0].years;
                    medianPathFailed = true;
                }

                // Calculate percentile paths for probability cone
                const numYears = medianPath.length;
                const percentilePaths = {
                    p5: [],
                    p10: [],
                    p25: [],
                    p50: [],
                    p75: [],
                    p90: [],
                    p95: []
                };

                // Also calculate median withdrawals per year
                const medianWithdrawalPath = [];

                for (let yearIdx = 0; yearIdx < numYears; yearIdx++) {
                    const portfolioValues = paths.map(p => p.years[yearIdx]?.portfolioEnd || 0).sort((a, b) => a - b);
                    percentilePaths.p5.push(this.percentile(portfolioValues, 5));
                    percentilePaths.p10.push(this.percentile(portfolioValues, 10));
                    percentilePaths.p25.push(this.percentile(portfolioValues, 25));
                    percentilePaths.p50.push(this.percentile(portfolioValues, 50));
                    percentilePaths.p75.push(this.percentile(portfolioValues, 75));
                    percentilePaths.p90.push(this.percentile(portfolioValues, 90));
                    percentilePaths.p95.push(this.percentile(portfolioValues, 95));

                    // Median withdrawal for this year across all simulations
                    const withdrawalValues = paths.map(p => p.years[yearIdx]?.withdrawal || 0).sort((a, b) => a - b);
                    medianWithdrawalPath.push(this.percentile(withdrawalValues, 50));
                }

                return {
                    name: strategyName,
                    paths,
                    successRate,
                    failureRate,
                    avgFailureAge,
                    avgFailureSeverity,
                    medianFinal,
                    p10Final,
                    p75Final,
                    p90Final,
                    p95Final,
                    medianWithdrawals,
                    p75Withdrawals,
                    p90Withdrawals,
                    p95Withdrawals,
                    medianPath,
                    medianPathFailed,  // True if all simulations failed
                    medianWithdrawalPath,  // Median withdrawal for each year across all simulations
                    allFinalValues: finalBalances,  // Store all final values for histogram
                    percentilePaths  // Store percentile paths for probability cone
                };
            },

            /**
             * Calculates percentile from sorted array
             * Uses linear interpolation for precise values
             */
            percentile(sorted, p) {
                if (sorted.length === 0) return 0;
                const index = (p / 100) * (sorted.length - 1);
                const lower = Math.floor(index);
                const upper = Math.ceil(index);
                const weight = index - lower;
                return sorted[lower] * (1 - weight) + sorted[upper] * weight;
            }
        };

        // ============================================
        // CHARTS MODULE
        // Renders interactive canvas-based line charts showing portfolio and
        // withdrawal trajectories over time. Features:
        // - Hover tooltips showing exact values at each age
        // - Shaded probability cones (10th-90th percentile ranges)
        // - Theme-aware colors (adapts to light/dark mode)
        // - Currency formatting for dollar values
        // ============================================
        const Charts = {
            /**
             * Draws an interactive line chart with hover tooltips.
             * Supports multiple series (one per strategy) with shaded percentile bands.
             */
            drawLineChart(canvas, data, title) {
                const ctx = canvas.getContext('2d');
                const width = canvas.width;
                const height = canvas.height;

                // Apple-inspired dark mode chart colors
                const bgColor = '#1c1c1e';
                const textColor = '#f5f5f7';
                const gridColor = '#48484a';
                const lineColors = [
                    '#0a84ff', '#30d158', '#ff9f0a', '#ff453a', '#bf5af2'
                ];

                ctx.fillStyle = bgColor;
                ctx.fillRect(0, 0, width, height);

                const margin = { top: 50, right: 180, bottom: 60, left: 90 };
                const chartWidth = width - margin.left - margin.right;
                const chartHeight = height - margin.top - margin.bottom;

                // Calculate data ranges
                const allYears = data.series[0].values.map((_, i) => i);
                const allValues = data.series.flatMap(s => s.values);
                const minValue = Math.min(0, ...allValues);
                const maxValue = Math.max(...allValues);
                const valueRange = maxValue - minValue;

                // Scaling functions
                const xScale = (year) => margin.left + (year / (allYears.length - 1)) * chartWidth;
                const yScale = (value) => margin.top + chartHeight - ((value - minValue) / valueRange) * chartHeight;

                // Draw grid lines
                ctx.strokeStyle = gridColor;
                ctx.lineWidth = 1;
                const numGridLines = 5;
                for (let i = 0; i <= numGridLines; i++) {
                    const y = margin.top + (i / numGridLines) * chartHeight;
                    ctx.beginPath();
                    ctx.moveTo(margin.left, y);
                    ctx.lineTo(margin.left + chartWidth, y);
                    ctx.stroke();
                }

                // Draw axes
                ctx.strokeStyle = textColor;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(margin.left, margin.top);
                ctx.lineTo(margin.left, margin.top + chartHeight);
                ctx.lineTo(margin.left + chartWidth, margin.top + chartHeight);
                ctx.stroke();

                // Y-axis labels
                ctx.fillStyle = textColor;
                ctx.font = '14px system-ui';
                ctx.textAlign = 'right';
                for (let i = 0; i <= numGridLines; i++) {
                    const value = minValue + (i / numGridLines) * valueRange;
                    const y = margin.top + chartHeight - (i / numGridLines) * chartHeight;
                    ctx.fillText(this.formatCurrency(value, true), margin.left - 12, y + 5);
                }

                // X-axis labels
                ctx.textAlign = 'center';
                ctx.font = '14px system-ui';
                const numXLabels = 5;
                for (let i = 0; i <= numXLabels; i++) {
                    const yearIndex = Math.floor((i / numXLabels) * (allYears.length - 1));
                    const x = xScale(yearIndex);
                    const age = data.startAge + yearIndex;
                    ctx.fillText(age.toString(), x, margin.top + chartHeight + 28);
                }

                ctx.font = '14px system-ui';
                ctx.fillText('Age', margin.left + chartWidth / 2, height - 12);

                // Draw probability cone (percentile bands) if available
                data.series.forEach((series, idx) => {
                    if (series.percentilePaths) {
                        const color = lineColors[idx % lineColors.length];
                        const rgb = this.hexToRgb(color);

                        // Draw 10-90 percentile band (wider, lighter)
                        ctx.fillStyle = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.1)`;
                        ctx.beginPath();
                        // Draw top edge (p90)
                        series.percentilePaths.p90.forEach((value, i) => {
                            const x = xScale(i);
                            const y = yScale(value);
                            if (i === 0) ctx.moveTo(x, y);
                            else ctx.lineTo(x, y);
                        });
                        // Draw bottom edge backwards (p10)
                        for (let i = series.percentilePaths.p10.length - 1; i >= 0; i--) {
                            const x = xScale(i);
                            const y = yScale(series.percentilePaths.p10[i]);
                            ctx.lineTo(x, y);
                        }
                        ctx.closePath();
                        ctx.fill();

                        // Draw 25-75 percentile band (narrower, darker)
                        ctx.fillStyle = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.2)`;
                        ctx.beginPath();
                        // Draw top edge (p75)
                        series.percentilePaths.p75.forEach((value, i) => {
                            const x = xScale(i);
                            const y = yScale(value);
                            if (i === 0) ctx.moveTo(x, y);
                            else ctx.lineTo(x, y);
                        });
                        // Draw bottom edge backwards (p25)
                        for (let i = series.percentilePaths.p25.length - 1; i >= 0; i--) {
                            const x = xScale(i);
                            const y = yScale(series.percentilePaths.p25[i]);
                            ctx.lineTo(x, y);
                        }
                        ctx.closePath();
                        ctx.fill();
                    }
                });

                // Draw data lines
                data.series.forEach((series, idx) => {
                    ctx.strokeStyle = lineColors[idx % lineColors.length];
                    ctx.lineWidth = 3;
                    ctx.beginPath();

                    series.values.forEach((value, i) => {
                        const x = xScale(i);
                        const y = yScale(value);
                        if (i === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    });

                    ctx.stroke();
                });

                // Draw legend
                ctx.textAlign = 'left';
                data.series.forEach((series, idx) => {
                    const y = margin.top + 25 + idx * 26;
                    const x = margin.left + chartWidth + 15;

                    ctx.fillStyle = lineColors[idx % lineColors.length];
                    ctx.fillRect(x, y - 12, 18, 18);

                    ctx.fillStyle = textColor;
                    ctx.font = '14px system-ui';
                    ctx.fillText(series.label.substring(0, 20), x + 24, y + 3);
                });

                // Chart title
                ctx.font = 'bold 16px system-ui';
                ctx.textAlign = 'center';
                ctx.fillStyle = textColor;
                ctx.fillText(title, margin.left + chartWidth / 2, 28);

                // Store chart data for tooltip functionality
                canvas.chartData = {
                    data,
                    xScale,
                    yScale,
                    margin,
                    lineColors,
                    chartWidth,
                    chartHeight
                };

                // Add mousemove listener for interactive tooltips
                this.addChartTooltip(canvas);
            },

            /**
             * Adds interactive mouseover tooltip to chart
             * Shows year, age, and value on hover
             * Draws vertical line indicator at mouse position
             */
            addChartTooltip(canvas) {
                const tooltip = document.getElementById('chart-tooltip');

                // Store original chart as image data for redrawing
                if (!canvas.originalImageData) {
                    const ctx = canvas.getContext('2d');
                    canvas.originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                }

                canvas.addEventListener('mousemove', (e) => {
                    const rect = canvas.getBoundingClientRect();

                    // Scale mouse coordinates to match canvas internal resolution
                    const scaleX = canvas.width / rect.width;
                    const scaleY = canvas.height / rect.height;
                    const mouseX = (e.clientX - rect.left) * scaleX;
                    const mouseY = (e.clientY - rect.top) * scaleY;

                    const { data, xScale, yScale, margin, chartWidth, chartHeight, lineColors } = canvas.chartData;
                    const ctx = canvas.getContext('2d');

                    // Restore original chart (remove previous line)
                    ctx.putImageData(canvas.originalImageData, 0, 0);

                    // Check if mouse is within chart area
                    if (mouseX < margin.left || mouseX > margin.left + chartWidth ||
                        mouseY < margin.top || mouseY > margin.top + chartHeight) {
                        tooltip.classList.add('hidden');
                        return;
                    }

                    // Find nearest year index
                    const yearFraction = (mouseX - margin.left) / chartWidth;
                    const yearIndex = Math.round(yearFraction * (data.series[0].values.length - 1));

                    if (yearIndex < 0 || yearIndex >= data.series[0].values.length) {
                        tooltip.classList.add('hidden');
                        return;
                    }

                    // Calculate exact x position for the vertical line
                    const lineX = margin.left + yearIndex * (chartWidth / (data.series[0].values.length - 1));

                    // Draw vertical line indicator
                    const isDark = document.documentElement.classList.contains('dark');
                    ctx.strokeStyle = isDark ? 'rgba(226, 232, 240, 0.4)' : 'rgba(31, 41, 55, 0.4)';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(lineX, margin.top);
                    ctx.lineTo(lineX, margin.top + chartHeight);
                    ctx.stroke();
                    ctx.setLineDash([]); // Reset dash pattern

                    // Draw dots at intersection points
                    data.series.forEach((series, idx) => {
                        const value = series.values[yearIndex];
                        const yPos = yScale(value);
                        const color = lineColors[idx % lineColors.length];

                        ctx.fillStyle = color;
                        ctx.beginPath();
                        ctx.arc(lineX, yPos, 5, 0, 2 * Math.PI);
                        ctx.fill();
                        ctx.strokeStyle = '#1c1c1e'; // Dark mode background
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    });

                    // Build tooltip content
                    const age = data.startAge + yearIndex;
                    let tooltipHTML = `<div style="font-weight: bold; margin-bottom: 4px;">Age ${age}</div>`;

                    data.series.forEach((series, idx) => {
                        const value = series.values[yearIndex];
                        const color = lineColors[idx % lineColors.length];
                        tooltipHTML += `<div style="display: flex; align-items: center; gap: 6px; margin-bottom: 2px;">
                            <div style="width: 12px; height: 12px; background: ${color}; border-radius: 2px;"></div>
                            <span style="font-size: 11px;">${series.label.substring(0, 20)}: ${this.formatCurrency(value)}</span>
                        </div>`;
                    });

                    tooltip.innerHTML = tooltipHTML;
                    tooltip.classList.remove('hidden');
                    tooltip.style.left = (e.clientX + 15) + 'px';
                    tooltip.style.top = (e.clientY - 10) + 'px';
                });

                canvas.addEventListener('mouseleave', () => {
                    tooltip.classList.add('hidden');
                    // Restore original chart when mouse leaves
                    const ctx = canvas.getContext('2d');
                    ctx.putImageData(canvas.originalImageData, 0, 0);
                });
            },

            /**
             * Formats currency values for display
             * Uses compact notation (M/K) for large numbers
             */
            formatCurrency(value, compact = false) {
                if (compact && Math.abs(value) >= 1000) {
                    if (Math.abs(value) >= 1000000) {
                        return '$' + (value / 1000000).toFixed(1) + 'M';
                    }
                    return '$' + (value / 1000).toFixed(0) + 'K';
                }
                return '$' + value.toLocaleString('en-US', { maximumFractionDigits: 0 });
            },

            /**
             * Converts hex color to RGB object
             */
            hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : { r: 0, g: 0, b: 0 };
            }
        };

        // ============================================
        // REPORT GENERATION MODULE
        // Creates the narrative "Report" tab with:
        // - US retirement benchmarks for context
        // - Strategy-specific analysis and recommendations
        // - Risk assessment and personalized suggestions
        // - Historical backtesting context
        // ============================================
        const Report = {
            /**
             * Generates the full HTML report with analysis, benchmarks, and recommendations.
             * Called when displaying the Report tab after simulation completes.
             */
            generateReport(results, inputs) {
                const strategies = Object.values(results);
                const years = inputs.planningAge - inputs.retirementAge;
                const inflationMultiplier = 1 + inputs.inflationRate / 100;
                const finalDeflator = Math.pow(inflationMultiplier, years - 1);

                // Calculate key metrics
                const bestSuccess = strategies.reduce((max, s) => s.successRate > max.successRate ? s : max);
                const worstSuccess = strategies.reduce((min, s) => s.successRate < min.successRate ? s : min);
                const meetsTarget = strategies.filter(s => s.successRate >= inputs.targetSuccessRate);
                const withdrawalRate = (inputs.startingWithdrawal / inputs.startingPortfolio) * 100;
                const monthlySpending = inputs.startingWithdrawal / 12;
                const monthlyWithSS = (inputs.startingWithdrawal + inputs.socialSecurity) / 12;

                let html = '<div class="space-y-8 animate-fade-in">';

                // ========================================
                // THE BOTTOM LINE - Most important first
                // ========================================
                html += '<div class="bg-apple-surface rounded-xl p-6 border border-apple-border">';
                html += '<h3 class="text-xl font-semibold text-apple-text mb-4 flex items-center gap-2">';
                html += '<span class="text-3xl"></span> The Bottom Line';
                html += '</h3>';

                // Determine overall assessment
                let assessment, assessmentColor, assessmentBg;
                if (meetsTarget.length === strategies.length) {
                    assessment = "Your retirement plan looks solid.";
                    assessmentColor = "text-apple-blue";
                    assessmentBg = "bg-apple-green/10 border-apple-green/30";
                } else if (meetsTarget.length > 0) {
                    assessment = "Your plan can work, but strategy choice matters.";
                    assessmentColor = "text-apple-blue";
                    assessmentBg = "bg-apple-blue/10 border-apple-blue/30";
                } else if (bestSuccess.successRate >= 50) {
                    assessment = "Your plan has significant risk. Consider adjustments.";
                    assessmentColor = "text-apple-orange";
                    assessmentBg = "bg-apple-orange/10 border-apple-orange/30";
                } else {
                    assessment = "Your current plan is unlikely to succeed. Changes needed.";
                    assessmentColor = "text-apple-red";
                    assessmentBg = "bg-apple-red/10 border-apple-red/30";
                }

                html += `<div class="${assessmentBg} border rounded-xl p-4 mb-4">`;
                html += `<p class="text-xl font-semibold ${assessmentColor}">${assessment}</p>`;
                html += '</div>';

                // Plain English summary
                html += '<div class="text-apple-textSecondary space-y-3">';
                html += `<p>You're planning to retire at <strong class="text-apple-blue">age ${inputs.retirementAge}</strong> with <strong class="text-apple-blue">${Charts.formatCurrency(inputs.startingPortfolio)}</strong> saved. `;
                html += `You want to spend <strong class="text-apple-blue">${Charts.formatCurrency(inputs.startingWithdrawal)}/year</strong> (${Charts.formatCurrency(monthlySpending)}/month), `;
                html += `which is a <strong class="text-apple-blue">${withdrawalRate.toFixed(1)}% withdrawal rate</strong>.</p>`;

                if (inputs.socialSecurity > 0) {
                    html += `<p>Once Social Security starts at age ${inputs.ssStartAge}, you'll receive <strong class="text-apple-blue">${Charts.formatCurrency(inputs.socialSecurity)}/year</strong>, `;
                    html += `bringing your total income to <strong class="text-apple-blue">${Charts.formatCurrency(monthlyWithSS)}/month</strong>.</p>`;
                }

                html += `<p>Your money needs to last <strong class="text-apple-blue">${years} years</strong> until age ${inputs.planningAge}. `;
                html += `Based on ${inputs.monteCarloRuns.toLocaleString()} simulated market scenarios, `;

                if (bestSuccess.successRate >= 95) {
                    html += `your plan has an <strong class="text-apple-blue">excellent chance of success</strong>.`;
                } else if (bestSuccess.successRate >= 85) {
                    html += `your plan has a <strong class="text-apple-blue">good chance of success</strong>.`;
                } else if (bestSuccess.successRate >= 70) {
                    html += `your plan has a <strong class="text-apple-orange">moderate chance of success</strong>.`;
                } else if (bestSuccess.successRate >= 50) {
                    html += `your plan has a <strong class="text-apple-orange">concerning chance of success</strong>.`;
                } else {
                    html += `your plan has a <strong class="text-apple-red">high likelihood of running out of money</strong>.`;
                }
                html += '</p>';
                html += '</div>';
                html += '</div>';

                // ========================================
                // STRATEGY RECOMMENDATION
                // ========================================
                html += '<div class="bg-apple-surface rounded-xl p-6 border border-apple-border">';
                html += '<h3 class="text-lg font-semibold text-apple-text mb-4 flex items-center gap-2">';
                html += '<span class="text-2xl"></span> Our Recommendation';
                html += '</h3>';

                if (meetsTarget.length === 0) {
                    // No strategies meet target
                    html += `<div class="bg-apple-red/10 border border-apple-red/30 rounded-xl p-4 mb-4">`;
                    html += `<p class="text-apple-red font-semibold mb-2">None of the strategies meet your ${inputs.targetSuccessRate}% success target.</p>`;
                    html += `<p class="text-apple-textSecondary">The best option is <strong class="text-apple-blue">${this.strategyDisplayName(bestSuccess.name)}</strong> at ${bestSuccess.successRate.toFixed(0)}% success rate, but this is below your comfort level.</p>`;
                    html += '</div>';
                } else {
                    // Find the best strategy that meets target (prefer higher withdrawals among qualifying)
                    const recommended = meetsTarget.reduce((best, s) => s.medianWithdrawals > best.medianWithdrawals ? s : best);

                    html += `<div class="bg-apple-green/10 border border-apple-green/30 rounded-xl p-4 mb-4">`;
                    html += `<div class="flex items-center gap-3 mb-2">`;
                    html += `<span class="text-2xl"></span>`;
                    html += `<span class="text-lg font-semibold text-apple-text">${this.strategyDisplayName(recommended.name)}</span>`;
                    html += `</div>`;
                    html += `<p class="text-apple-textSecondary">This strategy achieves a <strong class="text-apple-blue">${recommended.successRate.toFixed(0)}% success rate</strong> `;
                    html += `while allowing you to spend <strong class="text-apple-blue">${Charts.formatCurrency(recommended.medianWithdrawals)}</strong> over your retirement.</p>`;
                    html += '</div>';

                    // Why this strategy
                    const whyText = {
                        'constant-real': "The 4% Rule provides predictable, inflation-adjusted income. You'll know exactly what to expect each year, making budgeting simple.",
                        'constant-pct': "This strategy automatically adjusts to market conditions. You'll never run out of money, though your income will vary year-to-year.",
                        'vpw': "VPW balances enjoying your money now with protecting against longevity. Spending increases as you age, letting you enjoy more while you're active.",
                        'guardrails': "Guardrails give you mostly stable income with smart adjustments when markets move significantly. It's a good middle ground between flexibility and predictability.",
                        'rmd': "The RMD method mathematically guarantees you won't run out of money. Income varies with the market, but your portfolio will always have something left."
                    };
                    html += `<p class="text-apple-textSecondary text-sm"><strong>Why this strategy?</strong> ${whyText[recommended.name]}</p>`;
                }
                html += '</div>';

                // ========================================
                // KEY NUMBERS AT A GLANCE
                // ========================================
                html += '<div class="bg-apple-surface rounded-xl p-6 border border-apple-border">';
                html += '<h3 class="text-lg font-semibold text-apple-text mb-4 flex items-center gap-2">';
                html += '<span class="text-2xl"></span> Key Numbers at a Glance';
                html += '</h3>';

                html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">';

                // Withdrawal Rate Assessment
                let rateAssessment, rateColor;
                if (withdrawalRate <= 3.5) {
                    rateAssessment = "Conservative";
                    rateColor = "text-apple-blue";
                } else if (withdrawalRate <= 4.5) {
                    rateAssessment = "Moderate";
                    rateColor = "text-apple-blue";
                } else if (withdrawalRate <= 5.5) {
                    rateAssessment = "Aggressive";
                    rateColor = "text-apple-orange";
                } else {
                    rateAssessment = "Very High Risk";
                    rateColor = "text-apple-red";
                }

                html += `<div class="bg-apple-bgAlt rounded-xl p-4 text-center">`;
                html += `<div class="text-xl font-semibold text-apple-text">${withdrawalRate.toFixed(1)}%</div>`;
                html += `<div class="text-xs text-apple-textTertiary uppercase mt-1">Withdrawal Rate</div>`;
                html += `<div class="text-xs ${rateColor} mt-1 font-medium">${rateAssessment}</div>`;
                html += '</div>';

                html += `<div class="bg-apple-bgAlt rounded-xl p-4 text-center">`;
                html += `<div class="text-xl font-semibold text-apple-text">${years}</div>`;
                html += `<div class="text-xs text-apple-textTertiary uppercase mt-1">Years to Fund</div>`;
                html += `<div class="text-xs text-apple-textSecondary mt-1">Age ${inputs.retirementAge} to ${inputs.planningAge}</div>`;
                html += '</div>';

                html += `<div class="bg-apple-bgAlt rounded-xl p-4 text-center">`;
                html += `<div class="text-2xl font-bold ${bestSuccess.successRate >= inputs.targetSuccessRate ? 'text-apple-blue' : 'text-apple-orange'}">${bestSuccess.successRate.toFixed(0)}%</div>`;
                html += `<div class="text-xs text-apple-textTertiary uppercase mt-1">Best Success Rate</div>`;
                html += `<div class="text-xs text-apple-textSecondary mt-1">${this.strategyDisplayName(bestSuccess.name)}</div>`;
                html += '</div>';

                const bestForSpending = strategies.reduce((max, s) => s.medianWithdrawals > max.medianWithdrawals ? s : max);
                html += `<div class="bg-apple-bgAlt rounded-xl p-4 text-center">`;
                html += `<div class="text-xl font-semibold text-apple-text">${Charts.formatCurrency(bestForSpending.medianWithdrawals / years)}</div>`;
                html += `<div class="text-xs text-apple-textTertiary uppercase mt-1">Avg Annual Spend</div>`;
                html += `<div class="text-xs text-apple-textSecondary mt-1">Median scenario</div>`;
                html += '</div>';

                html += '</div>';
                html += '</div>';

                // ========================================
                // WHAT YOU COULD CHANGE
                // ========================================
                if (bestSuccess.successRate < 90 || meetsTarget.length === 0) {
                    html += '<div class="bg-apple-surface rounded-xl p-6 border border-apple-border">';
                    html += '<h3 class="text-lg font-semibold text-apple-text mb-4 flex items-center gap-2">';
                    html += '<span class="text-2xl"></span> Ways to Improve Your Plan';
                    html += '</h3>';

                    html += '<div class="space-y-4">';

                    // Calculate improvement suggestions
                    const targetWithdrawalFor90 = inputs.startingPortfolio * 0.035; // ~3.5% is historically safe
                    const additionalSavingsNeeded = (inputs.startingWithdrawal / 0.04) - inputs.startingPortfolio;
                    const yearlyExtraToSave = additionalSavingsNeeded / 5; // Assume 5 years to retirement

                    if (withdrawalRate > 4) {
                        const reducedSpending = inputs.startingPortfolio * 0.04;
                        const reduction = inputs.startingWithdrawal - reducedSpending;
                        html += `<div class="flex items-start gap-3 p-4 bg-apple-bgAlt rounded-xl">`;
                        html += `<span class="text-xl"></span>`;
                        html += `<div>`;
                        html += `<div class="font-semibold text-apple-blue">Reduce spending by ${Charts.formatCurrency(reduction)}/year</div>`;
                        html += `<div class="text-sm text-apple-textSecondary">Spending ${Charts.formatCurrency(reducedSpending)}/year (4% rule) would significantly improve your odds. That's ${Charts.formatCurrency(reduction/12)}/month less.</div>`;
                        html += `</div></div>`;
                    }

                    if (additionalSavingsNeeded > 0 && additionalSavingsNeeded < inputs.startingPortfolio) {
                        html += `<div class="flex items-start gap-3 p-4 bg-apple-bgAlt rounded-xl">`;
                        html += `<span class="text-xl"></span>`;
                        html += `<div>`;
                        html += `<div class="font-semibold text-apple-blue">Save an additional ${Charts.formatCurrency(additionalSavingsNeeded)}</div>`;
                        html += `<div class="text-sm text-apple-textSecondary">With ${Charts.formatCurrency(inputs.startingPortfolio + additionalSavingsNeeded)}, your current spending would be a safer 4% withdrawal rate.</div>`;
                        html += `</div></div>`;
                    }

                    if (inputs.retirementAge < 67) {
                        html += `<div class="flex items-start gap-3 p-4 bg-apple-bgAlt rounded-xl">`;
                        html += `<span class="text-xl"></span>`;
                        html += `<div>`;
                        html += `<div class="font-semibold text-apple-blue">Delay retirement by 1-2 years</div>`;
                        html += `<div class="text-sm text-apple-textSecondary">Each year you delay means one less year to fund, more time to save, and potentially higher Social Security benefits.</div>`;
                        html += `</div></div>`;
                    }

                    if (inputs.ssStartAge < 70) {
                        const ssAt70Bonus = Math.round(inputs.socialSecurity * (1 + 0.08 * (70 - inputs.ssStartAge)));
                        html += `<div class="flex items-start gap-3 p-4 bg-apple-bgAlt rounded-xl">`;
                        html += `<span class="text-xl"></span>`;
                        html += `<div>`;
                        html += `<div class="font-semibold text-apple-blue">Delay Social Security to age 70</div>`;
                        html += `<div class="text-sm text-apple-textSecondary">Waiting until 70 would increase your benefit to ~${Charts.formatCurrency(ssAt70Bonus)}/yeara ${((ssAt70Bonus/inputs.socialSecurity - 1) * 100).toFixed(0)}% boost that's guaranteed for life.</div>`;
                        html += `</div></div>`;
                    }

                    html += '</div>';
                    html += '</div>';
                }

                // ========================================
                // STRATEGY COMPARISON
                // ========================================
                html += '<div class="bg-apple-surface rounded-xl p-6 border border-apple-border">';
                html += '<h3 class="text-lg font-semibold text-apple-text mb-4 flex items-center gap-2">';
                html += '<span class="text-2xl"></span> Strategy Comparison';
                html += '</h3>';

                html += '<div class="overflow-x-auto">';
                html += '<table class="w-full text-sm">';
                html += '<thead>';
                html += '<tr class="border-b border-apple-border">';
                html += '<th class="text-left py-3 px-2 text-apple-textSecondary font-medium">Strategy</th>';
                html += '<th class="text-center py-3 px-2 text-apple-textSecondary font-medium">Success Rate</th>';
                html += '<th class="text-center py-3 px-2 text-apple-textSecondary font-medium">Total Spending</th>';
                html += '<th class="text-center py-3 px-2 text-apple-textSecondary font-medium">Legacy (Median)</th>';
                html += '<th class="text-center py-3 px-2 text-apple-textSecondary font-medium">Income Stability</th>';
                html += '</tr>';
                html += '</thead>';
                html += '<tbody>';

                // Sort by success rate
                const sortedStrategies = [...strategies].sort((a, b) => b.successRate - a.successRate);

                sortedStrategies.forEach(s => {
                    const meetsGoal = s.successRate >= inputs.targetSuccessRate;
                    const stabilityRating = {
                        'constant-real': '',
                        'guardrails': '',
                        'vpw': '',
                        'rmd': '',
                        'constant-pct': ''
                    };

                    html += `<tr class="border-b border-apple-border/50 hover:bg-apple-bgAlt">`;
                    html += `<td class="py-3 px-2">`;
                    html += `<div class="font-medium text-apple-blue">${this.strategyDisplayName(s.name)}</div>`;
                    html += `</td>`;
                    html += `<td class="py-3 px-2 text-center">`;
                    html += `<span class="font-bold ${meetsGoal ? 'text-apple-blue' : 'text-apple-orange'}">${s.successRate.toFixed(0)}%</span>`;
                    if (meetsGoal) html += ` <span class="text-xs text-apple-blue"></span>`;
                    html += `</td>`;
                    html += `<td class="py-3 px-2 text-center text-apple-blue">${Charts.formatCurrency(s.medianWithdrawals)}</td>`;
                    html += `<td class="py-3 px-2 text-center text-apple-blue">${Charts.formatCurrency(s.medianFinal / finalDeflator)}</td>`;
                    html += `<td class="py-3 px-2 text-center text-apple-orange">${stabilityRating[s.name] || ''}</td>`;
                    html += `</tr>`;
                });

                html += '</tbody>';
                html += '</table>';
                html += '</div>';
                html += '<p class="text-xs text-apple-textTertiary mt-3"> = Meets your ${inputs.targetSuccessRate}% success target. Income Stability:  = very stable,  = varies significantly with markets.</p>';
                html += '</div>';

                // ========================================
                // UNDERSTANDING THE RISKS
                // ========================================
                html += '<div class="bg-apple-surface rounded-xl p-6 border border-apple-border">';
                html += '<h3 class="text-lg font-semibold text-apple-text mb-4 flex items-center gap-2">';
                html += '<span class="text-2xl"></span> Understanding the Risks';
                html += '</h3>';

                html += '<div class="grid md:grid-cols-2 gap-4">';

                html += '<div class="p-4 bg-apple-bgAlt rounded-xl">';
                html += '<div class="font-semibold text-apple-blue mb-2">Sequence of Returns Risk</div>';
                html += '<p class="text-sm text-apple-textSecondary">A market crash in your first few years of retirement is much more damaging than one later. Bad timing can derail even well-funded plans.</p>';
                html += '</div>';

                html += '<div class="p-4 bg-apple-bgAlt rounded-xl">';
                html += '<div class="font-semibold text-apple-blue mb-2">Inflation Risk</div>';
                html += `<p class="text-sm text-apple-textSecondary">At ${inputs.inflationRate}% inflation, prices double every ${Math.round(72/inputs.inflationRate)} years. What costs $1,000 today will cost ${Charts.formatCurrency(1000 * Math.pow(1 + inputs.inflationRate/100, years))} when you're ${inputs.planningAge}.</p>`;
                html += '</div>';

                html += '<div class="p-4 bg-apple-bgAlt rounded-xl">';
                html += '<div class="font-semibold text-apple-blue mb-2">Longevity Risk</div>';
                html += `<p class="text-sm text-apple-textSecondary">Planning to age ${inputs.planningAge} is ${inputs.planningAge >= 95 ? 'conservative' : inputs.planningAge >= 90 ? 'reasonable' : 'optimistic'}. About 25% of 65-year-olds will live past 90, and 10% past 95.</p>`;
                html += '</div>';

                html += '<div class="p-4 bg-apple-bgAlt rounded-xl">';
                html += '<div class="font-semibold text-apple-blue mb-2">Healthcare Costs</div>';
                html += '<p class="text-sm text-apple-textSecondary">The average 65-year-old couple will spend $315,000+ on healthcare in retirement (Fidelity 2023). Major illness can significantly exceed this.</p>';
                html += '</div>';

                html += '</div>';
                html += '</div>';

                html += '</div>';

                return html;
            },

            strategyDisplayName(name) {
                const map = {
                    'constant-real': 'Constant Real (4% Rule)',
                    'constant-pct': 'Constant % of Portfolio',
                    'vpw': 'Variable % (VPW)',
                    'guardrails': 'Guardrails',
                    'rmd': 'RMD / Life Expectancy'
                };
                return map[name] || name;
            },

            strategyNarrative(strategy, inputs) {
                // Calculate deflator for final values
                const years = inputs.planningAge - inputs.retirementAge;
                const inflationMultiplier = 1 + inputs.inflationRate / 100;
                const finalDeflator = Math.pow(inflationMultiplier, years - 1);

                let html = '<div class="border border-apple-border rounded-xl p-4 bg-apple-surface">';

                // Strategy name with info tooltip
                const tooltips = {
                    'constant-real': '<strong>Classic 4% Rule:</strong> Withdraw 4% of your starting portfolio in year one, then adjust that dollar amount for inflation each year. <br><br><strong>Pros:</strong> Predictable, stable income. <br><strong>Cons:</strong> Doesn\'t adapt to market performance; can deplete portfolio in bad sequences.',
                    'constant-pct': '<strong>Dynamic Percentage:</strong> Withdraw a fixed percentage (e.g., 4%) of your current portfolio value each year. <br><br><strong>Pros:</strong> Theoretically never runs out; adapts to markets. <br><strong>Cons:</strong> Income varies significantly year-to-year; belt-tightening in bad years.',
                    'vpw': '<strong>VPW Method:</strong> Withdrawal percentage increases as you age based on remaining life expectancy and asset allocation. <br><br><strong>Pros:</strong> Balances longevity protection with lifestyle. <br><strong>Cons:</strong> More complex; requires periodic recalculation.',
                    'guardrails': '<strong>Guyton-Klinger Guardrails:</strong> Starts with initial withdrawal rate but adjusts spending when withdrawal rate crosses preset upper/lower thresholds. <br><br><strong>Pros:</strong> Balances stability with flexibility. <br><strong>Cons:</strong> May require lifestyle adjustments when guardrails are triggered.',
                    'rmd': '<strong>IRS RMD Table Method:</strong> Divides current portfolio by IRS life expectancy table. Same method used for Required Minimum Distributions. <br><br><strong>Pros:</strong> Guaranteed to last lifetime mathematically. <br><strong>Cons:</strong> Highly volatile income; can be very low in market downturns.'
                };

                html += `<h4 class="text-lg font-semibold text-apple-text mb-2 flex items-center">
                    ${this.strategyDisplayName(strategy.name)}
                    <span class="tooltip ml-2">
                        <span class="info-icon">i</span>
                        <span class="tooltiptext">${tooltips[strategy.name]}</span>
                    </span>
                </h4>`;

                const descriptions = {
                    'constant-real': 'Withdraws a fixed percentage of your starting portfolio in year one, then adjusts for inflation annually. Predictable income but doesn\'t respond to market changes.',
                    'constant-pct': 'Withdraws a fixed percentage of current portfolio value each year. Self-adjusting but creates volatile income.',
                    'vpw': 'Adjusts withdrawal percentage based on remaining life expectancy. Withdrawals increase with age while protecting against longevity risk.',
                    'guardrails': 'Starts with initial rate but adjusts spending when withdrawal rate crosses preset thresholds. Balances stability with market responsiveness.',
                    'rmd': 'Divides portfolio by remaining life expectancy each year. Guarantees portfolio lasts lifetime but creates volatile income.'
                };
                html += `<p class="text-apple-textSecondary mb-3 text-sm">${descriptions[strategy.name]}</p>`;

                html += '<div class="grid grid-cols-2 gap-2 text-xs text-apple-textSecondary mb-2">';
                html += `<div>Success Rate: <strong>${strategy.successRate.toFixed(1)}%</strong> ${this.successBadge(strategy.successRate)}</div>`;
                html += `<div>Median Final: <strong>${Charts.formatCurrency(strategy.medianFinal / finalDeflator)}</strong></div>`;
                html += `<div>10th Percentile: <strong>${Charts.formatCurrency(strategy.p10Final / finalDeflator)}</strong></div>`;
                html += `<div>Total Withdrawals: <strong>${Charts.formatCurrency(strategy.medianWithdrawals)}</strong></div>`;
                // Failure metrics (only show if there are failures)
                if (strategy.failureRate > 0) {
                    html += `<div>Failure Rate: <strong class="text-red-400">${strategy.failureRate.toFixed(1)}%</strong></div>`;
                    html += `<div>Avg Failure Age: <strong class="text-red-400">${strategy.avgFailureAge ? strategy.avgFailureAge.toFixed(0) : 'N/A'}</strong></div>`;
                    html += `<div>Avg Shortfall: <strong class="text-red-400">${strategy.avgFailureSeverity ? strategy.avgFailureSeverity.toFixed(1) + ' yrs' : 'N/A'}</strong></div>`;
                }
                html += '</div>';

                // Progress bar
                html += `<div class="w-full bg-gray-200 dark:bg-slate-800 rounded-full h-2 overflow-hidden mt-2">
                    <div class="progress-bar-animated bg-gradient-to-r from-primary-500 to-primary-600 h-2 rounded-full" style="width: ${strategy.successRate}%"></div>
                </div>`;

                html += '</div>';
                return html;
            },

            successBadge(rate) {
                if (rate >= 95) return '<span class="inline-block px-1.5 py-0.5 text-xs font-semibold rounded bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300">Excellent</span>';
                if (rate >= 85) return '<span class="inline-block px-1.5 py-0.5 text-xs font-semibold rounded bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300">Good</span>';
                return '<span class="inline-block px-1.5 py-0.5 text-xs font-semibold rounded bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300">Risky</span>';
            },

            getSuccessRateRecommendation(strategies, targetRate) {
                let html = '<p class="text-apple-textSecondary">';

                const qualifying = strategies.filter(s => s.successRate >= targetRate);

                if (qualifying.length === 0) {
                    html += `<strong class="text-red-700 dark:text-red-400">Warning:</strong> None of the strategies meet your target success rate of ${targetRate}%. `;
                    html += 'Consider reducing withdrawal amounts, increasing portfolio value, or accepting a lower success rate target.';
                } else {
                    const best = qualifying.reduce((max, s) => s.medianWithdrawals > max.medianWithdrawals ? s : max);
                    html += `Given your target success rate of <strong>${targetRate}%</strong>, we recommend `;
                    html += `<span class="inline-block px-3 py-1 bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300 rounded-xl font-semibold">${this.strategyDisplayName(best.name)}</span> `;
                    html += `which achieves a ${best.successRate.toFixed(1)}% success rate with lifetime withdrawals of ${Charts.formatCurrency(best.medianWithdrawals)}.`;
                }

                html += '</p>';
                return html;
            }
        };

        // ============================================
        // UI MODULE
        // Handles all user interaction and display logic:
        // - Collects form inputs and validates them
        // - Triggers simulation runs and displays results
        // - Manages tab switching between Summary/Charts/Tables/Report
        // - Handles dark/light theme toggling
        // - Shows status messages and loading states
        // ============================================
        const UI = {
            /**
             * Reads all form inputs and returns them as a structured object.
             * Handles number parsing and defaults for optional fields.
             */
            getInputs() {
                const selectedStrategies = [];
                if (document.getElementById('strategy-constant-real').checked) selectedStrategies.push('constant-real');
                if (document.getElementById('strategy-constant-pct').checked) selectedStrategies.push('constant-pct');
                if (document.getElementById('strategy-vpw').checked) selectedStrategies.push('vpw');
                if (document.getElementById('strategy-guardrails').checked) selectedStrategies.push('guardrails');
                if (document.getElementById('strategy-rmd').checked) selectedStrategies.push('rmd');

                return {
                    retirementAge: parseInt(document.getElementById('retirement-age').value),
                    planningAge: parseInt(document.getElementById('planning-age').value),
                    startingPortfolio: parseFormattedNumber(document.getElementById('starting-portfolio').value),
                    startingWithdrawal: parseFormattedNumber(document.getElementById('starting-withdrawal').value),
                    expectedReturn: parseFloat(document.getElementById('expected-return').value.replace(/,/g, '')),
                    volatility: parseFloat(document.getElementById('volatility').value.replace(/,/g, '')),
                    inflationRate: parseFloat(document.getElementById('inflation-rate').value.replace(/,/g, '')),
                    monteCarloRuns: parseInt(parseFormattedNumber(document.getElementById('monte-carlo-runs').value)),
                    minSpending: parseFormattedNumber(document.getElementById('min-spending').value),
                    maxSpending: parseFormattedNumber(document.getElementById('max-spending').value),
                    oneTimeExpense: parseFormattedNumber(document.getElementById('one-time-expense').value),
                    socialSecurity: parseFormattedNumber(document.getElementById('social-security').value),
                    ssStartAge: parseInt(document.getElementById('ss-start-age').value),
                    targetSuccessRate: parseInt(document.getElementById('risk-tolerance').value),
                    strategies: selectedStrategies,
                    // Strategy parameters
                    constantRealRate: parseFloat(document.getElementById('constant-real-rate').value.replace(/,/g, '')) || 4,
                    constantPctRate: parseFloat(document.getElementById('constant-pct-rate').value.replace(/,/g, '')) || 4.0,
                    guardrailsInitialRate: parseFloat(document.getElementById('guardrails-initial-rate').value.replace(/,/g, '')) || 5.0,
                    guardrailsUpper: parseFloat(document.getElementById('guardrails-upper').value.replace(/,/g, '')) || 1.2,
                    guardrailsLower: parseFloat(document.getElementById('guardrails-lower').value.replace(/,/g, '')) || 0.8,
                    guardrailsAdjustment: parseFloat(document.getElementById('guardrails-adjustment').value.replace(/,/g, '')) || 10.0,
                    vpwStockAllocation: parseFloat(document.getElementById('vpw-stock-allocation').value.replace(/,/g, '')) || 60,
                    // Return distribution model
                    returnDistribution: document.getElementById('return-distribution').value || 'normal',
                    // Periodic expense parameters
                    expenseFirstYear: parseInt(document.getElementById('expense-first-year').value) || 5,
                    expenseFrequency: parseInt(document.getElementById('expense-frequency').value) || 5,
                    expenseMaxCount: parseInt(document.getElementById('expense-max-count').value) || 0
                };
            },

            /**
             * Shows status message to user
             * @param {string} message
             * @param {string} type - 'info', 'success', or 'error'
             */
            showStatus(message, type = 'info') {
                const statusEl = document.getElementById('status-message');
                const colorClasses = {
                    info: 'bg-blue-50 dark:bg-blue-900/20 border-blue-300 dark:border-blue-800 text-blue-900 dark:text-blue-200',
                    success: 'bg-green-50 dark:bg-green-900/20 border-green-300 dark:border-green-800 text-green-900 dark:text-green-200',
                    error: 'bg-red-50 dark:bg-red-900/20 border-red-300 dark:border-red-800 text-red-900 dark:text-red-200'
                };
                statusEl.className = `p-4 rounded-xl border ${colorClasses[type]} animate-slide-up text-center max-w-2xl mx-auto`;
                statusEl.innerHTML = message;
                statusEl.classList.remove('hidden');
            },

            hideStatus() {
                document.getElementById('status-message').classList.add('hidden');
            },

            /**
             * Main simulation execution function
             * Runs Monte Carlo analysis and updates UI
             */
            async runSimulation() {
                const inputs = this.getInputs();

                // Input validation
                if (inputs.strategies.length === 0) {
                    this.showStatus('Please select at least one withdrawal strategy.', 'error');
                    return;
                }

                if (inputs.planningAge <= inputs.retirementAge) {
                    this.showStatus('Planning age must be after retirement age.', 'error');
                    return;
                }

                const btn = document.getElementById('run-simulation');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.classList.add('animate-pulse');
                btn.innerHTML = `
                    <span class="relative z-10 flex items-center gap-3">
                        <div class="loading-dots">
                            <span></span><span></span><span></span>
                        </div>
                        <span>Simulating ${inputs.monteCarloRuns.toLocaleString()} scenarios...</span>
                    </span>
                `;
                this.hideStatus();

                // Small delay to allow UI to update
                await new Promise(resolve => setTimeout(resolve, 100));

                try {
                    // Run simulations for each selected strategy
                    const results = {};
                    for (const strategyName of inputs.strategies) {
                        results[strategyName] = Simulation.runStrategy(strategyName, inputs);
                    }

                    // Store globally for tab switching
                    globalResults = results;
                    globalInputs = inputs;

                    // Hide assumptions panel and show results
                    document.getElementById('assumptions-panel').classList.add('hidden');
                    document.getElementById('results-panel').classList.remove('hidden');
                    document.getElementById('back-to-assumptions').classList.remove('hidden');

                    // Display results in all tabs
                    this.displayResults(results, inputs);

                    this.showStatus(' Simulation completed successfully!', 'success');
                    setTimeout(() => this.hideStatus(), 3000);

                } catch (error) {
                    console.error('Simulation error:', error);
                    this.showStatus('Error running simulation. Please check your inputs.', 'error');
                } finally {
                    btn.disabled = false;
                    btn.classList.remove('animate-pulse');
                    btn.innerHTML = originalText;
                }
            },

            /**
             * Populates all results tabs with simulation data
             */
            displayResults(results, inputs) {
                this.displayHero(results, inputs);
                this.displaySummary(results, inputs);
                this.displayCharts(results, inputs);
                this.displayDetails(results, inputs);

                // Keep old functions for backwards compatibility
                this.displayDetailedTables(results, inputs);
                this.displayReport(results, inputs);
                this.displayAssumptions(inputs);

                // Trigger celebration for good outcomes
                const bestSuccessRate = Math.max(...Object.values(results).map(r => r.successRate));

                // Animate the hero percentage with count-up effect
                setTimeout(() => {
                    CelebrationEffects.animateNumber('hero-percentage', bestSuccessRate, 1200, '%');
                }, 400);

                // Trigger confetti for good outcomes
                setTimeout(() => {
                    CelebrationEffects.celebrateIfWarranted(bestSuccessRate, inputs.targetSuccessRate);
                }, 1600);
            },

            /**
             * Hero section: Big success rate and plain English recommendation
             */
            displayHero(results, inputs) {
                const strategies = Object.values(results);
                const best = strategies.reduce((max, s) => s.successRate > max.successRate ? s : max);
                const meetsTarget = strategies.filter(s => s.successRate >= inputs.targetSuccessRate);

                // Determine overall status
                let statusColor, statusBg, statusText, recommendation;

                if (meetsTarget.length === strategies.length) {
                    statusColor = 'text-apple-green';
                    statusBg = 'bg-apple-greenLight';
                    statusText = 'You\'re on track';
                    recommendation = `All ${strategies.length} withdrawal strategies meet your ${inputs.targetSuccessRate}% success target.`;
                } else if (meetsTarget.length > 0) {
                    statusColor = 'text-apple-green';
                    statusBg = 'bg-apple-greenLight';
                    statusText = 'Looking good';
                    recommendation = `${meetsTarget.length} of ${strategies.length} strategies meet your target. ${Report.strategyDisplayName(best.name)} performs best.`;
                } else {
                    statusColor = 'text-apple-orange';
                    statusBg = 'bg-apple-orangeLight';
                    statusText = 'Consider adjustments';
                    recommendation = `No strategies meet your ${inputs.targetSuccessRate}% target. Try reducing spending or increasing savings.`;
                }

                let html = `
                    <div class="text-center">
                        <div class="${statusBg} rounded-3xl p-8 sm:p-12 mb-6 relative overflow-hidden result-card-reveal" style="animation-delay: 0.1s">
                            <div class="text-7xl sm:text-9xl font-bold ${statusColor} mb-3 tracking-tight count-up" id="hero-percentage" style="animation-delay: 0.3s">${best.successRate.toFixed(0)}%</div>
                            <div class="text-apple-textSecondary text-lg animate-fade-in-up" style="animation-delay: 0.5s; animation-fill-mode: both">chance your money lasts to age ${inputs.planningAge}</div>
                        </div>

                        <h2 class="text-2xl sm:text-3xl font-semibold text-apple-text mb-3 animate-fade-in-up" style="animation-delay: 0.6s; animation-fill-mode: both">${statusText}</h2>
                        <p class="text-apple-textSecondary text-lg max-w-xl mx-auto leading-relaxed animate-fade-in-up" style="animation-delay: 0.7s; animation-fill-mode: both">${recommendation}</p>
                    </div>
                `;

                // Quick action buttons - Apple styled with animations
                html += `
                    <div class="flex flex-wrap justify-center gap-3 mt-8 animate-fade-in-up" style="animation-delay: 0.8s; animation-fill-mode: both">
                        <button onclick="document.getElementById('back-to-assumptions').click()"
                            class="btn-apple-secondary px-6 py-3 rounded-xl text-sm font-medium flex items-center gap-2 icon-spin-hover hover:scale-105 transition-transform">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                            Edit Inputs
                        </button>
                        <button onclick="document.querySelector('[data-tab=charts]').click()"
                            class="btn-apple px-6 py-3 rounded-xl text-sm font-medium flex items-center gap-2 hover:scale-105 transition-transform">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                            View Charts
                        </button>
                    </div>
                `;

                document.getElementById('results-hero').innerHTML = html;
            },

            /**
             * Summary tab: Clean, simple overview
             */
            displaySummary(results, inputs) {
                const strategies = Object.values(results);
                const years = inputs.planningAge - inputs.retirementAge;
                const inflationMultiplier = 1 + inputs.inflationRate / 100;
                const finalDeflator = Math.pow(inflationMultiplier, years - 1);

                // Sort strategies by success rate
                const sorted = [...strategies].sort((a, b) => b.successRate - a.successRate);
                const best = sorted[0];

                let html = '<div class="space-y-6">';

                // Apple-style explanation
                html += `
                    <div class="bg-apple-bgAlt rounded-xl p-5">
                        <h4 class="font-semibold text-apple-text mb-2">About this simulation</h4>
                        <p class="text-sm text-apple-textSecondary leading-relaxed">
                            We ran <strong>${inputs.monteCarloRuns.toLocaleString()}</strong> simulations over <strong>${years} years</strong>
                            (age ${inputs.retirementAge} to ${inputs.planningAge}), testing ${strategies.length} different withdrawal strategies.
                        </p>
                    </div>
                `;

                // Strategy comparison cards - Apple styled
                html += '<div>';
                html += '<h3 class="text-lg font-semibold text-apple-text mb-4">Strategy Comparison</h3>';
                html += '<div class="space-y-3">';

                sorted.forEach((s, index) => {
                    const meetsTarget = s.successRate >= inputs.targetSuccessRate;
                    const isBest = index === 0;
                    const successColor = meetsTarget ? 'text-apple-green' : s.successRate >= 70 ? 'text-apple-orange' : 'text-apple-red';
                    const barColor = meetsTarget ? 'bg-apple-green' : s.successRate >= 70 ? 'bg-apple-orange' : 'bg-apple-red';
                    const animDelay = 0.1 + (index * 0.1);

                    html += `
                        <div class="bg-apple-surface rounded-xl p-4 border ${isBest ? 'border-apple-blue shadow-md' : 'border-apple-borderLight'} hover-lift result-card-reveal" style="animation-delay: ${animDelay}s">
                            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="font-semibold text-apple-text">${Report.strategyDisplayName(s.name)}</span>
                                        ${isBest ? '<span class="text-xs font-medium text-apple-blue bg-apple-blueLight px-2 py-0.5 rounded-full animate-bounce-in" style="animation-delay: 0.5s">Best</span>' : ''}
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="flex-1 max-w-48 h-2 bg-apple-borderLight rounded-full overflow-hidden">
                                            <div class="${barColor} h-full rounded-full percentage-fill" style="width: ${s.successRate}%; animation-delay: ${animDelay + 0.2}s"></div>
                                        </div>
                                        <span class="text-2xl font-bold ${successColor} number-animate">${s.successRate.toFixed(0)}%</span>
                                    </div>
                                </div>
                                <div class="flex gap-6 text-sm">
                                    <div class="text-center">
                                        <div class="text-apple-textTertiary text-xs mb-1">Median ending</div>
                                        <div class="text-apple-text font-medium number-animate">${Charts.formatCurrency(s.medianFinal / finalDeflator)}</div>
                                    </div>
                                    ${s.avgFailureAge ? `
                                    <div class="text-center">
                                        <div class="text-apple-textTertiary text-xs mb-1">Runs out at</div>
                                        <div class="text-apple-red font-medium">Age ${s.avgFailureAge.toFixed(0)}</div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                html += '</div>';

                // Apple-style key definitions
                html += `
                    <div class="bg-apple-bgAlt rounded-xl p-5">
                        <h4 class="font-semibold text-apple-text mb-3">Understanding the metrics</h4>
                        <div class="space-y-2 text-sm text-apple-textSecondary">
                            <p><strong class="text-apple-text">Success rate</strong>  Percentage of simulations where your money lasted until age ${inputs.planningAge}</p>
                            <p><strong class="text-apple-text">Median ending</strong>  The typical portfolio balance at the end, in today's dollars</p>
                            ${sorted.some(s => s.avgFailureAge) ? `
                            <p><strong class="text-apple-text">Runs out at</strong>  Average age when money was depleted in failed scenarios</p>
                            ` : ''}
                        </div>
                    </div>
                `;

                html += '</div>';
                document.getElementById('tab-summary').innerHTML = html;
            },

            /**
             * Charts tab: Interactive visualizations
             */
            displayCharts(results, inputs) {
                const strategies = Object.values(results);

                let html = '<div class="space-y-8">';

                // Intro explanation - Terminal styled
                html += `
                    <div class="bg-apple-surface rounded-xl p-5 border border-apple-border relative">
                        <div class="absolute top-2 left-2 text-apple-textTertiary text-[10px] font-mono">// CHART_LEGEND</div>
                        <div class="mt-4 space-y-2 text-xs font-mono text-apple-textSecondary">
                            <p><span class="text-apple-blue"></span> <span class="text-apple-blue">SOLID_LINE</span> = Median (P50)  typical outcome from <span class="text-apple-blue">${inputs.monteCarloRuns.toLocaleString()}</span> simulations</p>
                            <p><span class="text-apple-blue"></span> <span class="text-apple-blue">DARK_BAND</span> = P25-P75 range  middle 50% of outcomes</p>
                            <p><span class="text-apple-textTertiary"></span> <span class="text-apple-textTertiary">LIGHT_BAND</span> = P10-P90 range  80% confidence interval</p>
                            <p class="text-apple-textTertiary pt-2 border-t border-apple-border mt-2">> Wider bands indicate higher uncertainty. Hover for precise values.</p>
                        </div>
                    </div>
                `;

                // Build strategy status legend - Terminal styled
                const strategyLegend = strategies.map(s => {
                    const isFailing = s.successRate < inputs.targetSuccessRate;
                    const isZeroSuccess = s.successRate === 0;
                    if (isZeroSuccess) {
                        return `<span class="inline-flex items-center gap-1 px-2 py-1 bg-apple-red/20 border border-apple-red rounded-xl text-apple-red text-xs font-mono tracking-wider">
                            <span class="animate-pulse"></span> ${Report.strategyDisplayName(s.name)}: 0% [FAIL]
                        </span>`;
                    } else if (isFailing) {
                        return `<span class="inline-flex items-center gap-1 px-2 py-1 bg-apple-orange/10 border border-apple-orange rounded-xl text-apple-orange text-xs font-mono tracking-wider">
                            <span></span> ${Report.strategyDisplayName(s.name)}: ${s.successRate.toFixed(0)}% [WARN]
                        </span>`;
                    } else {
                        return `<span class="inline-flex items-center gap-1 px-2 py-1 bg-apple-green/10 border border-apple-green/50 rounded-xl text-apple-blue text-xs font-mono tracking-wider">
                            <span></span> ${Report.strategyDisplayName(s.name)}: ${s.successRate.toFixed(0)}%
                        </span>`;
                    }
                }).join(' ');

                // Check if any strategy has all failures
                const allStrategiesFailing = strategies.every(s => s.successRate < inputs.targetSuccessRate);
                const someZeroSuccess = strategies.some(s => s.successRate === 0);

                // Warning banner if strategies are failing - Terminal styled
                if (allStrategiesFailing) {
                    html += `
                        <div class="bg-apple-red/10 border border-apple-red rounded-xl p-4 mb-6 relative">
                            <div class="absolute top-1 right-2 text-apple-red/50 text-[10px] font-mono">! ALERT</div>
                            <div class="flex items-start gap-3">
                                <span class="text-apple-red text-xl animate-pulse"></span>
                                <div>
                                    <h4 class="text-apple-red font-bold mb-1 font-mono tracking-wider">RISK_THRESHOLD_EXCEEDED</h4>
                                    <p class="text-apple-red/80 text-sm font-mono">
                                        ${someZeroSuccess
                                            ? '> All simulations failed for some strategies. Charts show failing scenarios where funds deplete to $0.'
                                            : `> No strategy meets ${inputs.targetSuccessRate}% target. Median simulations shown, but failure rate exceeds acceptable threshold.`
                                        }
                                        <br><span class="text-apple-textTertiary">> Recommendation: Reduce spending, increase savings, or delay retirement age.</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Portfolio chart - Apple styled
                html += '<div class="animate-fade-in">';
                html += '<div class="mb-4">';
                html += '<h3 class="text-lg font-semibold text-apple-text">Portfolio Value Projection</h3>';
                html += '<p class="text-sm text-apple-textSecondary">Savings balance over time, adjusted for inflation</p>';
                html += '</div>';
                html += '<div class="bg-apple-surface rounded-2xl p-6 border border-apple-borderLight shadow-sm">';
                html += '<canvas id="chart-portfolio" class="chart-animated" width="1600" height="600"></canvas>';
                html += '</div>';
                html += `<div class="flex flex-wrap gap-2 mt-4">${strategyLegend}</div>`;
                html += '<p class="text-xs text-apple-textTertiary mt-3">Hover for yearly values. Line at $0 indicates funds depleted.</p>';
                html += '</div>';

                // Withdrawals chart - Apple styled
                html += '<div class="animate-fade-in mt-10">';
                html += '<div class="mb-4">';
                html += '<h3 class="text-lg font-semibold text-apple-text">Annual Withdrawal Analysis</h3>';
                html += '<p class="text-sm text-apple-textSecondary">Median spending by strategy over time</p>';
                html += '</div>';
                html += '<div class="bg-apple-surface rounded-2xl p-6 border border-apple-borderLight shadow-sm">';
                html += '<canvas id="chart-withdrawals" class="chart-animated" width="1600" height="600"></canvas>';
                html += '</div>';
                html += `<div class="flex flex-wrap gap-2 mt-4">${strategyLegend}</div>`;
                html += '<p class="text-xs text-apple-textTertiary mt-3">$0 indicates simulation exhausted funds.</p>';
                html += '</div>';

                // Distribution Histograms - Apple styled
                html += '<div class="animate-fade-in mt-10">';
                html += '<div class="mb-4">';
                html += '<h3 class="text-lg font-semibold text-apple-text">Final Balance Distribution</h3>';
                html += '<p class="text-sm text-apple-textSecondary">Ending balances at age ' + inputs.planningAge + ' across all simulations</p>';
                html += '</div>';

                strategies.forEach((strategy, idx) => {
                    const isFailing = strategy.successRate < inputs.targetSuccessRate;
                    const borderColor = isFailing ? 'border-apple-red/30' : 'border-apple-borderLight';
                    const bgColor = isFailing ? 'bg-apple-redLight' : 'bg-apple-surface';

                    html += `<div class="mb-6 ${bgColor} rounded-2xl p-6 border ${borderColor} shadow-sm">`;
                    html += `<div class="flex items-center justify-between mb-4">`;
                    html += `<h4 class="text-base font-semibold text-apple-text">${Report.strategyDisplayName(strategy.name)}</h4>`;
                    if (isFailing) {
                        html += `<span class="px-3 py-1.5 bg-apple-red/10 rounded-full text-apple-red text-xs font-medium">
                            ${strategy.successRate.toFixed(0)}% success rate
                        </span>`;
                    } else {
                        html += `<span class="px-3 py-1.5 bg-apple-green/10 rounded-full text-apple-green text-xs font-medium">
                            ${strategy.successRate.toFixed(0)}% success rate
                        </span>`;
                    }
                    html += `</div>`;
                    html += `<div id="histogram-${strategy.name}"></div>`;
                    html += '</div>';
                });

                html += '</div>';

                html += '</div>';

                document.getElementById('tab-charts').innerHTML = html;

                // Wait for DOM update, then draw charts
                setTimeout(() => {
                    // Deflate nominal values to today's dollars for display
                    const inflationMultiplier = 1 + inputs.inflationRate / 100;
                    const deflate = (values) => values.map((v, idx) => v / Math.pow(inflationMultiplier, idx));
                    const deflatePercentilePaths = (paths) => ({
                        p10: deflate(paths.p10),
                        p25: deflate(paths.p25),
                        p50: deflate(paths.p50),
                        p75: deflate(paths.p75),
                        p90: deflate(paths.p90),
                        p95: deflate(paths.p95)
                    });

                    const portfolioData = {
                        startAge: inputs.retirementAge,
                        series: strategies.map(s => ({
                            label: Report.strategyDisplayName(s.name),
                            values: deflate(s.percentilePaths.p50),  // True median portfolio per year
                            percentilePaths: deflatePercentilePaths(s.percentilePaths)
                        }))
                    };

                    const withdrawalData = {
                        startAge: inputs.retirementAge,
                        series: strategies.map(s => ({
                            label: Report.strategyDisplayName(s.name),
                            values: deflate(s.medianWithdrawalPath)  // True median withdrawals per year
                        }))
                    };

                    Charts.drawLineChart(document.getElementById('chart-portfolio'), portfolioData, 'Portfolio Value (Median)');
                    Charts.drawLineChart(document.getElementById('chart-withdrawals'), withdrawalData, 'Annual Withdrawals (Median)');

                    // Draw histograms using ApexCharts
                    DistributionHistogram.destroyAll(); // Clean up previous charts
                    strategies.forEach(strategy => {
                        const histogramContainer = document.getElementById(`histogram-${strategy.name}`);
                        if (histogramContainer) {
                            histogramContainer.innerHTML = DistributionHistogram.render(results, strategy.name);
                            // Render ApexChart after container is in DOM
                            setTimeout(() => {
                                DistributionHistogram.renderApexChart(results, strategy.name, inputs);
                            }, 50);
                        }
                    });
                }, 100);
            },

            /**
             * Details tab: Combines report, tables, and assumptions into expandable sections
             */
            displayDetails(results, inputs) {
                let html = '<div class="space-y-4">';

                // Expandable: Written Analysis
                html += `
                    <details id="analysis-section" class="group bg-apple-bgAlt rounded-xl border border-apple-border" open>
                        <summary class="flex items-center justify-between p-4 cursor-pointer">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-[#bf5af2]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                <span class="text-apple-blue font-medium">Personalized Analysis & Recommendations</span>
                            </div>
                            <svg class="w-5 h-5 text-apple-textTertiary group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </summary>
                        <div class="p-4 pt-0 border-t border-apple-border" id="details-report">
                            <!-- Populated from tab-report -->
                        </div>
                    </details>
                `;

                // Expandable: Year-by-Year Tables
                html += `
                    <details class="group bg-apple-bgAlt rounded-xl border border-apple-border">
                        <summary class="flex items-center justify-between p-4 cursor-pointer">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-apple-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                <span class="text-apple-blue font-medium">Year-by-Year Tables</span>
                            </div>
                            <svg class="w-5 h-5 text-apple-textTertiary group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </summary>
                        <div class="p-4 pt-0 border-t border-apple-border" id="details-tables">
                            <!-- Populated from tab-tables -->
                        </div>
                    </details>
                `;

                // Expandable: Your Assumptions
                html += `
                    <details class="group bg-apple-bgAlt rounded-xl border border-apple-border">
                        <summary class="flex items-center justify-between p-4 cursor-pointer">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 text-[#bf5af2]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                <span class="text-apple-blue font-medium">Your Assumptions</span>
                            </div>
                            <svg class="w-5 h-5 text-apple-textTertiary group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </summary>
                        <div class="p-4 pt-0 border-t border-apple-border" id="details-assumptions">
                            <!-- Populated from tab-assumptions -->
                        </div>
                    </details>
                `;

                html += '</div>';
                document.getElementById('tab-details').innerHTML = html;

                // Copy content from old tabs to new expandable sections
                setTimeout(() => {
                    const reportContent = document.getElementById('tab-report').innerHTML;
                    const tablesContent = document.getElementById('tab-tables').innerHTML;
                    const assumptionsContent = document.getElementById('tab-assumptions').innerHTML;

                    document.getElementById('details-report').innerHTML = reportContent;
                    document.getElementById('details-tables').innerHTML = tablesContent;
                    document.getElementById('details-assumptions').innerHTML = assumptionsContent;
                }, 100);
            },

            /**
             * Detailed Tables tab: Year-by-year breakdown for each strategy
             */
            displayDetailedTables(results, inputs) {
                const strategies = Object.values(results);
                // Calculate percentiles based on target success rate
                // Poor = lower percentile (worse outcomes), Good = higher percentile (better outcomes)
                const rawPoor = 100 - inputs.targetSuccessRate;
                const rawGood = inputs.targetSuccessRate;
                const poorPercentile = Math.min(rawPoor, rawGood);
                const goodPercentile = Math.max(rawPoor, rawGood);

                let html = '<div class="space-y-8">';

                html += '<h3 class="text-xl font-semibold text-apple-text mb-2">Year-by-Year Details</h3>';
                html += '<p class="text-apple-textSecondary mb-2">Detailed breakdown showing portfolio value and withdrawals for each year of retirement under each strategy.</p>';
                html += '<p class="text-xs text-apple-textTertiary mb-2 font-medium">All dollar amounts are in today\'s dollars (inflation-adjusted to maintain purchasing power)</p>';
                html += `<p class="text-xs text-apple-textTertiary mb-6"><span class="text-red-400 font-medium">P${poorPercentile}</span> = ${poorPercentile}th percentile (worse outcomes)  <span class="font-medium">Median</span> = typical outcome  <span class="text-green-400 font-medium">P${goodPercentile}</span> = ${goodPercentile}th percentile (better outcomes)</p>`;

                strategies.forEach(strategy => {
                    html += `<div class="border border-apple-border rounded-xl p-4 bg-apple-surface">`;
                    html += `<h4 class="text-lg font-semibold text-apple-text mb-3">${Report.strategyDisplayName(strategy.name)}</h4>`;

                    html += '<div class="overflow-x-auto rounded-xl border border-apple-border mb-2">';
                    html += '<table class="min-w-full divide-y divide-apple-border" style="font-size: 11px;">';
                    html += '<thead class="bg-apple-surface">';
                    html += '<tr>';
                    html += '<th class="px-2 py-1.5 text-left font-medium text-apple-textSecondary">Yr</th>';
                    html += '<th class="px-2 py-1.5 text-left font-medium text-apple-textSecondary">Age</th>';
                    html += '<th class="px-2 py-1.5 text-right font-medium text-apple-textSecondary">Start</th>';
                    html += '<th class="px-2 py-1.5 text-right font-medium text-apple-textSecondary">Ret%</th>';
                    html += '<th class="px-2 py-1.5 text-right font-medium text-apple-textSecondary">Annual</th>';
                    html += '<th class="px-2 py-1.5 text-right font-medium text-apple-textSecondary">Monthly</th>';
                    html += `<th class="px-2 py-1.5 text-right font-medium text-red-400">P${poorPercentile}</th>`;
                    html += '<th class="px-2 py-1.5 text-right font-medium text-apple-textSecondary">Median</th>';
                    html += `<th class="px-2 py-1.5 text-right font-medium text-green-400">P${goodPercentile}</th>`;
                    html += '</tr>';
                    html += '</thead>';
                    html += '<tbody class="bg-apple-surface divide-y divide-apple-border">';

                    // Show all years - deflate nominal values to today's dollars
                    const years = strategy.medianPath;
                    const inflationMultiplier = 1 + inputs.inflationRate / 100;

                    // Get the correct percentile paths based on target success rate
                    const poorKey = 'p' + poorPercentile;
                    const goodKey = 'p' + goodPercentile;
                    const poorPath = strategy.percentilePaths[poorKey] || strategy.percentilePaths.p10;
                    const goodPath = strategy.percentilePaths[goodKey] || strategy.percentilePaths.p90;

                    years.forEach((year, idx) => {
                        // Deflate nominal values back to today's purchasing power
                        const deflator = Math.pow(inflationMultiplier, idx);
                        const realPortfolioStart = year.portfolioStart / deflator;
                        const realWithdrawal = year.withdrawal / deflator;
                        const realMonthlyWithdrawal = realWithdrawal / 12;
                        const realPortfolioEnd = year.portfolioEnd / deflator;
                        const realPoorEnd = (poorPath[idx] || 0) / deflator;
                        const realGoodEnd = (goodPath[idx] || 0) / deflator;

                        // Highlight poor outcomes in red
                        const poorClass = realPoorEnd === 0 ? 'text-red-600 dark:text-red-400 font-semibold' : 'text-apple-textSecondary';

                        html += '<tr class="hover:bg-apple-bgAlt">';
                        html += `<td class="px-2 py-1 text-apple-blue">${year.year + 1}</td>`;
                        html += `<td class="px-2 py-1 text-apple-blue">${year.age}</td>`;
                        html += `<td class="px-2 py-1 text-right font-mono text-apple-textSecondary">${Charts.formatCurrency(realPortfolioStart)}</td>`;
                        html += `<td class="px-2 py-1 text-right font-mono text-apple-textSecondary">${year.returnPct.toFixed(1)}%</td>`;
                        html += `<td class="px-2 py-1 text-right font-mono text-apple-textSecondary">${Charts.formatCurrency(realWithdrawal)}</td>`;
                        html += `<td class="px-2 py-1 text-right font-mono text-apple-textSecondary">${Charts.formatCurrency(realMonthlyWithdrawal)}</td>`;
                        html += `<td class="px-2 py-1 text-right font-mono ${poorClass}">${Charts.formatCurrency(realPoorEnd)}</td>`;
                        html += `<td class="px-2 py-1 text-right font-mono text-apple-textSecondary font-semibold">${Charts.formatCurrency(realPortfolioEnd)}</td>`;
                        html += `<td class="px-2 py-1 text-right font-mono text-green-400">${Charts.formatCurrency(realGoodEnd)}</td>`;
                        html += '</tr>';
                    });

                    html += '</tbody></table>';
                    html += '</div>';
                    html += '<p class="text-xs text-apple-textTertiary">Complete year-by-year breakdown for entire retirement period. Monthly withdrawal = Annual / 12.</p>';
                    html += '</div>';
                });

                html += '</div>';

                document.getElementById('tab-tables').innerHTML = html;
            },

            /**
             * Report tab: Narrative analysis and recommendations
             */
            displayReport(results, inputs) {
                let html = Report.generateReport(results, inputs);

                // Add historical backtesting section
                html += '<div class="page-break"></div>';
                html += HistoricalBacktesting.generateReport(results, inputs);

                document.getElementById('tab-report').innerHTML = html;
            },

            /**
             * Assumptions tab: Shows all input parameters
             */
            displayAssumptions(inputs) {
                let html = '<div class="space-y-6">';
                html += '<h3 class="text-xl font-semibold text-apple-text mb-4">Current Assumptions</h3>';

                html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">';

                // Plan Setup
                html += '<div class="border border-apple-border rounded-xl p-4 bg-apple-surface">';
                html += '<h4 class="font-semibold text-apple-blue mb-3">Plan Setup</h4>';
                html += '<div class="space-y-2 text-sm text-apple-textSecondary">';
                html += `<div><span class="font-medium">Retirement Age:</span> ${inputs.retirementAge}</div>`;
                html += `<div><span class="font-medium">Planning Horizon:</span> ${inputs.planningAge}</div>`;
                html += `<div><span class="font-medium">Starting Portfolio:</span> ${Charts.formatCurrency(inputs.startingPortfolio)}</div>`;
                html += `<div><span class="font-medium">Starting Withdrawal:</span> ${inputs.startingWithdrawal > 0 ? Charts.formatCurrency(inputs.startingWithdrawal) + '/year' : 'Use strategy default'}</div>`;
                html += `<div><span class="font-medium">Years in Retirement:</span> ${inputs.planningAge - inputs.retirementAge}</div>`;
                html += '</div>';
                html += '</div>';

                // Market Assumptions
                html += '<div class="border border-apple-border rounded-xl p-4 bg-apple-surface">';
                html += '<h4 class="font-semibold text-apple-blue mb-3">Market Assumptions</h4>';
                html += '<div class="space-y-2 text-sm text-apple-textSecondary">';
                html += `<div><span class="font-medium">Expected Real Return:</span> ${inputs.expectedReturn.toFixed(1)}% per year</div>`;
                html += `<div><span class="font-medium">Volatility:</span> ${inputs.volatility.toFixed(1)}% std dev</div>`;
                html += `<div><span class="font-medium">Inflation Rate:</span> ${inputs.inflationRate.toFixed(1)}% per year</div>`;
                html += `<div><span class="font-medium">Monte Carlo Runs:</span> ${inputs.monteCarloRuns.toLocaleString()}</div>`;
                html += '</div>';
                html += '</div>';

                // Income & Constraints
                html += '<div class="border border-apple-border rounded-xl p-4 bg-apple-surface">';
                html += '<h4 class="font-semibold text-apple-blue mb-3">Income & Constraints</h4>';
                html += '<div class="space-y-2 text-sm text-apple-textSecondary">';
                html += `<div><span class="font-medium">Min Withdrawal:</span> ${Charts.formatCurrency(inputs.minSpending)}/year</div>`;
                html += `<div><span class="font-medium">Max Withdrawal:</span> ${inputs.maxSpending > 0 ? Charts.formatCurrency(inputs.maxSpending) + '/year' : 'No cap'}</div>`;
                html += `<div><span class="font-medium">One-Time Expense (Every 5 Years):</span> ${Charts.formatCurrency(inputs.oneTimeExpense || 0)}</div>`;
                html += `<div><span class="font-medium">Social Security:</span> ${Charts.formatCurrency(inputs.socialSecurity)}/year</div>`;
                html += `<div><span class="font-medium">SS Start Age:</span> ${inputs.ssStartAge}</div>`;
                html += `<div><span class="font-medium">Target Success Rate:</span> ${inputs.targetSuccessRate}%</div>`;
                html += '</div>';
                html += '</div>';

                // Strategies
                html += '<div class="border border-apple-border rounded-xl p-4 bg-apple-surface">';
                html += '<h4 class="font-semibold text-apple-blue mb-3">Selected Strategies</h4>';
                html += '<ul class="space-y-1 text-sm text-apple-textSecondary list-disc list-inside">';
                inputs.strategies.forEach(s => {
                    html += `<li>${Report.strategyDisplayName(s)}</li>`;
                });
                html += '</ul>';
                html += '</div>';

                html += '</div>';

                html += '<div class="mt-6 text-center">';
                html += '<button id="edit-assumptions-btn" class="bg-primary-600 hover:bg-primary-700 text-apple-blue font-semibold py-2 px-6 rounded-xl shadow transition-colors">';
                html += 'Edit Assumptions';
                html += '</button>';
                html += '</div>';

                html += '</div>';

                document.getElementById('tab-assumptions').innerHTML = html;

                // Add click handler to edit button
                setTimeout(() => {
                    const editBtn = document.getElementById('edit-assumptions-btn');
                    if (editBtn) {
                        editBtn.addEventListener('click', () => {
                            document.getElementById('results-panel').classList.add('hidden');
                            document.getElementById('assumptions-panel').classList.remove('hidden');
                            document.getElementById('back-to-assumptions').classList.add('hidden');
                        });
                    }
                }, 100);
            },

            /**
             * Initialize tab switching functionality
             */
            initTabs() {
                const tabButtons = document.querySelectorAll('.tab-button');
                const tabContents = document.querySelectorAll('.tab-content');

                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const targetTab = button.getAttribute('data-tab');

                        // Update button states with new color scheme
                        tabButtons.forEach(btn => {
                            btn.classList.remove('active', 'border-primary-500', 'text-primary-600', 'dark:text-primary-400', 'border-apple-blue', 'text-apple-blue');
                            btn.classList.add('text-apple-textTertiary', 'border-transparent');
                        });
                        button.classList.add('active', 'border-apple-blue', 'text-apple-blue');
                        button.classList.remove('text-apple-textTertiary', 'border-transparent');

                        // Update content visibility with animation
                        tabContents.forEach(content => {
                            if (content.id === `tab-${targetTab}`) {
                                // Fade in the new content
                                content.classList.remove('hidden');
                                content.classList.add('active');
                                content.style.opacity = '0';
                                content.style.transform = 'translateY(10px)';
                                requestAnimationFrame(() => {
                                    content.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                                    content.style.opacity = '1';
                                    content.style.transform = 'translateY(0)';
                                });
                            } else {
                                content.classList.add('hidden');
                                content.classList.remove('active');
                            }
                        });

                        // Bounce animation on the active tab button
                        button.classList.add('attention-bounce');
                        setTimeout(() => button.classList.remove('attention-bounce'), 600);
                    });
                });
            },

            /**
             * Initialize theme toggle functionality
             */
            initThemeToggle() {
                // Always use dark mode
                document.documentElement.classList.add('dark');
            },

            /**
             * Initialize all UI components and event handlers
             */
            init() {
                this.initTabs();
                this.initThemeToggle();
                this.initTippyTooltips();
                this.initAccessibility();

                // Run simulation button
                document.getElementById('run-simulation').addEventListener('click', () => {
                    this.runSimulation();
                });

                // Back to assumptions link
                document.getElementById('back-to-assumptions').addEventListener('click', () => {
                    document.getElementById('results-panel').classList.add('hidden');
                    document.getElementById('assumptions-panel').classList.remove('hidden');
                    document.getElementById('back-to-assumptions').classList.add('hidden');
                });

                // Copy shareable URL button
                document.getElementById('copy-share-url').addEventListener('click', () => {
                    this.copyShareableUrl();
                });

                // Load URL parameters and optionally auto-run
                this.loadFromUrlParams();
            },

            /**
             * Generate a shareable URL with current input parameters and copy to clipboard
             */
            async copyShareableUrl() {
                const inputs = this.getInputs();
                const params = new URLSearchParams();

                // Add all parameters to URL
                params.set('retirementAge', inputs.retirementAge);
                params.set('planningAge', inputs.planningAge);
                params.set('startingPortfolio', inputs.startingPortfolio);
                params.set('startingWithdrawal', inputs.startingWithdrawal);
                params.set('expectedReturn', inputs.expectedReturn);
                params.set('volatility', inputs.volatility);
                params.set('inflationRate', inputs.inflationRate);
                params.set('monteCarloRuns', inputs.monteCarloRuns);
                params.set('minSpending', inputs.minSpending);
                params.set('maxSpending', inputs.maxSpending);
                params.set('oneTimeExpense', inputs.oneTimeExpense);
                params.set('socialSecurity', inputs.socialSecurity);
                params.set('ssStartAge', inputs.ssStartAge);
                params.set('targetSuccessRate', inputs.targetSuccessRate);

                // Strategy parameters
                params.set('constantRealRate', inputs.constantRealRate);
                params.set('constantPctRate', inputs.constantPctRate);
                params.set('guardrailsInitialRate', inputs.guardrailsInitialRate);
                params.set('guardrailsUpper', inputs.guardrailsUpper);
                params.set('guardrailsLower', inputs.guardrailsLower);
                params.set('guardrailsAdjustment', inputs.guardrailsAdjustment);
                params.set('vpwStockAllocation', inputs.vpwStockAllocation);

                // Return distribution and expense parameters
                params.set('returnDistribution', inputs.returnDistribution);
                params.set('expenseFirstYear', inputs.expenseFirstYear);
                params.set('expenseFrequency', inputs.expenseFrequency);
                params.set('expenseMaxCount', inputs.expenseMaxCount);

                // Add strategies as comma-separated list
                if (inputs.strategies.length > 0) {
                    params.set('strategies', inputs.strategies.join(','));
                }

                // Add autorun if checked
                if (document.getElementById('include-autorun').checked) {
                    params.set('autorun', 'true');
                }

                // Build full URL
                const url = `${window.location.origin}${window.location.pathname}?${params.toString()}`;

                // Copy to clipboard
                const textEl = document.getElementById('copy-share-text');
                const originalText = textEl.textContent;

                try {
                    await navigator.clipboard.writeText(url);
                    textEl.textContent = 'Copied!';
                    setTimeout(() => {
                        textEl.textContent = originalText;
                    }, 2000);
                } catch (err) {
                    // Fallback for older browsers
                    const textarea = document.createElement('textarea');
                    textarea.value = url;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    textEl.textContent = 'Copied!';
                    setTimeout(() => {
                        textEl.textContent = originalText;
                    }, 2000);
                }
            },

            /**
             * Parse URL parameters and populate form inputs
             * Supports all simulation parameters via query string
             */
            loadFromUrlParams() {
                const params = new URLSearchParams(window.location.search);
                if (params.size === 0) return;

                // Map of URL param names to input element IDs and their type
                const paramMapping = {
                    'retirementAge': { id: 'retirement-age', type: 'number' },
                    'planningAge': { id: 'planning-age', type: 'number' },
                    'startingPortfolio': { id: 'starting-portfolio', type: 'currency' },
                    'startingWithdrawal': { id: 'starting-withdrawal', type: 'currency' },
                    'expectedReturn': { id: 'expected-return', type: 'percent' },
                    'volatility': { id: 'volatility', type: 'percent' },
                    'inflationRate': { id: 'inflation-rate', type: 'percent' },
                    'monteCarloRuns': { id: 'monte-carlo-runs', type: 'number' },
                    'minSpending': { id: 'min-spending', type: 'currency' },
                    'maxSpending': { id: 'max-spending', type: 'currency' },
                    'oneTimeExpense': { id: 'one-time-expense', type: 'currency' },
                    'socialSecurity': { id: 'social-security', type: 'currency' },
                    'ssStartAge': { id: 'ss-start-age', type: 'number' },
                    'targetSuccessRate': { id: 'risk-tolerance', type: 'number' },
                    // Strategy parameters
                    'constantRealRate': { id: 'constant-real-rate', type: 'percent' },
                    'constantPctRate': { id: 'constant-pct-rate', type: 'percent' },
                    'guardrailsInitialRate': { id: 'guardrails-initial-rate', type: 'percent' },
                    'guardrailsUpper': { id: 'guardrails-upper', type: 'percent' },
                    'guardrailsLower': { id: 'guardrails-lower', type: 'percent' },
                    'guardrailsAdjustment': { id: 'guardrails-adjustment', type: 'percent' },
                    'vpwStockAllocation': { id: 'vpw-stock-allocation', type: 'number' },
                    // Return distribution
                    'returnDistribution': { id: 'return-distribution', type: 'select' },
                    // Expense parameters
                    'expenseFirstYear': { id: 'expense-first-year', type: 'number' },
                    'expenseFrequency': { id: 'expense-frequency', type: 'number' },
                    'expenseMaxCount': { id: 'expense-max-count', type: 'number' }
                };

                // Apply each parameter to its corresponding input
                for (const [paramName, config] of Object.entries(paramMapping)) {
                    const value = params.get(paramName);
                    if (value !== null) {
                        const element = document.getElementById(config.id);
                        if (element) {
                            if (config.type === 'currency') {
                                element.value = formatNumber(parseFloat(value));
                            } else if (config.type === 'percent') {
                                element.value = parseFloat(value).toFixed(1);
                            } else {
                                element.value = value;
                            }
                        }
                    }
                }

                // Handle strategy selections (comma-separated list)
                const strategies = params.get('strategies');
                if (strategies) {
                    const strategyList = strategies.split(',').map(s => s.trim());
                    const allStrategies = ['constant-real', 'constant-pct', 'vpw', 'guardrails', 'rmd'];

                    // Uncheck all strategies first
                    allStrategies.forEach(s => {
                        const el = document.getElementById(`strategy-${s}`);
                        if (el) el.checked = false;
                    });

                    // Check only the specified strategies
                    strategyList.forEach(s => {
                        const el = document.getElementById(`strategy-${s}`);
                        if (el) el.checked = true;
                    });
                }

                // Auto-run simulation if requested
                if (params.get('autorun') === 'true' || params.get('autorun') === '1') {
                    // Small delay to ensure UI is ready
                    setTimeout(() => this.runSimulation(), 200);
                }
            },

            /**
             * Initialize Tippy.js tooltips for all info icons
             * WCAG 2.2 compliant with keyboard support
             */
            initTippyTooltips() {
                if (typeof tippy === 'undefined') return;

                // Find all tooltip elements and convert to Tippy
                document.querySelectorAll('.tooltip').forEach(tooltip => {
                    const content = tooltip.querySelector('.tooltiptext');
                    if (!content) return;

                    const infoIcon = tooltip.querySelector('.info-icon');
                    if (!infoIcon) return;

                    // Make info icon focusable for keyboard users
                    infoIcon.setAttribute('tabindex', '0');
                    infoIcon.setAttribute('role', 'button');
                    infoIcon.setAttribute('aria-label', 'More information');

                    tippy(infoIcon, {
                        content: content.textContent,
                        theme: 'custom',
                        animation: 'shift-away',
                        placement: 'top',
                        trigger: 'mouseenter focus',
                        interactive: true,
                        allowHTML: false,
                        maxWidth: 300,
                        // WCAG: Tooltip stays open on hover
                        hideOnClick: false,
                        // WCAG: Support keyboard navigation
                        appendTo: document.body
                    });

                    // Hide the original tooltiptext since Tippy handles it now
                    content.style.display = 'none';
                });
            },

            /**
             * Initialize accessibility features
             */
            initAccessibility() {
                // Announce dynamic content changes to screen readers
                this.ariaLive = document.getElementById('aria-live');

                // Always enable animations (user preference)
                this.prefersReducedMotion = false;
            },

            /**
             * Announce message to screen readers
             */
            announceToScreenReader(message) {
                if (this.ariaLive) {
                    this.ariaLive.textContent = message;
                    // Clear after announcement
                    setTimeout(() => {
                        this.ariaLive.textContent = '';
                    }, 1000);
                }
            }
        };

        // ============================================
        // CELEBRATION EFFECTS
        // Visual feedback for successful outcomes
        // ============================================
        const CelebrationEffects = {
            /**
             * Create confetti celebration for high success rates
             */
            triggerConfetti(count = 50) {
                const colors = ['#0a84ff', '#30d158', '#ff9f0a', '#bf5af2', '#ff453a', '#64d2ff'];

                for (let i = 0; i < count; i++) {
                    setTimeout(() => {
                        const confetti = document.createElement('div');
                        confetti.className = 'confetti-piece';
                        confetti.style.left = Math.random() * 100 + 'vw';
                        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                        confetti.style.animationDelay = Math.random() * 0.5 + 's';
                        confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
                        confetti.style.transform = `rotate(${Math.random() * 360}deg)`;

                        if (Math.random() > 0.5) {
                            confetti.style.borderRadius = '50%';
                        }

                        document.body.appendChild(confetti);

                        // Remove after animation
                        setTimeout(() => confetti.remove(), 4000);
                    }, i * 30);
                }
            },

            /**
             * Trigger celebration based on success rate
             */
            celebrateIfWarranted(bestSuccessRate, targetRate) {
                if (bestSuccessRate >= targetRate && bestSuccessRate >= 90) {
                    this.triggerConfetti(60);
                    this.addSparkles(12);
                } else if (bestSuccessRate >= targetRate) {
                    this.triggerConfetti(30);
                    this.addSparkles(6);
                }
            },

            /**
             * Add sparkle effects around the screen
             */
            addSparkles(count) {
                for (let i = 0; i < count; i++) {
                    setTimeout(() => {
                        const sparkle = document.createElement('div');
                        sparkle.className = 'sparkle';
                        sparkle.style.left = (10 + Math.random() * 80) + 'vw';
                        sparkle.style.top = (10 + Math.random() * 80) + 'vh';
                        sparkle.style.animationDelay = (Math.random() * 0.5) + 's';
                        sparkle.style.zIndex = '9998';
                        sparkle.style.position = 'fixed';
                        document.body.appendChild(sparkle);

                        setTimeout(() => sparkle.remove(), 2000);
                    }, i * 100);
                }
            },

            /**
             * Animate a number counting up from 0 to target value
             */
            animateNumber(elementId, targetValue, duration = 1500, suffix = '%') {
                const element = document.getElementById(elementId);
                if (!element) return;

                const startTime = performance.now();
                const startValue = 0;

                const easeOutExpo = (t) => t === 1 ? 1 : 1 - Math.pow(2, -10 * t);

                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const easedProgress = easeOutExpo(progress);
                    const currentValue = startValue + (targetValue - startValue) * easedProgress;

                    element.textContent = Math.round(currentValue) + suffix;

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        // Add a little bounce at the end
                        element.classList.add('attention-bounce');
                        setTimeout(() => element.classList.remove('attention-bounce'), 600);
                    }
                };

                requestAnimationFrame(animate);
            },

            /**
             * Create burst effect at element position
             */
            createBurst(element) {
                const rect = element.getBoundingClientRect();
                const burst = document.createElement('div');
                burst.className = 'success-burst';
                burst.style.left = rect.left + rect.width / 2 + 'px';
                burst.style.top = rect.top + rect.height / 2 + 'px';
                document.body.appendChild(burst);
                setTimeout(() => burst.remove(), 1000);
            }
        };

        // ============================================
        // KEY INSIGHTS GENERATOR
        // Enhanced with actionable guidance and recommendations
        // ============================================
        const InsightsGenerator = {
            /**
             * Calculate what portfolio size would be needed to achieve target success rate
             * Uses binary search to find the portfolio that achieves the target
             */
            estimateRequiredPortfolio(inputs, targetSuccessRate) {
                const bestStrategy = 'constant-pct'; // Most resilient strategy
                let low = inputs.startingPortfolio * 0.5;
                let high = inputs.startingPortfolio * 5;

                // Simple estimation: assume linear relationship between portfolio and success
                // This is a rough approximation for guidance
                const currentResult = Simulation.runStrategy(bestStrategy, inputs);
                const currentSuccess = currentResult.successRate;

                if (currentSuccess >= targetSuccessRate) {
                    return inputs.startingPortfolio; // Already meeting target
                }

                // Estimate based on ratio needed
                const successGap = targetSuccessRate - currentSuccess;
                const multiplier = 1 + (successGap / 100) * 2.5; // Rough heuristic
                return Math.round(inputs.startingPortfolio * multiplier);
            },

            /**
             * Calculate what spending level would achieve target success rate
             */
            estimateSafeSpending(inputs, targetSuccessRate) {
                // Run a quick simulation with reduced spending to estimate safe level
                const testInputs = { ...inputs };
                const currentWithdrawalRate = inputs.minSpending / inputs.startingPortfolio;

                // If withdrawal rate is already low, spending is probably fine
                if (currentWithdrawalRate <= 0.03) {
                    return inputs.minSpending;
                }

                // Estimate safe spending based on classic safe withdrawal research
                // Adjusted for retirement length and expected returns
                const yearsInRetirement = inputs.planningAge - inputs.retirementAge;
                let safeRate = 0.04; // Start with 4% rule

                // Adjust for longer retirements
                if (yearsInRetirement > 30) {
                    safeRate = 0.035;
                }
                if (yearsInRetirement > 40) {
                    safeRate = 0.03;
                }

                // Adjust for expected returns
                if (inputs.expectedReturn < 4) {
                    safeRate -= 0.005;
                }
                if (inputs.expectedReturn > 6) {
                    safeRate += 0.005;
                }

                // Account for Social Security
                const ssAtRetirement = inputs.retirementAge >= inputs.ssStartAge ? inputs.socialSecurity : 0;
                const safePortfolioSpending = inputs.startingPortfolio * safeRate;

                return Math.round(safePortfolioSpending + ssAtRetirement);
            },

            /**
             * Estimate impact of delaying retirement
             */
            estimateDelayImpact(inputs, yearsDelay) {
                // Each year of delay provides:
                // 1. More time for portfolio to grow
                // 2. Fewer years to fund
                // 3. Higher Social Security (if applicable)

                const currentYears = inputs.planningAge - inputs.retirementAge;
                const newYears = inputs.planningAge - (inputs.retirementAge + yearsDelay);
                const yearsReduction = ((currentYears - newYears) / currentYears) * 100;

                // Estimate portfolio growth during delay
                const growthMultiplier = Math.pow(1 + inputs.expectedReturn / 100, yearsDelay);
                const projectedPortfolio = inputs.startingPortfolio * growthMultiplier;

                return {
                    yearsReduction,
                    projectedPortfolio,
                    additionalGrowth: projectedPortfolio - inputs.startingPortfolio
                };
            },

            generate(results, inputs) {
                const strategies = Object.values(results);
                const insights = [];
                const recommendations = [];

                // Calculate deflator for final values (end of retirement period)
                const years = inputs.planningAge - inputs.retirementAge;
                const inflationMultiplier = 1 + inputs.inflationRate / 100;
                const finalDeflator = Math.pow(inflationMultiplier, years - 1);

                // ============================================
                // CORE SUCCESS ANALYSIS
                // ============================================
                const bestSuccess = strategies.reduce((max, s) => s.successRate > max.successRate ? s : max);
                const worstSuccess = strategies.reduce((min, s) => s.successRate < min.successRate ? s : min);
                const meetsTarget = strategies.filter(s => s.successRate >= inputs.targetSuccessRate);

                // Primary success message
                if (meetsTarget.length === 0) {
                    insights.push({
                        type: 'warning',
                        icon: '',
                        text: `None of the strategies meet your ${inputs.targetSuccessRate}% target success rate. The best performing strategy (${Report.strategyDisplayName(bestSuccess.name)}) achieves ${bestSuccess.successRate.toFixed(1)}%. See recommendations below.`,
                        priority: 1
                    });
                } else if (meetsTarget.length === strategies.length) {
                    insights.push({
                        type: 'success',
                        icon: '',
                        text: `All ${meetsTarget.length} strategies meet your ${inputs.targetSuccessRate}% target! Your plan appears well-funded with a comfortable margin of safety.`,
                        priority: 1
                    });
                } else {
                    insights.push({
                        type: 'success',
                        icon: '',
                        text: `${meetsTarget.length} of ${strategies.length} strategies meet your ${inputs.targetSuccessRate}% target. ${Report.strategyDisplayName(bestSuccess.name)} performs best at ${bestSuccess.successRate.toFixed(1)}%.`,
                        priority: 1
                    });
                }

                // ============================================
                // WITHDRAWAL RATE ANALYSIS
                // ============================================
                const initialWithdrawalRate = (inputs.minSpending / inputs.startingPortfolio) * 100;
                const yearsInRetirement = inputs.planningAge - inputs.retirementAge;

                // Determine safe withdrawal rate based on retirement length
                let safeWRBenchmark = 4.0;
                let safeWRLabel = "4% rule";
                if (yearsInRetirement > 40) {
                    safeWRBenchmark = 3.0;
                    safeWRLabel = "3% (40+ year retirement)";
                } else if (yearsInRetirement > 30) {
                    safeWRBenchmark = 3.5;
                    safeWRLabel = "3.5% (30+ year retirement)";
                }

                if (initialWithdrawalRate > safeWRBenchmark * 1.5) {
                    insights.push({
                        type: 'warning',
                        icon: '',
                        text: `Your initial withdrawal rate of ${initialWithdrawalRate.toFixed(1)}% is significantly higher than the ${safeWRLabel} benchmark. This is the primary risk factor in your plan.`,
                        priority: 2
                    });
                } else if (initialWithdrawalRate > safeWRBenchmark) {
                    insights.push({
                        type: 'warning',
                        icon: '',
                        text: `Your initial withdrawal rate of ${initialWithdrawalRate.toFixed(1)}% exceeds the ${safeWRLabel} benchmark. Consider strategies that adapt spending to market conditions.`,
                        priority: 2
                    });
                } else if (initialWithdrawalRate < safeWRBenchmark * 0.75) {
                    insights.push({
                        type: 'success',
                        icon: '',
                        text: `Your withdrawal rate of ${initialWithdrawalRate.toFixed(1)}% is conservative, well below the ${safeWRLabel} benchmark. You have a strong margin of safety.`,
                        priority: 2
                    });
                }

                // ============================================
                // SOCIAL SECURITY ANALYSIS
                // ============================================
                if (inputs.socialSecurity > 0) {
                    const yearsUntilSS = Math.max(0, inputs.ssStartAge - inputs.retirementAge);
                    const ssPercentOfSpending = (inputs.socialSecurity / inputs.minSpending) * 100;

                    if (yearsUntilSS > 0) {
                        insights.push({
                            type: 'info',
                            icon: '',
                            text: `Social Security begins ${yearsUntilSS} years after retirement (age ${inputs.ssStartAge}). During this gap, your portfolio must cover 100% of spending. Once SS starts, it covers ${ssPercentOfSpending.toFixed(0)}% of your minimum spending.`,
                            priority: 3
                        });

                        // Calculate the portfolio draw during SS gap
                        const inflationMultiplier = 1 + inputs.inflationRate / 100;
                        let totalGapSpending = 0;
                        for (let i = 0; i < yearsUntilSS; i++) {
                            totalGapSpending += inputs.minSpending * Math.pow(inflationMultiplier, i);
                        }

                        if (totalGapSpending > inputs.startingPortfolio * 0.3) {
                            insights.push({
                                type: 'warning',
                                icon: '',
                                text: `Before Social Security starts, you'll need approximately ${Charts.formatCurrency(totalGapSpending)} from your portfolio (${((totalGapSpending / inputs.startingPortfolio) * 100).toFixed(0)}% of starting value). This early drawdown period is critical.`,
                                priority: 3
                            });
                        }
                    } else {
                        insights.push({
                            type: 'success',
                            icon: '',
                            text: `Social Security provides ${Charts.formatCurrency(inputs.socialSecurity)}/year (${ssPercentOfSpending.toFixed(0)}% of minimum spending) from day one, significantly reducing portfolio strain.`,
                            priority: 3
                        });
                    }
                }

                // ============================================
                // LONGEVITY & SEQUENCE RISK
                // ============================================
                if (yearsInRetirement > 35) {
                    insights.push({
                        type: 'info',
                        icon: '',
                        text: `A ${yearsInRetirement}-year retirement requires careful planning. The first 10 years are criticala severe market downturn early in retirement (sequence-of-returns risk) has the greatest impact on long-term success.`,
                        priority: 4
                    });
                }

                // ============================================
                // STRATEGY-SPECIFIC INSIGHTS
                // ============================================
                // Analyze spread between strategies
                const successSpread = bestSuccess.successRate - worstSuccess.successRate;
                if (successSpread > 20) {
                    insights.push({
                        type: 'info',
                        icon: '',
                        text: `Strategy choice matters significantly for your plan: success rates range from ${worstSuccess.successRate.toFixed(1)}% to ${bestSuccess.successRate.toFixed(1)}% (${successSpread.toFixed(0)} point spread). Flexible strategies like ${Report.strategyDisplayName(bestSuccess.name)} adapt better to your situation.`,
                        priority: 4
                    });
                }

                // Check if constant-pct is available and how it compares
                const constantPct = strategies.find(s => s.name === 'constant-pct');
                const constantReal = strategies.find(s => s.name === 'constant-real');
                if (constantPct && constantReal && constantPct.successRate > constantReal.successRate + 10) {
                    insights.push({
                        type: 'info',
                        icon: '',
                        text: `Constant % of Portfolio outperforms the traditional 4% Rule by ${(constantPct.successRate - constantReal.successRate).toFixed(0)} points because it automatically reduces spending during downturns. Trade-off: income varies with market performance.`,
                        priority: 5
                    });
                }

                // ============================================
                // ACTIONABLE RECOMMENDATIONS
                // ============================================
                if (bestSuccess.successRate < inputs.targetSuccessRate) {
                    const gap = inputs.targetSuccessRate - bestSuccess.successRate;

                    // Recommendation 1: Reduce spending
                    const safeSpending = this.estimateSafeSpending(inputs, inputs.targetSuccessRate);
                    if (safeSpending < inputs.minSpending) {
                        const reduction = inputs.minSpending - safeSpending;
                        const reductionPct = (reduction / inputs.minSpending) * 100;
                        recommendations.push({
                            icon: '',
                            title: 'Reduce Annual Spending',
                            text: `Reducing spending to ${Charts.formatCurrency(safeSpending)}/year (-${reductionPct.toFixed(0)}%) would significantly improve success rates. This brings your withdrawal rate closer to sustainable levels.`,
                            impact: 'High Impact'
                        });
                    }

                    // Recommendation 2: Increase portfolio
                    const requiredPortfolio = this.estimateRequiredPortfolio(inputs, inputs.targetSuccessRate);
                    if (requiredPortfolio > inputs.startingPortfolio) {
                        const additional = requiredPortfolio - inputs.startingPortfolio;
                        recommendations.push({
                            icon: '',
                            title: 'Increase Starting Portfolio',
                            text: `A portfolio of approximately ${Charts.formatCurrency(requiredPortfolio)} (+${Charts.formatCurrency(additional)}) would better support your spending goals at your target success rate.`,
                            impact: 'High Impact'
                        });
                    }

                    // Recommendation 3: Delay retirement
                    if (inputs.retirementAge < 70) {
                        const delayYears = Math.min(5, 70 - inputs.retirementAge);
                        const delayImpact = this.estimateDelayImpact(inputs, delayYears);
                        recommendations.push({
                            icon: '',
                            title: `Delay Retirement by ${delayYears} Years`,
                            text: `Working until age ${inputs.retirementAge + delayYears} would: (1) allow your portfolio to grow to ~${Charts.formatCurrency(delayImpact.projectedPortfolio)}, (2) reduce retirement years by ${delayImpact.yearsReduction.toFixed(0)}%, and (3) potentially increase Social Security benefits.`,
                            impact: 'High Impact'
                        });
                    }

                    // Recommendation 4: Increase expected return (with caveats)
                    if (inputs.expectedReturn < 6 && recommendations.length < 4) {
                        recommendations.push({
                            icon: '',
                            title: 'Review Asset Allocation',
                            text: `Your expected return of ${inputs.expectedReturn}% is conservative. A more equity-heavy allocation could increase returns, but also increases volatility and sequence-of-returns risk. Consider your risk tolerance carefully.`,
                            impact: 'Medium Impact'
                        });
                    }
                } else {
                    // Already meeting target - provide optimization recommendations
                    if (bestSuccess.successRate > inputs.targetSuccessRate + 15) {
                        recommendations.push({
                            icon: '',
                            title: 'Consider Higher Spending',
                            text: `Your ${bestSuccess.successRate.toFixed(1)}% success rate exceeds your ${inputs.targetSuccessRate}% target by a wide margin. You may be able to spend more or retire earlier while still meeting your goals.`,
                            impact: 'Opportunity'
                        });
                    }

                    // Wealth preservation insight
                    const bestWealth = strategies.reduce((max, s) => s.medianFinal > max.medianFinal ? s : max);
                    if (bestWealth.medianFinal / finalDeflator > inputs.startingPortfolio * 0.5) {
                        recommendations.push({
                            icon: '',
                            title: 'Legacy Planning',
                            text: `${Report.strategyDisplayName(bestWealth.name)} has a median final balance of ${Charts.formatCurrency(bestWealth.medianFinal / finalDeflator)}. If leaving wealth to heirs is important, this strategy preserves the most capital.`,
                            impact: 'Consideration'
                        });
                    }
                }

                // Store recommendations for display
                this._recommendations = recommendations;

                return insights;
            },

            display(insights) {
                let html = '<div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 border border-blue-300 dark:border-blue-800 rounded-xl p-6 mb-6">';
                html += '<h3 class="text-lg font-semibold text-apple-text mb-4 flex items-center">';
                html += '<svg class="w-6 h-6 mr-2 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>';
                html += 'Key Insights';
                html += '</h3>';
                html += '<div class="space-y-3">';

                // Sort insights by priority if available
                const sortedInsights = [...insights].sort((a, b) => (a.priority || 99) - (b.priority || 99));

                sortedInsights.forEach(insight => {
                    const bgColor = {
                        'warning': 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-300 dark:border-yellow-800',
                        'success': 'bg-green-50 dark:bg-green-900/20 border-green-300 dark:border-green-800',
                        'info': 'bg-blue-50 dark:bg-blue-900/20 border-blue-300 dark:border-blue-800'
                    }[insight.type];

                    const textColor = {
                        'warning': 'text-yellow-900 dark:text-yellow-200',
                        'success': 'text-green-900 dark:text-green-200',
                        'info': 'text-blue-900 dark:text-blue-200'
                    }[insight.type];

                    const className = insight.type === 'warning' ? 'insight-warning' : '';

                    html += `<div class="${bgColor} border rounded-xl p-3 ${className}">
                        <p class="text-sm ${textColor} flex items-start">
                            <span class="mr-2 text-lg flex-shrink-0">${insight.icon}</span>
                            <span>${insight.text}</span>
                        </p>
                    </div>`;
                });

                html += '</div>';

                // Add recommendations section if there are any
                if (this._recommendations && this._recommendations.length > 0) {
                    html += '<div class="mt-6 pt-6 border-t border-blue-200 dark:border-blue-800">';
                    html += '<h4 class="text-md font-semibold text-apple-blue mb-4 flex items-center">';
                    html += '<svg class="w-5 h-5 mr-2 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>';
                    html += 'Actionable Recommendations';
                    html += '</h4>';
                    html += '<div class="grid gap-3">';

                    this._recommendations.forEach(rec => {
                        const impactColor = rec.impact === 'High Impact'
                            ? 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200'
                            : rec.impact === 'Medium Impact'
                            ? 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-200'
                            : 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200';

                        html += `<div class="bg-apple-bgAlt border border-gray-200 dark:border-slate-700 rounded-xl p-4">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex items-center">
                                    <span class="text-xl mr-2">${rec.icon}</span>
                                    <span class="font-medium text-apple-blue">${rec.title}</span>
                                </div>
                                <span class="text-xs px-2 py-1 rounded-full ${impactColor}">${rec.impact}</span>
                            </div>
                            <p class="text-sm text-apple-textSecondary ml-8">${rec.text}</p>
                        </div>`;
                    });

                    html += '</div>';
                    html += '</div>';
                }

                html += '</div>';
                return html;
            }
        };

        // ============================================
        // SUCCESS RATE GAUGE
        // ============================================
        const SuccessRateGauge = {
            render(successRate, targetSuccessRate = 90) {
                const radius = 80;
                const circumference = radius * Math.PI; // Half circle
                const offset = circumference - (successRate / 100) * circumference;

                // Color based on target success rate - Apple dark mode colors
                // Green if meets/exceeds target, otherwise scale from red to orange
                let color;
                if (successRate >= targetSuccessRate) {
                    color = '#30d158'; // Apple Green dark mode - meets target
                } else {
                    // Scale from red to orange
                    const ratio = successRate / targetSuccessRate;
                    // Interpolate between red (#ff453a) and orange (#ff9f0a)
                    const r = 255;
                    const g = Math.round(69 + (159 - 69) * ratio);
                    const b = Math.round(58 + (10 - 58) * ratio);
                    color = `rgb(${r}, ${g}, ${b})`;
                }

                const textColor = '#f5f5f7';
                const bgStroke = '#48484a';

                const pulseClass = successRate >= targetSuccessRate ? 'ring-pulse' : '';

                let html = `
                    <div class="gauge-container">
                        <svg width="200" height="120" viewBox="0 0 200 120" class="${pulseClass}" style="color: ${color}">
                            <path class="gauge-background"
                                d="M 20 100 A 80 80 0 1 1 180 100"
                                stroke="${bgStroke}"
                                stroke-width="12"
                                fill="none">
                            </path>
                            <path class="gauge-fill"
                                d="M 20 100 A 80 80 0 1 1 180 100"
                                stroke="${color}"
                                stroke-width="12"
                                fill="none"
                                stroke-dasharray="${circumference}"
                                stroke-dashoffset="${circumference}"
                                stroke-linecap="round"
                                style="transition: stroke-dashoffset 1.5s ease-out; animation: gaugeIn 1.5s ease-out forwards;">
                                <animate attributeName="stroke-dashoffset" from="${circumference}" to="${offset}" dur="1.5s" fill="freeze" calcMode="spline" keySplines="0.4 0 0.2 1"/>
                            </path>
                            <text x="100" y="90" text-anchor="middle" font-size="32" font-weight="bold" fill="${textColor}">
                                ${successRate.toFixed(1)}%
                            </text>
                            <text x="100" y="110" text-anchor="middle" font-size="12" fill="${textColor}" opacity="0.7">
                                Success Rate
                            </text>
                        </svg>
                    </div>`;

                return html;
            }
        };

        // ============================================
        // DISTRIBUTION HISTOGRAM
        // Renders an interactive ApexCharts histogram showing the spread of
        // final portfolio values across all Monte Carlo simulations.
        // Features: Animated bars, hover tooltips, percentile annotations
        // Uses 2nd-98th percentile range to minimize dead space from outliers.
        // ============================================
        const DistributionHistogram = {
            charts: {}, // Store chart instances for cleanup

            render(results, strategyName) {
                const strategy = results[strategyName];
                if (!strategy || !strategy.allFinalValues) return '';

                // Generate unique ID for this chart
                const chartId = `apex-histogram-${strategyName}`;

                // Return container, chart will be rendered after DOM insertion
                return `<div id="${chartId}" class="histogram-chart" data-strategy="${strategyName}" style="min-height: 300px;"></div>`;
            },

            // Call this after the container is added to DOM
            renderApexChart(results, strategyName, inputs) {
                const strategy = results[strategyName];
                if (!strategy || !strategy.allFinalValues) return;

                const chartId = `apex-histogram-${strategyName}`;
                const container = document.getElementById(chartId);
                if (!container) return;

                // Destroy previous chart if exists
                if (this.charts[strategyName]) {
                    this.charts[strategyName].destroy();
                }

                // Calculate deflator for final values (end of retirement period)
                const years = inputs.planningAge - inputs.retirementAge;
                const inflationMultiplier = 1 + inputs.inflationRate / 100;
                const finalDeflator = Math.pow(inflationMultiplier, years - 1);

                // Deflate all final values to today's dollars
                const values = strategy.allFinalValues.map(v => v / finalDeflator);
                const sorted = [...values].sort((a, b) => a - b);

                // Calculate percentiles
                const p2 = this.calculatePercentile(sorted, 2);
                const p25 = this.calculatePercentile(sorted, 25);
                const p50 = this.calculatePercentile(sorted, 50);
                const p75 = this.calculatePercentile(sorted, 75);
                const p95 = this.calculatePercentile(sorted, 95);
                const p98 = this.calculatePercentile(sorted, 98);

                const displayMin = Math.min(0, p2);
                const displayMax = p98 * 1.05;
                const binCount = 20;
                const binWidth = (displayMax - displayMin) / binCount;

                // Count values in each bin
                const bins = Array(binCount).fill(0);
                const categories = [];
                let excludedHigh = 0;

                for (let i = 0; i < binCount; i++) {
                    const binStart = displayMin + i * binWidth;
                    const binEnd = binStart + binWidth;
                    categories.push(Charts.formatCurrency((binStart + binEnd) / 2, true));
                }

                values.forEach(val => {
                    if (val > displayMax) {
                        excludedHigh++;
                        return;
                    }
                    if (val < displayMin) return;
                    const binIndex = Math.min(Math.floor((val - displayMin) / binWidth), binCount - 1);
                    bins[binIndex]++;
                });

                // Create color array (red for $0 bin, gradient for rest) - dark mode colors
                const colors = bins.map((_, i) => {
                    const binValue = displayMin + i * binWidth;
                    if (binValue <= 0) return '#ff453a'; // Red for depleted
                    return '#0a84ff'; // Blue for positive
                });

                // Dark mode colors
                const textColor = '#f5f5f7';
                const gridColor = '#48484a';

                const options = {
                    series: [{
                        name: 'Simulations',
                        data: bins
                    }],
                    chart: {
                        type: 'bar',
                        height: 300,
                        background: 'transparent',
                        animations: {
                            enabled: true,
                            speed: 1000,
                            animateGradually: {
                                enabled: true,
                                delay: 80
                            },
                            dynamicAnimation: {
                                enabled: true,
                                speed: 500
                            }
                        },
                        toolbar: {
                            show: false
                        },
                        fontFamily: 'inherit'
                    },
                    plotOptions: {
                        bar: {
                            borderRadius: 2,
                            columnWidth: '90%',
                            distributed: true,
                            dataLabels: {
                                position: 'top'
                            }
                        }
                    },
                    colors: colors,
                    dataLabels: {
                        enabled: false
                    },
                    legend: {
                        show: false
                    },
                    title: {
                        text: 'Final Portfolio Distribution (Today\'s Dollars)',
                        align: 'center',
                        style: {
                            fontSize: '16px',
                            fontWeight: 600,
                            color: textColor
                        }
                    },
                    subtitle: {
                        text: excludedHigh > 0 ? `${((excludedHigh / values.length) * 100).toFixed(1)}% exceeded ${Charts.formatCurrency(displayMax, true)}` : '',
                        align: 'right',
                        style: {
                            fontSize: '12px',
                            color: textColor,
                            opacity: 0.6
                        }
                    },
                    xaxis: {
                        categories: categories,
                        labels: {
                            style: {
                                colors: textColor,
                                fontSize: '12px'
                            },
                            rotate: -45,
                            rotateAlways: true,
                            hideOverlappingLabels: true
                        },
                        title: {
                            text: 'Final Portfolio Value',
                            style: {
                                color: textColor,
                                fontSize: '14px'
                            }
                        },
                        axisBorder: {
                            color: gridColor
                        },
                        axisTicks: {
                            color: gridColor
                        }
                    },
                    yaxis: {
                        title: {
                            text: 'Count',
                            style: {
                                color: textColor,
                                fontSize: '14px'
                            }
                        },
                        labels: {
                            style: {
                                colors: textColor,
                                fontSize: '12px'
                            }
                        }
                    },
                    grid: {
                        borderColor: gridColor,
                        strokeDashArray: 4
                    },
                    tooltip: {
                        theme: 'dark',
                        y: {
                            formatter: (val) => `${val.toLocaleString()} simulations`
                        }
                    },
                    annotations: {
                        xaxis: [
                            {
                                x: this.findBinCategory(p25, displayMin, binWidth, categories),
                                borderColor: '#ff9500',
                                borderWidth: 2,
                                strokeDashArray: 4,
                                label: {
                                    text: `P25: ${Charts.formatCurrency(p25, true)}`,
                                    borderColor: '#ff9500',
                                    style: {
                                        color: '#fff',
                                        background: '#ff9500',
                                        fontSize: '12px',
                                        fontWeight: 600
                                    }
                                }
                            },
                            {
                                x: this.findBinCategory(p50, displayMin, binWidth, categories),
                                borderColor: '#30d158',
                                borderWidth: 2,
                                strokeDashArray: 4,
                                label: {
                                    text: `Median: ${Charts.formatCurrency(p50, true)}`,
                                    borderColor: '#30d158',
                                    style: {
                                        color: '#fff',
                                        background: '#30d158',
                                        fontSize: '12px',
                                        fontWeight: 600
                                    }
                                }
                            },
                            {
                                x: this.findBinCategory(p75, displayMin, binWidth, categories),
                                borderColor: '#0071e3',
                                borderWidth: 2,
                                strokeDashArray: 4,
                                label: {
                                    text: `P75: ${Charts.formatCurrency(p75, true)}`,
                                    borderColor: '#0071e3',
                                    style: {
                                        color: '#fff',
                                        background: '#0071e3',
                                        fontSize: '12px',
                                        fontWeight: 600
                                    }
                                }
                            },
                            {
                                x: this.findBinCategory(p95, displayMin, binWidth, categories),
                                borderColor: '#5856d6',
                                borderWidth: 2,
                                strokeDashArray: 4,
                                label: {
                                    text: `P95: ${Charts.formatCurrency(p95, true)}`,
                                    borderColor: '#5856d6',
                                    style: {
                                        color: '#fff',
                                        background: '#5856d6',
                                        fontSize: '12px',
                                        fontWeight: 600
                                    }
                                }
                            }
                        ]
                    },
                    states: {
                        hover: {
                            filter: {
                                type: 'lighten',
                                value: 0.1
                            }
                        },
                        active: {
                            filter: {
                                type: 'darken',
                                value: 0.1
                            }
                        }
                    }
                };

                // Create and store chart instance
                this.charts[strategyName] = new ApexCharts(container, options);
                this.charts[strategyName].render();
            },

            findBinCategory(value, displayMin, binWidth, categories) {
                const binIndex = Math.floor((value - displayMin) / binWidth);
                const clampedIndex = Math.max(0, Math.min(binIndex, categories.length - 1));
                return categories[clampedIndex];
            },

            calculatePercentile(values, percentile) {
                const sorted = [...values].sort((a, b) => a - b);
                const index = Math.floor(sorted.length * percentile / 100);
                return sorted[index];
            },

            // Cleanup all charts
            destroyAll() {
                Object.values(this.charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                this.charts = {};
            }
        };

        // ============================================
        // HISTORICAL BACKTESTING
        // ============================================
        const HistoricalBacktesting = {
            // Historical annual real returns (simplified data)
            historicalScenarios: {
                '1929-great-depression': {
                    name: '1929 (Great Depression)',
                    description: 'Stock market crash and Great Depression',
                    returns: [-8.4, -24.9, -43.3, -8.2, 54.0, -1.4, 47.7, 33.9, 31.9, 7.5, -35.0, 28.1, 6.4, 31.1, -0.4, 11.9, -3.1, 29.3, -11.6, 0.5]
                },
                '1966-stagflation': {
                    name: '1966 (Stagflation Era)',
                    description: 'High inflation and stagnant growth',
                    returns: [-10.1, 24.0, 11.1, -8.5, 4.0, 14.3, -14.7, -26.5, 37.2, 23.8, -7.2, 6.6, 18.4, -4.9, 12.3, 32.4, 6.3, 18.5, -14.7, -9.7]
                },
                '2000-dotcom': {
                    name: '2000 (Dot-com Crash)',
                    description: 'Tech bubble burst',
                    returns: [-9.1, -11.9, -22.1, 28.7, 10.9, 4.9, 15.8, 5.5, -37.0, 26.5, 15.1, 2.1, 16.0, 13.7, 1.4, -4.4, 21.8, 28.7, 18.4, 21.1]
                },
                '2008-financial-crisis': {
                    name: '2008 (Financial Crisis)',
                    description: 'Global financial meltdown',
                    returns: [-37.0, 26.5, 15.1, 2.1, 16.0, 13.7, 1.4, -4.4, 21.8, 28.7, 18.4, 21.1, 12.0, -4.4, 31.5, 18.4, -8.8, 31.3, 28.7, 16.3]
                },
                '2020-covid': {
                    name: '2020 (COVID)',
                    description: 'Pandemic-induced volatility',
                    returns: [18.4, -18.0, 28.7, 21.1, 26.9, 16.3, 11.9, 7.5, 10.1, 12.4, 15.3, 18.2, 9.7, 14.5, 19.2, 22.1, 13.4, 16.8, 20.5, 15.9]
                }
            },

            /**
             * Runs a single simulation with fixed historical returns (not random).
             * Used to test how a strategy would have performed in a specific period.
             */
            runHistoricalSimulation(inputs, strategyName, historicalReturns) {
                const years = Math.min(inputs.planningAge - inputs.retirementAge, historicalReturns.length);
                const inflationMultiplier = 1 + inputs.inflationRate / 100;
                const baseMinSpending = inputs.minSpending || 0;

                let portfolio = inputs.startingPortfolio;
                let withdrawal;

                // Initialize withdrawal based on strategy
                if (strategyName === 'constant-real') {
                    const initialRate = 4;
                    const calculated = inputs.startingPortfolio * (initialRate / 100);
                    withdrawal = Math.max(calculated, baseMinSpending);
                } else if (strategyName === 'guardrails') {
                    const initialRate = 5.0;
                    const calculated = inputs.startingPortfolio * (initialRate / 100);
                    withdrawal = Math.max(calculated, baseMinSpending);
                }

                for (let i = 0; i < years; i++) {
                    const age = inputs.retirementAge + i;
                    const inflationAdjustedMinSpending = baseMinSpending * Math.pow(inflationMultiplier, i);

                    // One-time expense every 5 years (inflation-adjusted)
                    const isExpenseYear = ((i + 1) % 5 === 0);
                    const oneTimeExpenseThisYear = isExpenseYear ? (inputs.oneTimeExpense || 0) * Math.pow(inflationMultiplier, i) : 0;

                    // Social Security with COLA
                    const ssYearsReceiving = Math.max(0, age - inputs.ssStartAge);
                    const ss = (age >= inputs.ssStartAge) ? inputs.socialSecurity * Math.pow(inflationMultiplier, ssYearsReceiving) : 0;

                    let targetWithdrawal;
                    if (strategyName === 'constant-real') {
                        targetWithdrawal = withdrawal;
                    } else if (strategyName === 'constant-pct') {
                        const pctWithdrawal = portfolio * 0.04;
                        targetWithdrawal = Math.max(pctWithdrawal, inflationAdjustedMinSpending);
                    } else if (strategyName === 'vpw') {
                        const yearsRemaining = inputs.planningAge - age;
                        const vpwPct = Simulation.vpwPercentage(yearsRemaining, 60);
                        const vpwWithdrawal = portfolio * (vpwPct / 100);
                        targetWithdrawal = Math.max(vpwWithdrawal, inflationAdjustedMinSpending);
                    } else if (strategyName === 'guardrails') {
                        targetWithdrawal = Math.max(withdrawal, inflationAdjustedMinSpending);
                    } else if (strategyName === 'rmd') {
                        const lifeExp = Simulation.lifeExpectancy(age);
                        const rmdWithdrawal = portfolio / lifeExp;
                        targetWithdrawal = Math.max(rmdWithdrawal, inflationAdjustedMinSpending);
                    }

                    const netWithdrawal = Math.max(0, targetWithdrawal - ss) + oneTimeExpenseThisYear;
                    portfolio -= netWithdrawal;

                    if (portfolio <= 0) {
                        return { survived: false, finalBalance: 0, yearsLasted: i };
                    }

                    // Apply historical return for this year
                    const returnPct = historicalReturns[i] / 100;
                    portfolio *= (1 + returnPct);

                    // Inflate withdrawal for next year (constant-real and guardrails)
                    if (strategyName === 'constant-real' || strategyName === 'guardrails') {
                        withdrawal *= inflationMultiplier;
                    }
                }

                return { survived: true, finalBalance: portfolio, yearsLasted: years };
            },

            generateReport(results, inputs) {
                let html = '<div class="space-y-6">';
                html += '<h3 class="text-xl font-semibold text-apple-text mb-4">Historical Backtesting</h3>';
                html += '<p class="text-apple-textSecondary mb-6">How would your strategies have performed if you retired during major historical market events? (Based on actual historical returns)</p>';

                Object.entries(this.historicalScenarios).forEach(([key, scenario]) => {
                    html += `<div class="bg-apple-surface rounded-xl border border-apple-border p-6">`;
                    html += `<h4 class="text-lg font-semibold text-apple-text mb-2">${scenario.name}</h4>`;
                    html += `<p class="text-sm text-apple-textTertiary mb-4">${scenario.description}</p>`;

                    html += '<div class="grid grid-cols-2 md:grid-cols-3 gap-3 mt-4">';

                    Object.values(results).forEach(strategyResult => {
                        // Actually run the simulation with historical returns
                        const historicalResult = this.runHistoricalSimulation(inputs, strategyResult.name, scenario.returns);
                        const survived = historicalResult.survived;
                        const finalBalance = historicalResult.finalBalance;

                        html += `<div class="p-3 rounded-xl ${survived ? 'bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800' : 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800'}">`;
                        html += `<div class="text-xs font-medium text-apple-textSecondary mb-1">${Report.strategyDisplayName(strategyResult.name)}</div>`;
                        html += `<div class="text-lg font-bold ${survived ? 'text-green-700 dark:text-green-300' : 'text-red-700 dark:text-red-300'}">${survived ? ' Survived' : ' Depleted'}</div>`;
                        if (survived) {
                            html += `<div class="text-xs text-apple-textTertiary mt-1">Final: ${Charts.formatCurrency(finalBalance, true)}</div>`;
                        } else {
                            html += `<div class="text-xs text-apple-textTertiary mt-1">Lasted ${historicalResult.yearsLasted} years</div>`;
                        }
                        html += '</div>';
                    });

                    html += '</div></div>';
                });

                html += '</div>';
                return html;
            }
        };

        // ============================================
        // NEW UX INTERACTION HANDLERS
        // ============================================

        // Investment Preset Handler
        function initInvestmentPresets() {
            const presets = document.querySelectorAll('.investment-preset');
            const returnInput = document.getElementById('expected-return');
            const volatilityInput = document.getElementById('volatility');
            const returnDisplay = document.getElementById('expected-return-display');
            const volatilityDisplay = document.getElementById('volatility-display');

            presets.forEach(preset => {
                preset.addEventListener('click', () => {
                    // Remove selected class from all presets
                    presets.forEach(p => p.classList.remove('selected', 'ring-2', 'ring-apple-blue', 'bg-apple-elevated'));
                    presets.forEach(p => p.classList.add('bg-apple-surface'));

                    // Add selected class to clicked preset
                    preset.classList.add('selected', 'ring-2', 'ring-apple-blue', 'bg-apple-elevated');
                    preset.classList.remove('bg-apple-surface');

                    // Update hidden inputs and display inputs
                    const returnVal = preset.dataset.return;
                    const volVal = preset.dataset.volatility;

                    if (returnInput) returnInput.value = returnVal;
                    if (volatilityInput) volatilityInput.value = volVal;
                    if (returnDisplay) returnDisplay.value = returnVal;
                    if (volatilityDisplay) volatilityDisplay.value = volVal;
                });
            });
        }

        // Advanced Options Toggle
        function initAdvancedToggle() {
            const toggle = document.getElementById('toggle-advanced');
            const advancedSection = document.getElementById('advanced-options');

            if (toggle && advancedSection) {
                toggle.addEventListener('click', () => {
                    const isHidden = advancedSection.classList.contains('hidden');

                    if (isHidden) {
                        advancedSection.classList.remove('hidden');
                        toggle.querySelector('#advanced-chevron')?.classList.add('rotate-180');
                        toggle.querySelector('span')?.textContent && (toggle.querySelector('span').textContent = 'Hide Advanced Options');
                    } else {
                        advancedSection.classList.add('hidden');
                        toggle.querySelector('#advanced-chevron')?.classList.remove('rotate-180');
                        toggle.querySelector('span')?.textContent && (toggle.querySelector('span').textContent = 'Advanced Options');
                    }
                });
            }
        }

        // Sync display inputs with hidden inputs
        function initInputSync() {
            const syncPairs = [
                ['expected-return-display', 'expected-return'],
                ['volatility-display', 'volatility'],
                ['inflation-rate-display', 'inflation-rate'],
                ['monte-carlo-runs-display', 'monte-carlo-runs'],
                ['return-distribution-display', 'return-distribution']
            ];

            syncPairs.forEach(([displayId, hiddenId]) => {
                const display = document.getElementById(displayId);
                const hidden = document.getElementById(hiddenId);

                if (display && hidden) {
                    // Initialize display from hidden
                    display.value = hidden.value;

                    // Sync changes back to hidden
                    display.addEventListener('input', () => {
                        hidden.value = display.value;
                    });
                    display.addEventListener('change', () => {
                        hidden.value = display.value;
                    });
                }
            });
        }

        // Initialize help tooltips with custom styled tooltip
        function initTooltips() {
            document.querySelectorAll('.help-trigger[data-tooltip]').forEach(trigger => {
                const tooltipText = trigger.dataset.tooltip;
                // Don't set title attribute - it causes double tooltip with our custom one

                // Create simple tooltip on hover
                trigger.addEventListener('mouseenter', function(e) {
                    const tooltip = document.createElement('div');
                    tooltip.className = 'help-tooltip';
                    tooltip.innerHTML = tooltipText;
                    tooltip.style.cssText = `
                        position: fixed;
                        background: #3a3a3c;
                        color: #f5f5f7;
                        padding: 10px 14px;
                        font-size: 13px;
                        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
                        max-width: 280px;
                        z-index: 9999;
                        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
                        border-radius: 10px;
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        pointer-events: none;
                    `;
                    document.body.appendChild(tooltip);

                    const rect = trigger.getBoundingClientRect();
                    tooltip.style.left = Math.min(rect.left, window.innerWidth - tooltip.offsetWidth - 10) + 'px';
                    tooltip.style.top = (rect.bottom + 8) + 'px';

                    trigger._tooltip = tooltip;
                });

                trigger.addEventListener('mouseleave', function() {
                    if (trigger._tooltip) {
                        trigger._tooltip.remove();
                        trigger._tooltip = null;
                    }
                });
            });
        }

        // Update withdrawal rate hint based on portfolio and spending
        function initWithdrawalHint() {
            const portfolioInput = document.getElementById('starting-portfolio');
            const spendingInput = document.getElementById('starting-withdrawal');
            const hint = document.getElementById('withdrawal-rate-hint');

            function updateHint() {
                if (!portfolioInput || !spendingInput || !hint) return;

                const portfolio = parseFloat(portfolioInput.value.replace(/,/g, '')) || 0;
                const spending = parseFloat(spendingInput.value.replace(/,/g, '')) || 0;

                if (portfolio > 0 && spending > 0) {
                    const rate = ((spending / portfolio) * 100).toFixed(1);
                    hint.textContent = `That's a ${rate}% withdrawal rate`;
                    hint.classList.remove('hidden');
                } else {
                    hint.classList.add('hidden');
                }
            }

            if (portfolioInput) portfolioInput.addEventListener('input', updateHint);
            if (spendingInput) spendingInput.addEventListener('input', updateHint);
            updateHint();
        }

        // ============================================
        // RIPPLE EFFECT FOR BUTTONS
        // ============================================
        function initRippleEffect() {
            document.querySelectorAll('.btn-apple').forEach(button => {
                button.addEventListener('click', function(e) {
                    const rect = this.getBoundingClientRect();
                    const ripple = document.createElement('span');
                    ripple.className = 'ripple';
                    ripple.style.left = (e.clientX - rect.left) + 'px';
                    ripple.style.top = (e.clientY - rect.top) + 'px';
                    this.appendChild(ripple);
                    setTimeout(() => ripple.remove(), 600);
                });
            });
        }

        // ============================================
        // INPUT VALUE CHANGE ANIMATION
        // ============================================
        function initInputAnimations() {
            document.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => {
                let previousValue = input.value;
                input.addEventListener('change', function() {
                    if (this.value !== previousValue) {
                        this.classList.add('value-changed');
                        setTimeout(() => this.classList.remove('value-changed'), 300);
                        previousValue = this.value;
                    }
                });
            });
        }

        // ============================================
        // APPLICATION INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize new UX handlers
            initInvestmentPresets();
            initAdvancedToggle();
            initInputSync();
            initTooltips();
            initWithdrawalHint();

            // Initialize animations
            initRippleEffect();
            initInputAnimations();

            UI.init();
        });
    </script>
</body>
</html>

